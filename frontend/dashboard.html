<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hockey Management - Dashboard de Entrenador</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
        }
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .header h1 {
            color: #1e3c72;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .btn-logout {
            background: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
        }
        .btn-logout:hover {
            background: #c82333;
        }
        .main-nav {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .nav-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .nav-tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
        }
        .nav-tab.active {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
        }
        .nav-tab:hover:not(.active) {
            background: #e9ecef;
        }
        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            min-height: 500px;
        }
        .tab-content.active {
            display: block;
        }
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .welcome-section {
            text-align: center;
            padding: 40px 20px;
        }
        .welcome-section h2 {
            color: #1e3c72;
            margin-bottom: 20px;
            font-size: 2em;
        }
        .welcome-section p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .feature-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border-left: 5px solid #1e3c72;
        }
        .feature-card h3 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .feature-card p {
            color: #666;
            line-height: 1.5;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-primary {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 60, 114, 0.3);
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .coming-soon {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .coming-soon h3 {
            color: #1e3c72;
            margin-bottom: 15px;
        }
        .coming-soon .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .team-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        .team-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: #1e3c72;
        }
        .team-card h3 {
            color: #1e3c72;
            margin-bottom: 10px;
            font-size: 1.3em;
        }
        .team-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .team-badge {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .team-badge.division {
            background: #d4edda;
            color: #155724;
        }
        .team-badge.category {
            background: #cce5ff;
            color: #004085;
        }
        .team-actions {
            display: flex;
            gap: 8px;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .player-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }
        .player-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: #28a745;
        }
        .player-header {
            margin-bottom: 15px;
        }
        .player-header h4 {
            color: #1e3c72;
            margin: 0 0 5px 0;
            font-size: 1.2em;
        }
        .player-nickname {
            color: #666;
            font-style: italic;
            font-size: 0.9em;
        }
        .player-info {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .jersey-number {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 50%;
            font-weight: bold;
            min-width: 32px;
            text-align: center;
            font-size: 0.9em;
        }
        .player-position {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .starter-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffc107;
            color: #212529;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
        }
        .player-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
    </style>
    
    <!-- SheetJS para leer archivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>üèí Hockey Management - Dashboard</h1>
            <div class="user-info">
                <span id="user-name">Cargando...</span>
                <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <!-- Main Navigation -->
        <div class="main-nav">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('overview')">üìä Resumen</button>
                <button class="nav-tab" onclick="showTab('teams')">üë• Mis Equipos</button>
                <button class="nav-tab" onclick="showTab('players')">üèÉ‚Äç‚ôÄÔ∏è Jugadores</button>
                <button class="nav-tab" onclick="showTab('attendance')">üìã Asistencias</button>
                <button class="nav-tab" onclick="showTab('formations')">üèë Formaciones</button>
                <button class="nav-tab" onclick="showTab('matches')">‚öΩ Partidos</button>
                <button class="nav-tab" onclick="showTab('reports')">üìà Reportes</button>
            </div>
        </div>

        <div id="message" class="message"></div>

        <!-- Tab: Resumen -->
        <div id="overview-tab" class="tab-content active">
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-teams">0</div>
                    <div class="stat-label">Equipos Activos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-players">0</div>
                    <div class="stat-label">Jugadoras Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="upcoming-matches">0</div>
                    <div class="stat-label">Pr√≥ximos Partidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="formations-created">0</div>
                    <div class="stat-label">Formaciones Creadas</div>
                </div>
            </div>

            <div class="welcome-section">
                <h2>¬°Bienvenido al Sistema de Gesti√≥n de Hockey!</h2>
                <p>
                    Desde aqu√≠ puedes gestionar todos tus equipos, registrar asistencias a entrenamientos, 
                    crear formaciones t√°cticas visuales y llevar el control completo de tus partidos con 
                    capacidades offline durante los juegos.
                </p>

                <div class="feature-grid">
                    <div class="feature-card">
                        <h3>üìã Registro de Asistencias</h3>
                        <p>
                            Lleva un control detallado de la asistencia de tus jugadoras a los entrenamientos. 
                            Marca presente, tarde o ausente con observaciones adicionales.
                        </p>
                    </div>
                    <div class="feature-card">
                        <h3>üèë Formaciones Visuales</h3>
                        <p>
                            Crea formaciones t√°cticas arrastrando jugadoras a posiciones en la cancha. 
                            Exporta como imagen para compartir con tu equipo.
                        </p>
                    </div>
                    <div class="feature-card">
                        <h3>‚öΩ Gesti√≥n de Partidos</h3>
                        <p>
                            Registra acciones en tiempo real durante los partidos con capacidad offline. 
                            Control de tiempos y cambios de jugadoras autom√°tico.
                        </p>
                    </div>
                    <div class="feature-card">
                        <h3>üìà Reportes Detallados</h3>
                        <p>
                            Genera mapas de calor t√°cticos, estad√≠sticas de rendimiento y reportes 
                            completos para an√°lisis estrat√©gico del equipo.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Mis Equipos -->
        <div id="teams-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">üë• Gesti√≥n de Equipos</h2>
            
            <!-- Header con bot√≥n crear equipo -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <p>Gestiona tus equipos y jugadoras. M√°ximo permitido: <strong id="max-teams-display">-</strong> equipos</p>
                </div>
                <button class="btn btn-primary" onclick="showCreateTeamModal()">
                    ‚ûï Crear Nuevo Equipo
                </button>
            </div>

            <!-- Lista de equipos -->
            <div id="teams-list" class="loading">
                Cargando equipos...
            </div>

            <!-- Modal crear/editar equipo -->
            <div id="team-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                    <h3 id="modal-title">Crear Nuevo Equipo</h3>
                    <form id="team-form" style="margin-top: 20px;">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Nombre del Equipo *</label>
                            <input type="text" id="team-name" name="name" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Nombre del Club *</label>
                            <input type="text" id="club-name" name="club_name" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>G√©nero del Equipo *</label>
                            <select id="team-gender" name="gender" required onchange="loadDivisionsForGender(this.value)" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px;">
                                <option value="">Seleccionar g√©nero...</option>
                                <option value="female">Femenino</option>
                                <option value="male">Masculino</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Divisi√≥n</label>
                            <select id="team-division" name="division_id" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px;">
                                <option value="">Primero selecciona el g√©nero...</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label>M√°ximo de Jugadores</label>
                            <input type="number" id="max-players" name="max_players" min="10" max="50" value="25" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px;">
                            <small style="color: #666; font-size: 0.9em;">N√∫mero m√°ximo de jugadores permitidos en el equipo (por defecto: 25)</small>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" onclick="closeTeamModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Cancelar
                            </button>
                            <button type="submit" style="padding: 10px 20px; background: #1e3c72; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Guardar Equipo
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tab: Jugadores -->
        <div id="players-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="current-team-name">Selecciona un equipo primero</h2>
                <div id="add-player-btn" style="display: none;">
                    <button class="btn btn-primary" onclick="showCreatePlayerModal()" style="margin-right: 10px;">
                        ‚ûï Agregar Jugador
                    </button>
                    <button class="btn btn-success" onclick="showExcelImportModal()">
                        üìä Importar Excel
                    </button>
                </div>
            </div>
            
            <div id="players-list">
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3em; margin-bottom: 20px;">üèÉ‚Äç‚ôÄÔ∏è</div>
                    <h3>Gesti√≥n de Jugadores</h3>
                    <p>Ve a "Mis Equipos" y haz clic en "üë• Jugadoras" de cualquier equipo para ver y gestionar sus jugadores</p>
                </div>
            </div>

            <!-- Modal para agregar jugador -->
            <div id="player-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                    <h3 id="player-modal-title">Agregar Jugador</h3>
                    <form id="player-form" style="margin-top: 20px;">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Nombre Completo *</label>
                            <input type="text" id="player-name" name="name" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Apodo/Nickname</label>
                            <input type="text" id="player-nickname" name="nickname" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Fecha de Nacimiento *</label>
                            <input type="date" id="player-birth-date" name="birth_date" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Posici√≥n</label>
                            <select id="player-position" name="position" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px;">
                                <option value="">Seleccionar posici√≥n...</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>N√∫mero de Camiseta</label>
                            <input type="number" id="player-jersey" name="jersey_number" min="1" max="99" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px;">
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" onclick="closePlayerModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Cancelar
                            </button>
                            <button type="submit" style="padding: 10px 20px; background: #1e3c72; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Guardar Jugador
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para importar Excel -->
        <div id="excel-import-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 600px; width: 90%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3>üìä Importar Jugadores desde Excel</h3>
                    <button onclick="closeExcelImportModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4>üìã Formato requerido del archivo Excel:</h4>
                    <p>Tu archivo Excel debe tener exactamente estas columnas en la primera fila:</p>
                    <div style="background: white; padding: 15px; border-radius: 4px; margin: 10px 0;">
                        <strong>Columnas obligatorias:</strong><br>
                        <code>Nombre | Apodo | Fecha de Nacimiento | Posici√≥n | N√∫mero de Camiseta</code>
                    </div>
                    <p><strong>Ejemplo de datos:</strong></p>
                    <div style="background: white; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                        Mar√≠a Garc√≠a | Marita | 15/03/1995 | Portera | 1<br>
                        Ana L√≥pez | Ana | 22/07/1998 | Defensora | 2<br>
                        Sofia Rodr√≠guez | | 10/11/1996 | Mediocampista | 10
                    </div>
                    <p style="margin-top: 10px; font-size: 14px; color: #666;">
                        ‚Ä¢ <strong>Fecha de Nacimiento:</strong> Formato DD/MM/YYYY (ejemplo: 15/03/1995)<br>
                        ‚Ä¢ <strong>Apodo:</strong> Puede estar vac√≠o<br>
                        ‚Ä¢ <strong>Posiciones v√°lidas:</strong> Para equipos femeninos: Portera, Arquera, Defensora, Mediocampista, Delantera
                    </p>
                </div>
                
                <form id="excel-import-form" style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Seleccionar archivo Excel:</label>
                        <input type="file" id="excel-file" accept=".xlsx,.xls" required 
                               style="width: 100%; padding: 10px; border: 2px dashed #ddd; border-radius: 8px; cursor: pointer;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeExcelImportModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Cancelar
                        </button>
                        <button type="submit" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            üìä Importar Jugadores
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal: Crear Lista de Asistencia -->
        <div id="attendance-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="background: white; width: 90%; max-width: 600px; margin: 5% auto; padding: 0; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
                <div style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                    <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                        üìã Nueva Lista de Asistencia
                    </h2>
                </div>
                <form id="attendance-form" style="padding: 25px;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Fecha de la Actividad:</label>
                        <input type="date" id="attendance-date" required 
                               style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Tipo de Actividad:</label>
                        <select id="attendance-type" required 
                                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px;">
                            <option value="">Seleccionar tipo...</option>
                            <option value="training">üèãÔ∏è Entrenamiento</option>
                            <option value="match">‚öΩ Partido</option>
                            <option value="meeting">üë• Reuni√≥n</option>
                            <option value="other">üìù Otro</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Descripci√≥n (opcional):</label>
                        <textarea id="attendance-description" rows="3" placeholder="Ej: Entrenamiento de preparaci√≥n f√≠sica..."
                                  style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                        <button type="button" onclick="closeAttendanceModal()" 
                                style="padding: 12px 24px; background: #f5f5f5; color: #333; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: all 0.3s;">
                            ‚ùå Cancelar
                        </button>
                        <button type="submit" 
                                style="padding: 12px 24px; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: all 0.3s;">
                            ‚úÖ Crear Lista
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab: Asistencias -->
        <div id="attendance-tab" class="tab-content">
            <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
                <div style="display: flex; justify-content: between-center; align-items: center; margin-bottom: 20px;">
                    <h2>üìã Gesti√≥n de Asistencias</h2>
                    <button class="btn btn-primary" onclick="showCreateAttendanceModal()" style="margin-left: auto;">
                        ‚ûï Nueva Lista de Asistencia
                    </button>
                </div>
                
                <!-- Selector de equipo para asistencias -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h3>Seleccionar Equipo</h3>
                    <select id="attendance-team-select" onchange="loadAttendanceForTeam()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Selecciona un equipo...</option>
                    </select>
                </div>
                
                <!-- Lista de asistencias -->
                <div id="attendance-list" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üìã</div>
                        <h3>Selecciona un equipo para ver las asistencias</h3>
                        <p>Podr√°s registrar y gestionar las asistencias de entrenamientos y partidos</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Formaciones -->
        <div id="formations-tab" class="tab-content">
            <div class="coming-soon">
                <div class="icon">üèë</div>
                <h3>M√≥dulo de Formaciones</h3>
                <p><strong>PR√ìXIMO A IMPLEMENTAR</strong></p>
                <p>Este m√≥dulo permitir√°:</p>
                <ul style="text-align: left; max-width: 400px; margin: 20px auto;">
                    <li>üéØ Planificaci√≥n visual drag & drop en cancha</li>
                    <li>üì∑ Fotos de jugadoras en posiciones</li>
                    <li>üìù Datos del partido (rival, cancha, fecha)</li>
                    <li>üì§ Exportaci√≥n como imagen para compartir</li>
                    <li>üíæ Guardar formaciones como plantillas</li>
                </ul>
            </div>
        </div>

        <!-- Tab: Partidos -->
        <div id="matches-tab" class="tab-content">
            <div class="coming-soon">
                <div class="icon">‚öΩ</div>
                <h3>Gesti√≥n de Partidos</h3>
                <p>Funcionalidades avanzadas de registro de partidos en desarrollo.</p>
                <p>Incluir√° capacidades offline, control de tiempos y registro de acciones en tiempo real.</p>
            </div>
        </div>

        <!-- Tab: Reportes -->
        <div id="reports-tab" class="tab-content">
            <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
                <h2>üìà Reportes y Estad√≠sticas</h2>
                
                <!-- Selector de equipo para reportes -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h3>Seleccionar Equipo</h3>
                    <select id="reports-team-select" onchange="loadReportsForTeam()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Selecciona un equipo...</option>
                    </select>
                </div>
                
                <!-- Contenedor de reportes -->
                <div id="reports-content" style="display: grid; gap: 20px;">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üìä</div>
                        <h3>Selecciona un equipo para ver los reportes</h3>
                        <p>Podr√°s ver estad√≠sticas de asistencia, rendimiento y generar reportes exportables</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üîë BYPASS TOKEN CONFIGURATION
        const VERCEL_BYPASS_TOKEN = 'fc85dada1b5dc5394adba665f545be20';
        
        // Helper para crear URLs con bypass token
        function getApiUrl(endpoint) {
            const timestamp = Date.now();
            const separator = endpoint.includes('?') ? '&' : '?';
            return `${endpoint}${separator}x-vercel-set-bypass-cookie=true&x-vercel-protection-bypass=${VERCEL_BYPASS_TOKEN}&_t=${timestamp}`;
        }
        
        // Get JWT token from localStorage
        function getAuthHeaders() {
            const token = localStorage.getItem('hockey_token');
            console.log('Token from localStorage:', token ? 'Existe' : 'No existe');
            if (!token) {
                console.log('No token found, redirecting to login');
                window.location.href = 'login.html';
                return {};
            }
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }
        
        // Handle authentication errors
        function handleAuthError(error, response = null) {
            if (response && response.status === 401) {
                console.log('Token expired or invalid, redirecting to login');
                localStorage.removeItem('hockey_token');
                localStorage.removeItem('hockey_user');
                window.location.href = 'login.html';
                return;
            }
            console.error('Auth error:', error);
        }
        
        // Check if user is coach on page load
        async function checkCoachAccess() {
            const token = localStorage.getItem('hockey_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const response = await fetch(getApiUrl('/api/profile'), {
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Token inv√°lido');
                }
                
                if (data.data.role === 'admin') {
                    // Redirigir admin al panel de admin
                    window.location.href = 'admin.html';
                    return;
                }
                
                if (data.data.role !== 'coach') {
                    alert('Acceso denegado. Solo entrenadores.');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Mostrar informaci√≥n del usuario
                document.getElementById('user-name').textContent = 
                    `${data.data.firstName} ${data.data.lastName} (Entrenador)`;
                
                // Cargar estad√≠sticas b√°sicas
                loadDashboardStats();
                
            } catch (error) {
                console.error('Error checking coach access:', error);
                localStorage.removeItem('hockey_token');
                localStorage.removeItem('hockey_user');
                window.location.href = 'login.html';
            }
        }
        
        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                // Cargar informaci√≥n del usuario para obtener max_teams
                const userResponse = await fetch(getApiUrl('/api/profile'), {
                    headers: getAuthHeaders()
                });
                const userData = await userResponse.json();
                
                if (userData.success) {
                    document.getElementById('max-teams-display').textContent = userData.data.maxTeams || 2;
                }

                // Cargar equipos del entrenador
                const teamsResponse = await fetch(getApiUrl('/api/teams'), {
                    headers: getAuthHeaders()
                });
                const teamsData = await teamsResponse.json();
                
                if (teamsData.success) {
                    document.getElementById('total-teams').textContent = teamsData.teams.length;
                    
                    // Calcular total de jugadoras (cuando tengamos los datos)
                    let totalPlayers = 0;
                    // TODO: Sumar jugadoras de todos los equipos
                    document.getElementById('total-players').textContent = totalPlayers;
                }
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                // Valores por defecto en caso de error
                document.getElementById('total-teams').textContent = '0';
                document.getElementById('total-players').textContent = '0';
            }
            
            // Por ahora, valores mock para las otras estad√≠sticas
            document.getElementById('upcoming-matches').textContent = '0';
            document.getElementById('formations-created').textContent = '0';
        }
        
        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load tab-specific content
            switch(tabName) {
                case 'teams':
                    loadTeams();
                    break;
                case 'attendance':
                    loadAttendance();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'formations':
                    // TODO: loadFormations();
                    break;
                case 'matches':
                    // TODO: loadMatches();
                    break;
                case 'reports':
                    // TODO: loadReports();
                    break;
            }
        }
        
        // Logout functionality
        function logout() {
            localStorage.removeItem('hockey_token');
            localStorage.removeItem('hockey_user');
            window.location.href = 'login.html';
        }
        
        // Show message
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = `message ${type}`;
            msgDiv.style.display = 'block';
            
            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 5000);
        }

        // =================== TEAMS MANAGEMENT ===================
        
        // Load teams for the coach
        async function loadTeams() {
            const container = document.getElementById('teams-list');
            container.innerHTML = '<div class="loading">Cargando equipos...</div>';
            
            try {
                const response = await fetch(getApiUrl('/api/teams'), {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    const teamsGridHtml = await generateTeamsGrid(data.teams);
                    container.innerHTML = teamsGridHtml;
                } else {
                    container.innerHTML = `<div class="message error">Error: ${data.message || data.error}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="message error">Error de conexi√≥n: ${error.message}</div>`;
            }
        }

        // Generate teams grid HTML
        async function generateTeamsGrid(teams) {
            if (teams.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üèí</div>
                        <h3>No tienes equipos creados</h3>
                        <p>Crea tu primer equipo para comenzar a gestionar jugadoras</p>
                        <button class="btn btn-primary" onclick="showCreateTeamModal()" style="margin-top: 20px;">
                            ‚ûï Crear Mi Primer Equipo
                        </button>
                    </div>
                `;
            }

            let html = '<div class="teams-grid">';
            
            for (const team of teams) {
                // Obtener el conteo de jugadores para cada equipo
                const playerCount = await getPlayerCountForTeam(team.id);
                const genderText = team.team_gender === 'female' ? 'jugadoras' : 'jugadores';
                
                html += `
                    <div class="team-card">
                        <h3>${team.name}</h3>
                        <div class="team-info">
                            <span class="team-badge division">${team.club_name || 'Sin club'}</span>
                            ${team.max_players ? `<span class="team-badge category">Max: ${team.max_players} ${genderText}</span>` : ''}
                        </div>
                        <div class="team-actions">
                            <button class="btn btn-sm btn-info" onclick="viewTeamPlayers('${team.id}', '${team.name}', '${team.team_gender || 'male'}')" title="Ver ${genderText}">
                                üë• ${team.team_gender === 'female' ? 'Jugadoras' : 'Jugadores'} (${playerCount})
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="editTeam('${team.id}')" title="Editar equipo">
                                ‚úèÔ∏è Editar
                            </button>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        // Get player count for a specific team
        async function getPlayerCountForTeam(teamId) {
            try {
                const response = await fetch(getApiUrl(`/api/players?team_id=${teamId}`), {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    return data.players.length;
                } else {
                    return 0;
                }
            } catch (error) {
                console.error('Error getting player count:', error);
                return 0;
            }
        }

        // Show create team modal
        async function showCreateTeamModal() {
            document.getElementById('modal-title').textContent = 'Crear Nuevo Equipo';
            document.getElementById('team-form').reset();
            
            // Resetear el select de divisiones
            const divisionSelect = document.getElementById('team-division');
            divisionSelect.innerHTML = '<option value="">Primero selecciona el g√©nero...</option>';
            
            document.getElementById('team-modal').style.display = 'block';
        }

        // Load available divisions
        async function loadDivisions() {
            const divisionSelect = document.getElementById('team-division');
            
            // Mostrar loading
            divisionSelect.innerHTML = '<option value="">Cargando divisiones...</option>';
            
            try {
                const response = await fetch(getApiUrl('/api/divisions'), {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    // Limpiar select
                    divisionSelect.innerHTML = '<option value="">Seleccionar divisi√≥n (opcional)...</option>';
                    
                    // Agregar divisiones
                    data.divisions.forEach(division => {
                        const option = document.createElement('option');
                        option.value = division.id;
                        option.textContent = division.name;
                        divisionSelect.appendChild(option);
                    });
                } else {
                    divisionSelect.innerHTML = '<option value="">Error cargando divisiones</option>';
                    console.error('Error loading divisions:', data.message);
                }
            } catch (error) {
                divisionSelect.innerHTML = '<option value="">Error de conexi√≥n</option>';
                console.error('Error fetching divisions:', error);
            }
        }

        // Load divisions filtered by gender
        async function loadDivisionsForGender(gender) {
            const divisionSelect = document.getElementById('team-division');
            
            if (!gender) {
                divisionSelect.innerHTML = '<option value="">Primero selecciona el g√©nero...</option>';
                return;
            }
            
            // Mostrar loading
            divisionSelect.innerHTML = '<option value="">Cargando divisiones...</option>';
            
            try {
                const response = await fetch(getApiUrl(`/api/divisions?gender=${gender}`), {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    // Limpiar select
                    divisionSelect.innerHTML = '<option value="">Seleccionar divisi√≥n (opcional)...</option>';
                    
                    // Agregar divisiones filtradas por g√©nero
                    data.divisions.forEach(division => {
                        const option = document.createElement('option');
                        option.value = division.id;
                        option.textContent = division.name;
                        divisionSelect.appendChild(option);
                    });
                } else {
                    divisionSelect.innerHTML = '<option value="">Error cargando divisiones</option>';
                    console.error('Error loading divisions:', data.message);
                }
            } catch (error) {
                divisionSelect.innerHTML = '<option value="">Error de conexi√≥n</option>';
                console.error('Error fetching divisions:', error);
            }
        }

        // Close team modal
        function closeTeamModal() {
            document.getElementById('team-modal').style.display = 'none';
        }

        // Handle team form submission
        document.addEventListener('DOMContentLoaded', function() {
            const teamForm = document.getElementById('team-form');
            if (teamForm) {
                teamForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    const teamData = Object.fromEntries(formData.entries());
                    
                    try {
                        console.log('Sending team data:', teamData);
                        
                        const response = await fetch(getApiUrl('/api/teams'), {
                            method: 'POST',
                            headers: getAuthHeaders(),
                            body: JSON.stringify(teamData)
                        });
                        
                        console.log('Response status:', response.status);
                        const data = await response.json();
                        console.log('Response data:', data);
                        
                        if (data.success) {
                            showMessage('Equipo creado exitosamente', 'success');
                            closeTeamModal();
                            loadTeams(); // Recargar la lista
                            loadDashboardStats(); // Actualizar estad√≠sticas
                        } else {
                            showMessage(`Error: ${data.message || data.error}`, 'error');
                            
                            // Si es error de token, redirigir al login
                            if (data.message && data.message.includes('Token inv√°lido')) {
                                localStorage.removeItem('hockey_token');
                                localStorage.removeItem('hockey_user');
                                window.location.href = 'login.html';
                            }
                        }
                    } catch (error) {
                        console.error('Error in team creation:', error);
                        showMessage(`Error de conexi√≥n: ${error.message}`, 'error');
                    }
                });
            }

            // Handle player form submission
            const playerForm = document.getElementById('player-form');
            if (playerForm) {
                playerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    if (!window.currentTeamId) {
                        showMessage('Error: No hay equipo seleccionado', 'error');
                        return;
                    }
                    
                    const formData = new FormData(this);
                    const playerData = Object.fromEntries(formData.entries());
                    playerData.teamId = window.currentTeamId;
                    
                    try {
                        let response;
                        let successMessage;
                        
                        if (window.editingPlayerId) {
                            // Update existing player
                            response = await fetch(getApiUrl(`/api/players/${window.editingPlayerId}`), {
                                method: 'PUT',
                                headers: getAuthHeaders(),
                                body: JSON.stringify(playerData)
                            });
                            successMessage = 'Jugador actualizado exitosamente';
                        } else {
                            // Create new player
                            response = await fetch(getApiUrl('/api/players'), {
                                method: 'POST',
                                headers: getAuthHeaders(),
                                body: JSON.stringify(playerData)
                            });
                            successMessage = 'Jugador agregado exitosamente';
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showMessage(successMessage, 'success');
                            closePlayerModal();
                            loadPlayersForTeam(window.currentTeamId, window.currentTeamName, window.currentTeamGender);
                        } else {
                            showMessage(`Error: ${data.message || data.error}`, 'error');
                        }
                    } catch (error) {
                        showMessage(`Error de conexi√≥n: ${error.message}`, 'error');
                    }
                });
            }
        });

        // View team players
        function viewTeamPlayers(teamId, teamName, teamGender) {
            // Cambiar a la pesta√±a de jugadores
            showTab('players');
            
            // Cargar jugadores del equipo
            loadPlayersForTeam(teamId, teamName, teamGender);
        }

        // Load players for specific team
        async function loadPlayersForTeam(teamId, teamName, teamGender = 'male') {
            const container = document.getElementById('players-list');
            const teamTitle = document.getElementById('current-team-name');
            const addPlayerBtnContainer = document.getElementById('add-player-btn');
            
            if (teamTitle) {
                const genderText = teamGender === 'female' ? 'Jugadoras' : 'Jugadores';
                teamTitle.textContent = `${genderText} de: ${teamName}`;
            }
            
            // Mostrar los botones de acci√≥n
            if (addPlayerBtnContainer) {
                addPlayerBtnContainer.style.display = 'block';
            }
            
            // Guardar el teamId actual para crear nuevos jugadores
            window.currentTeamId = teamId;
            window.currentTeamName = teamName;
            window.currentTeamGender = teamGender;
            
            container.innerHTML = '<div class="loading">Cargando jugadores...</div>';
            
            try {
                const response = await fetch(getApiUrl(`/api/players?team_id=${teamId}`), {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError('Token expired', response);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    container.innerHTML = generatePlayersGrid(data.players, teamGender);
                } else {
                    container.innerHTML = `<div class="message error">Error: ${data.message || data.error}</div>`;
                }
            } catch (error) {
                console.error('Error loading players:', error);
                container.innerHTML = `<div class="message error">Error de conexi√≥n: ${error.message}</div>`;
            }
        }

        // Generate players grid HTML
        function generatePlayersGrid(players, teamGender = 'male') {
            const genderText = teamGender === 'female' ? 'jugadoras' : 'jugadores';
            const genderTextSingular = teamGender === 'female' ? 'Jugadora' : 'Jugador';
            
            if (players.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üèÉ‚Äç‚ôÄÔ∏è</div>
                        <h3>No hay ${genderText} en este equipo</h3>
                        <p>Agrega ${genderText} para comenzar a gestionar el equipo</p>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="showCreatePlayerModal()" style="margin-right: 10px;">
                                ‚ûï Agregar Primer ${genderTextSingular}
                            </button>
                            <button class="btn btn-success" onclick="showExcelImportModal()">
                                üìä Importar Excel
                            </button>
                        </div>
                    </div>
                `;
            }

            let html = '<div class="players-grid">';
            
            players.forEach(player => {
                html += `
                    <div class="player-card">
                        <div class="player-header">
                            <h4>${player.name}</h4>
                            ${player.nickname ? `<span class="player-nickname">"${player.nickname}"</span>` : ''}
                        </div>
                        <div class="player-info">
                            ${player.jersey_number ? `<span class="jersey-number">#${player.jersey_number}</span>` : '<span class="jersey-number">Sin #</span>'}
                            <span class="player-position">${player.position || 'Sin posici√≥n'}</span>
                        </div>
                        <div class="player-actions">
                            <button class="btn btn-sm btn-warning" onclick="editPlayer('${player.id}', '${player.name}', '${player.nickname || ''}', '${player.birth_date || ''}', '${player.position || ''}', '${player.jersey_number || ''}')" title="Editar jugador">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="removePlayerFromTeam('${player.id}', '${player.name}')" title="Eliminar del equipo">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Bot√≥n para agregar m√°s jugadores
            html += `
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="showCreatePlayerModal()" style="margin-right: 10px;">
                        ‚ûï Agregar ${genderTextSingular}
                    </button>
                    <button class="btn btn-success" onclick="showExcelImportModal()">
                        üìä Importar Excel
                    </button>
                </div>
            `;
            
            return html;
        }

        // Show create player modal
        function showCreatePlayerModal() {
            console.log('showCreatePlayerModal called');
            console.log('currentTeamId:', window.currentTeamId);
            console.log('currentTeamGender:', window.currentTeamGender);
            
            if (!window.currentTeamId) {
                showMessage('Primero selecciona un equipo desde "Mis Equipos"', 'error');
                return;
            }
            
            // Reset form and set title for creating new player
            document.getElementById('player-modal-title').textContent = `Agregar Jugador a: ${window.currentTeamName}`;
            document.getElementById('player-form').reset();
            
            // Clear edit mode data
            delete window.editingPlayerId;
            
            loadPlayerPositions();
            document.getElementById('player-modal').style.display = 'block';
        }

        // Edit existing player
        function editPlayer(playerId, name, nickname, birthDate, position, jerseyNumber) {
            console.log('editPlayer called with:', { playerId, name, nickname, birthDate, position, jerseyNumber });
            
            if (!window.currentTeamId) {
                showMessage('Error: No hay equipo seleccionado', 'error');
                return;
            }
            
            // Set modal title for editing
            document.getElementById('player-modal-title').textContent = `Editar Jugador: ${name}`;
            
            // Fill form with current player data
            document.getElementById('player-name').value = name;
            document.getElementById('player-nickname').value = nickname === 'null' ? '' : nickname;
            document.getElementById('player-birth-date').value = birthDate === 'null' ? '' : birthDate;
            document.getElementById('player-jersey').value = jerseyNumber === 'null' || jerseyNumber === '' ? '' : jerseyNumber;
            
            // Store the player ID for editing
            window.editingPlayerId = playerId;
            
            // Load positions and set current position
            loadPlayerPositions();
            setTimeout(() => {
                if (position && position !== 'null') {
                    document.getElementById('player-position').value = position;
                }
            }, 100);
            
            document.getElementById('player-modal').style.display = 'block';
        }

        // Load player positions based on team gender
        function loadPlayerPositions() {
            const teamGender = window.currentTeamGender || 'male';
            const femalePositions = ['Portera', 'Arquera', 'Defensora', 'Mediocampista', 'Delantera'];
            const malePositions = ['Portero', 'Arquero', 'Defensor', 'Mediocampista', 'Delantero'];
            
            const positions = teamGender === 'female' ? femalePositions : malePositions;
            console.log('Positions for gender', teamGender, ':', positions);
            
            // Generate position options
            let positionOptions = '<option value="">Seleccionar posici√≥n...</option>';
            positions.forEach(position => {
                positionOptions += `<option value="${position}">${position}</option>`;
            });
            
            // Update position select
            const positionSelect = document.getElementById('player-position');
            if (positionSelect) {
                positionSelect.innerHTML = positionOptions;
            }
        }

        // Close player modal
        function closePlayerModal() {
            document.getElementById('player-modal').style.display = 'none';
        }

        // Show Excel import modal
        function showExcelImportModal() {
            if (!window.currentTeamId) {
                showMessage('Primero selecciona un equipo desde "Mis Equipos"', 'error');
                return;
            }
            
            document.getElementById('excel-import-modal').style.display = 'block';
            document.getElementById('excel-import-form').reset();
        }

        // Close Excel import modal
        function closeExcelImportModal() {
            document.getElementById('excel-import-modal').style.display = 'none';
        }

        // Handle Excel import form submission
        document.getElementById('excel-import-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('excel-file');
            if (!fileInput.files[0]) {
                showMessage('Por favor selecciona un archivo Excel', 'error');
                return;
            }
            
            try {
                showMessage('Procesando archivo Excel...', 'info');
                const players = await processExcelFile(fileInput.files[0]);
                
                if (players.length === 0) {
                    showMessage('No se encontraron jugadores v√°lidos en el archivo', 'error');
                    return;
                }
                
                // Import players
                await importPlayersToTeam(players);
                
            } catch (error) {
                console.error('Error processing Excel file:', error);
                showMessage('Error al procesar el archivo Excel: ' + error.message, 'error');
            }
        });

        // Process Excel file and extract players data
        async function processExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Get first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Convert to JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            reject(new Error('El archivo debe tener al menos una fila de encabezados y una fila de datos'));
                            return;
                        }
                        
                        // Expected headers
                        const expectedHeaders = ['Nombre', 'Apodo', 'Fecha de Nacimiento', 'Posici√≥n', 'N√∫mero de Camiseta'];
                        const actualHeaders = jsonData[0];
                        
                        // Validate headers
                        const missingHeaders = expectedHeaders.filter(header => 
                            !actualHeaders.some(actual => 
                                actual && actual.toString().toLowerCase().trim() === header.toLowerCase()
                            )
                        );
                        
                        if (missingHeaders.length > 0) {
                            reject(new Error(`Faltan las siguientes columnas: ${missingHeaders.join(', ')}`));
                            return;
                        }
                        
                        // Get column indices
                        const getColumnIndex = (headerName) => {
                            return actualHeaders.findIndex(header => 
                                header && header.toString().toLowerCase().trim() === headerName.toLowerCase()
                            );
                        };
                        
                        const nameIndex = getColumnIndex('Nombre');
                        const nicknameIndex = getColumnIndex('Apodo');
                        const birthDateIndex = getColumnIndex('Fecha de Nacimiento');
                        const positionIndex = getColumnIndex('Posici√≥n');
                        const jerseyIndex = getColumnIndex('N√∫mero de Camiseta');
                        
                        // Process data rows
                        const players = [];
                        const teamGender = window.currentTeamGender || 'male';
                        const validPositions = teamGender === 'female' 
                            ? ['Portera', 'Arquera', 'Defensora', 'Mediocampista', 'Delantera']
                            : ['Portero', 'Arquero', 'Defensor', 'Mediocampista', 'Delantero'];
                        
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            
                            // Skip empty rows
                            if (!row || row.length === 0 || !row[nameIndex]) {
                                continue;
                            }
                            
                            const name = row[nameIndex] ? row[nameIndex].toString().trim() : '';
                            const nickname = row[nicknameIndex] ? row[nicknameIndex].toString().trim() : '';
                            const birthDateRaw = row[birthDateIndex] ? row[birthDateIndex].toString().trim() : '';
                            const position = row[positionIndex] ? row[positionIndex].toString().trim() : '';
                            const jerseyNumber = row[jerseyIndex] ? parseInt(row[jerseyIndex]) : null;
                            
                            // Validate required fields
                            if (!name) {
                                console.warn(`Fila ${i + 1}: Nombre requerido, saltando...`);
                                continue;
                            }
                            
                            if (!birthDateRaw) {
                                console.warn(`Fila ${i + 1}: Fecha de nacimiento requerida, saltando...`);
                                continue;
                            }
                            
                            // Parse birth date - support multiple formats
                            let birthDate = null;
                            try {
                                // Try to parse different date formats
                                if (birthDateRaw.includes('/')) {
                                    // DD/MM/YYYY or MM/DD/YYYY format
                                    const parts = birthDateRaw.split('/');
                                    if (parts.length === 3) {
                                        // Assume DD/MM/YYYY format for Spanish locale
                                        const day = parseInt(parts[0]);
                                        const month = parseInt(parts[1]);
                                        const year = parseInt(parts[2]);
                                        birthDate = `${year.toString().padStart(4, '0')}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                                    }
                                } else if (birthDateRaw.includes('-')) {
                                    // YYYY-MM-DD format
                                    birthDate = birthDateRaw;
                                } else {
                                    // Try to parse as Excel serial date
                                    const excelDate = parseInt(birthDateRaw);
                                    if (!isNaN(excelDate) && excelDate > 25000) { // Excel serial dates start around 25567 for 1970
                                        const jsDate = new Date((excelDate - 25569) * 86400 * 1000);
                                        birthDate = jsDate.toISOString().split('T')[0];
                                    }
                                }
                                
                                if (!birthDate) {
                                    throw new Error('Formato de fecha no reconocido');
                                }
                                
                                // Validate date format YYYY-MM-DD
                                if (!/^\d{4}-\d{2}-\d{2}$/.test(birthDate)) {
                                    throw new Error('Formato de fecha inv√°lido');
                                }
                                
                            } catch (error) {
                                console.warn(`Fila ${i + 1}: Error procesando fecha "${birthDateRaw}": ${error.message}, saltando...`);
                                continue;
                            }
                            
                            // Validate position if provided
                            if (position && !validPositions.includes(position)) {
                                console.warn(`Fila ${i + 1}: Posici√≥n "${position}" no v√°lida para equipo ${teamGender}, saltando...`);
                                continue;
                            }
                            
                            players.push({
                                teamId: window.currentTeamId,
                                name,
                                nickname: nickname || null,
                                birth_date: birthDate,
                                position: position || null,
                                jersey_number: jerseyNumber
                            });
                        }
                        
                        resolve(players);
                        
                    } catch (error) {
                        reject(new Error('Error al leer el archivo Excel: ' + error.message));
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Error al leer el archivo'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // Import players to team
        async function importPlayersToTeam(players) {
            try {
                const successfulImports = [];
                const failedImports = [];
                
                for (const player of players) {
                    try {
                        const response = await fetch(getApiUrl('/api/players'), {
                            method: 'POST',
                            headers: getAuthHeaders(),
                            body: JSON.stringify(player)
                        });

                        if (response.status === 401) {
                            handleAuthError('Token expired during import', response);
                            return;
                        }

                        if (response.ok) {
                            const newPlayer = await response.json();
                            successfulImports.push(player.name);
                        } else {
                            const errorData = await response.json();
                            failedImports.push(`${player.name} (${errorData.message})`);
                        }
                    } catch (error) {
                        failedImports.push(`${player.name} (${error.message})`);
                    }
                }
                
                // Show results
                let message = '';
                if (successfulImports.length > 0) {
                    message += `‚úÖ ${successfulImports.length} jugadores importados exitosamente\n`;
                }
                if (failedImports.length > 0) {
                    message += `‚ùå ${failedImports.length} jugadores fallaron:\n${failedImports.join('\n')}`;
                }
                
                showMessage(message, successfulImports.length > 0 ? 'success' : 'error');
                
                // Close modal and refresh team view
                closeExcelImportModal();
                if (successfulImports.length > 0) {
                    await loadPlayersForTeam(window.currentTeamId, window.currentTeamName, window.currentTeamGender);
                }
                
            } catch (error) {
                console.error('Error importing players:', error);
                showMessage('Error al importar jugadores: ' + error.message, 'error');
            }
        }

        // Remove player from team
        async function removePlayerFromTeam(playerId, playerName) {
            if (!confirm(`¬øEst√°s seguro de que deseas eliminar a "${playerName}" del equipo?`)) {
                return;
            }

            try {
                const response = await fetch(getApiUrl(`/api/players/${playerId}?team_id=${window.currentTeamId}`), {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`${playerName} eliminado del equipo exitosamente`, 'success');
                    loadPlayersForTeam(window.currentTeamId, window.currentTeamName); // Recargar lista
                } else {
                    showMessage(`Error: ${data.message || data.error}`, 'error');
                }
            } catch (error) {
                showMessage(`Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        // Edit team (placeholder for now)
        function editTeam(teamId) {
            showMessage('Funcionalidad de edici√≥n pr√≥ximamente disponible', 'success');
            // TODO: Implement team editing
        }
        
        // ==========================================
        // ATTENDANCE FUNCTIONS
        // ==========================================
        
        // Load attendance management
        async function loadAttendance() {
            console.log('Loading attendance management...');
            await loadTeamsForAttendance();
        }
        
        // Load teams for attendance selector
        async function loadTeamsForAttendance() {
            try {
                const response = await fetch(getApiUrl('/api/teams'), {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('attendance-team-select');
                    select.innerHTML = '<option value="">Selecciona un equipo...</option>';
                    
                    data.teams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = team.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading teams for attendance:', error);
            }
        }
        
        // Show create attendance modal
        function showCreateAttendanceModal() {
            const select = document.getElementById('attendance-team-select');
            if (!select.value) {
                showMessage('Por favor selecciona un equipo primero', 'error');
                return;
            }
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendance-date').value = today;
            
            document.getElementById('attendance-modal').style.display = 'block';
        }
        
        // Close attendance modal
        function closeAttendanceModal() {
            document.getElementById('attendance-modal').style.display = 'none';
            document.getElementById('attendance-form').reset();
        }
        
        // Load attendance for selected team
        async function loadAttendanceForTeam() {
            const select = document.getElementById('attendance-team-select');
            const container = document.getElementById('attendance-list');
            
            if (!select.value) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üìã</div>
                        <h3>Selecciona un equipo para ver las asistencias</h3>
                        <p>Podr√°s registrar y gestionar las asistencias de entrenamientos y partidos</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div class="loading">Cargando entrenamientos...</div>';
            
            try {
                const response = await fetch(getApiUrl(`/api/trainings?team_id=${select.value}`), {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError('Token expired', response);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success && data.trainings.length > 0) {
                    container.innerHTML = generateTrainingsGrid(data.trainings);
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 3em; margin-bottom: 20px;">üìã</div>
                            <h3>No hay entrenamientos programados</h3>
                            <p>Crea tu primer entrenamiento para comenzar a registrar la asistencia de las jugadoras</p>
                            <button class="btn btn-primary" onclick="showCreateAttendanceModal()" style="margin-top: 20px;">
                                ‚ûï Crear Primer Entrenamiento
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading trainings:', error);
                container.innerHTML = `<div class="message error">Error cargando entrenamientos: ${error.message}</div>`;
            }
        }
        
        // Generate trainings grid HTML
        function generateTrainingsGrid(trainings) {
            let html = '<div style="display: grid; gap: 15px;">';
            
            trainings.forEach(training => {
                const date = new Date(training.training_date).toLocaleDateString('es-ES');
                const time = training.start_time || '';
                
                html += `
                    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: between-center; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h3 style="margin: 0; color: #2c5aa0;">${training.name}</h3>
                                <p style="margin: 5px 0; color: #666;">üìÖ ${date} ${time ? `‚è∞ ${time}` : ''}</p>
                                ${training.location ? `<p style="margin: 5px 0; color: #666;">üìç ${training.location}</p>` : ''}
                            </div>
                            <button class="btn btn-primary" onclick="showAttendanceForTraining('${training.id}', '${training.name}', '${date}')" 
                                    style="margin-left: auto;">
                                üìù Ver Asistencia
                            </button>
                        </div>
                        ${training.notes ? `<p style="margin: 10px 0; font-style: italic; color: #555;">${training.notes}</p>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        // Show attendance for specific training
        async function showAttendanceForTraining(trainingId, trainingName, trainingDate) {
            const container = document.getElementById('attendance-list');
            container.innerHTML = '<div class="loading">Cargando jugadoras y asistencias...</div>';
            
            try {
                const teamId = document.getElementById('attendance-team-select').value;
                
                // Get team players
                const playersResponse = await fetch(getApiUrl(`/api/players?team_id=${teamId}`), {
                    headers: getAuthHeaders()
                });
                
                if (playersResponse.status === 401) {
                    handleAuthError('Token expired', playersResponse);
                    return;
                }
                
                const playersData = await playersResponse.json();
                
                // Get existing attendance
                const attendanceResponse = await fetch(getApiUrl(`/api/training-attendances?training_session_id=${trainingId}`), {
                    headers: getAuthHeaders()
                });
                
                let attendanceData = { success: true, attendances: [] };
                if (attendanceResponse.ok) {
                    attendanceData = await attendanceResponse.json();
                }
                
                if (playersData.success) {
                    container.innerHTML = generateAttendanceForm(trainingId, trainingName, trainingDate, playersData.players, attendanceData.attendances);
                } else {
                    container.innerHTML = `<div class="message error">Error: ${playersData.message}</div>`;
                }
                
            } catch (error) {
                console.error('Error loading attendance data:', error);
                container.innerHTML = `<div class="message error">Error cargando datos: ${error.message}</div>`;
            }
        }
        
        // Generate attendance form HTML
        function generateAttendanceForm(trainingId, trainingName, trainingDate, players, attendances) {
            // Create attendance map for quick lookup
            const attendanceMap = {};
            attendances.forEach(att => {
                attendanceMap[att.player_id] = att;
            });
            
            let html = `
                <div style="background: white; border-radius: 8px; padding: 20px;">
                    <div style="display: flex; justify-content: between-center; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                        <div>
                            <h2 style="margin: 0; color: #2c5aa0;">üìù ${trainingName}</h2>
                            <p style="margin: 5px 0 0 0; color: #666;">üìÖ ${trainingDate}</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="saveAllAttendance('${trainingId}')" style="margin-left: auto;">
                                ‚úÖ Guardar Asistencias
                            </button>
                            <button class="btn btn-secondary" onclick="loadAttendanceForTeam()">
                                ‚Üê Volver a Entrenamientos
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 10px; max-height: 60vh; overflow-y: auto;">
            `;
            
            players.forEach(player => {
                const attendance = attendanceMap[player.id];
                const status = attendance ? attendance.status : 'ausente';
                const excuse = attendance ? attendance.excuse_reason || '' : '';
                
                html += `
                    <div style="display: flex; align-items: center; padding: 15px; border: 1px solid #ddd; border-radius: 6px; background: #fafafa;">
                        <div style="flex: 1; font-weight: bold; color: #333;">
                            ${player.name} ${player.nickname ? `(${player.nickname})` : ''}
                            ${player.jersey_number ? `<span style="color: #666; font-weight: normal;"> - #${player.jersey_number}</span>` : ''}
                        </div>
                        
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="status_${player.id}" value="presente" ${status === 'presente' ? 'checked' : ''}>
                                <span style="color: #4CAF50; font-weight: bold;">‚úÖ Presente</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="status_${player.id}" value="tarde" ${status === 'tarde' ? 'checked' : ''}>
                                <span style="color: #FF9800; font-weight: bold;">‚è∞ Tarde</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="status_${player.id}" value="ausente" ${status === 'ausente' ? 'checked' : ''}>
                                <span style="color: #f44336; font-weight: bold;">‚ùå Ausente</span>
                            </label>
                            
                            <input type="text" id="excuse_${player.id}" value="${excuse}" placeholder="Motivo (opcional)"
                                   style="width: 150px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }
        
        // Save all attendance for training
        async function saveAllAttendance(trainingId) {
            const container = document.getElementById('attendance-list');
            const playerRows = container.querySelectorAll('div[style*="display: flex"][style*="padding: 15px"]');
            const attendances = [];
            
            playerRows.forEach(row => {
                const statusRadios = row.querySelectorAll('input[type="radio"]:checked');
                const excuseInput = row.querySelector('input[type="text"]');
                
                if (statusRadios.length > 0) {
                    const playerId = statusRadios[0].name.split('_')[1];
                    const status = statusRadios[0].value;
                    const excuse = excuseInput ? excuseInput.value.trim() : '';
                    
                    attendances.push({
                        training_session_id: trainingId,
                        player_id: playerId,
                        status: status,
                        excuse_reason: excuse || null
                    });
                }
            });
            
            try {
                let savedCount = 0;
                let failedCount = 0;
                
                for (const attendance of attendances) {
                    try {
                        const response = await fetch(getApiUrl('/api/training-attendances'), {
                            method: 'POST',
                            headers: getAuthHeaders(),
                            body: JSON.stringify(attendance)
                        });
                        
                        if (response.ok) {
                            savedCount++;
                        } else {
                            failedCount++;
                        }
                    } catch (error) {
                        failedCount++;
                        console.error('Error saving attendance:', error);
                    }
                }
                
                if (savedCount > 0 && failedCount === 0) {
                    showMessage(`‚úÖ ${savedCount} asistencias guardadas exitosamente`, 'success');
                } else if (savedCount > 0 && failedCount > 0) {
                    showMessage(`‚ö†Ô∏è ${savedCount} asistencias guardadas, ${failedCount} fallaron`, 'error');
                } else {
                    showMessage('‚ùå Error guardando las asistencias', 'error');
                }
                
                // Refresh the attendance view
                setTimeout(() => {
                    showAttendanceForTraining(trainingId, '', '');
                }, 1000);
                
            } catch (error) {
                console.error('Error saving attendances:', error);
                showMessage('Error guardando asistencias: ' + error.message, 'error');
            }
        }
        
        // Handle attendance form submission
        document.addEventListener('DOMContentLoaded', function() {
            const attendanceForm = document.getElementById('attendance-form');
            if (attendanceForm) {
                attendanceForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const teamSelect = document.getElementById('attendance-team-select');
                    const formData = new FormData(this);
                    
                    const attendanceData = {
                        teamId: teamSelect.value,
                        name: `${document.getElementById('attendance-type').value === 'training' ? 'Entrenamiento' : 
                               document.getElementById('attendance-type').value === 'match' ? 'Partido' : 
                               document.getElementById('attendance-type').value === 'meeting' ? 'Reuni√≥n' : 'Actividad'} - ${document.getElementById('attendance-date').value}`,
                        trainingDate: document.getElementById('attendance-date').value,
                        startTime: '18:00', // Hora por defecto
                        location: '',
                        notes: document.getElementById('attendance-description').value || ''
                    };
                    
                    try {
                        console.log('Creating training session:', attendanceData);
                        
                        const response = await fetch(getApiUrl('/api/trainings'), {
                            method: 'POST',
                            headers: getAuthHeaders(),
                            body: JSON.stringify(attendanceData)
                        });
                        
                        if (response.status === 401) {
                            handleAuthError('Token expired during training creation', response);
                            return;
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showMessage('Entrenamiento creado exitosamente', 'success');
                            closeAttendanceModal();
                            loadAttendanceForTeam();
                        } else {
                            showMessage('Error: ' + data.message, 'error');
                        }
                        
                    } catch (error) {
                        console.error('Error creating training:', error);
                        showMessage('Error creando entrenamiento: ' + error.message, 'error');
                    }
                });
            }
        });
        
        // ==========================================
        // END ATTENDANCE FUNCTIONS
        // ==========================================
        
        // ==========================================
        // REPORTS FUNCTIONS
        // ==========================================
        
        // Load reports management
        async function loadReports() {
            console.log('Loading reports management...');
            await loadTeamsForReports();
        }
        
        // Load teams for reports selector
        async function loadTeamsForReports() {
            try {
                const response = await fetch(getApiUrl('/api/teams'), {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('reports-team-select');
                    select.innerHTML = '<option value="">Selecciona un equipo...</option>';
                    
                    data.teams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = team.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading teams for reports:', error);
            }
        }
        
        // Load reports for selected team
        async function loadReportsForTeam() {
            const select = document.getElementById('reports-team-select');
            const container = document.getElementById('reports-content');
            
            if (!select.value) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üìä</div>
                        <h3>Selecciona un equipo para ver los reportes</h3>
                        <p>Podr√°s ver estad√≠sticas de asistencia, rendimiento y generar reportes exportables</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div class="loading">Cargando estad√≠sticas del equipo...</div>';
            
            try {
                // Get team data
                const teamResponse = await fetch(getApiUrl(`/api/teams`), {
                    headers: getAuthHeaders()
                });
                const teamData = await teamResponse.json();
                const team = teamData.success ? teamData.teams.find(t => t.id === select.value) : null;
                
                // Get players for the team
                const playersResponse = await fetch(getApiUrl(`/api/players?team_id=${select.value}`), {
                    headers: getAuthHeaders()
                });
                const playersData = await playersResponse.json();
                
                // Get trainings for the team
                const trainingsResponse = await fetch(getApiUrl(`/api/trainings?team_id=${select.value}`), {
                    headers: getAuthHeaders()
                });
                const trainingsData = await trainingsResponse.json();
                
                if (playersData.success && trainingsData.success) {
                    container.innerHTML = await generateReportsDashboard(
                        team, 
                        playersData.players, 
                        trainingsData.trainings,
                        select.value
                    );
                } else {
                    container.innerHTML = `<div class="message error">Error cargando datos del equipo</div>`;
                }
                
            } catch (error) {
                console.error('Error loading reports data:', error);
                container.innerHTML = `<div class="message error">Error cargando reportes: ${error.message}</div>`;
            }
        }
        
        // Generate reports dashboard HTML
        async function generateReportsDashboard(team, players, trainings, teamId) {
            // Get attendance statistics
            const attendanceStats = await getAttendanceStatistics(teamId, trainings, players);
            
            let html = `
                <div style="display: grid; gap: 20px;">
                    <!-- Team Summary Card -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.5em;">üìä Resumen de ${team ? team.name : 'Equipo'}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${players.length}</div>
                                <div>Jugadores</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${trainings.length}</div>
                                <div>Entrenamientos</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${attendanceStats.averageAttendance}%</div>
                                <div>Asistencia Promedio</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${attendanceStats.totalSessions}</div>
                                <div>Sesiones Registradas</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reports Actions -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #2c5aa0;">üìã Reporte de Asistencias</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Estad√≠sticas detalladas de asistencia por jugador y entrenamiento</p>
                            <button class="btn btn-primary" onclick="generateAttendanceReport('${teamId}')" style="width: 100%;">
                                üìä Ver Reporte Detallado
                            </button>
                        </div>
                        
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #2c5aa0;">üìà Estad√≠sticas por Jugador</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Rendimiento individual y comparativas entre jugadores</p>
                            <button class="btn btn-success" onclick="generatePlayerStats('${teamId}')" style="width: 100%;">
                                üë• Ver Estad√≠sticas
                            </button>
                        </div>
                        
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #2c5aa0;">üìÖ Reporte Temporal</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Tendencias de asistencia a lo largo del tiempo</p>
                            <button class="btn btn-info" onclick="generateTemporalReport('${teamId}')" style="width: 100%;">
                                ‚è±Ô∏è Ver Tendencias
                            </button>
                        </div>
                    </div>
            `;
            
            // Add player attendance quick view
            if (attendanceStats.playerStats.length > 0) {
                html += `
                    <!-- Quick Player Stats -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 20px 0; color: #2c5aa0;">üèÉ‚Äç‚ôÄÔ∏è Vista R√°pida - Asistencia por Jugador</h4>
                        <div style="display: grid; gap: 10px; max-height: 300px; overflow-y: auto;">
                `;
                
                attendanceStats.playerStats.forEach(player => {
                    const percentage = player.totalTrainings > 0 ? Math.round((player.presents / player.totalTrainings) * 100) : 0;
                    let statusColor = percentage >= 80 ? '#4CAF50' : percentage >= 60 ? '#FF9800' : '#f44336';
                    
                    html += `
                        <div style="display: flex; justify-content: between-center; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 6px;">
                            <div style="flex: 1;">
                                <strong>${player.name}</strong>
                                ${player.nickname ? `<span style="color: #666;">(${player.nickname})</span>` : ''}
                                ${player.jersey_number ? `<span style="color: #666;"> - #${player.jersey_number}</span>` : ''}
                            </div>
                            <div style="display: flex; gap: 15px; align-items: center; font-size: 0.9em;">
                                <span>‚úÖ ${player.presents}</span>
                                <span>‚è∞ ${player.lates}</span>
                                <span>‚ùå ${player.absents}</span>
                                <div style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; margin-left: 10px;">
                                    ${percentage}%
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            html += '</div>';
            return html;
        }
        
        // Get attendance statistics for a team
        async function getAttendanceStatistics(teamId, trainings, players) {
            const playerStats = [];
            let totalSessions = 0;
            let totalAttendances = 0;
            
            // Initialize player stats
            players.forEach(player => {
                playerStats.push({
                    id: player.id,
                    name: player.name,
                    nickname: player.nickname,
                    jersey_number: player.jersey_number,
                    presents: 0,
                    lates: 0,
                    absents: 0,
                    totalTrainings: 0
                });
            });
            
            // Get attendance data for each training
            for (const training of trainings) {
                try {
                    const response = await fetch(getApiUrl(`/api/training-attendances?training_session_id=${training.id}`), {
                        headers: getAuthHeaders()
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.attendances.length > 0) {
                            totalSessions++;
                            
                            // Update player stats based on this training
                            data.attendances.forEach(attendance => {
                                const playerStat = playerStats.find(p => p.id == attendance.player_id);
                                if (playerStat) {
                                    playerStat.totalTrainings++;
                                    
                                    switch (attendance.status) {
                                        case 'presente':
                                            playerStat.presents++;
                                            totalAttendances++;
                                            break;
                                        case 'tarde':
                                            playerStat.lates++;
                                            totalAttendances++;
                                            break;
                                        case 'ausente':
                                            playerStat.absents++;
                                            break;
                                    }
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error fetching attendance for training:', training.id, error);
                }
            }
            
            // Calculate overall statistics
            const averageAttendance = totalSessions > 0 && players.length > 0 
                ? Math.round((totalAttendances / (totalSessions * players.length)) * 100)
                : 0;
            
            return {
                playerStats,
                totalSessions,
                averageAttendance,
                totalAttendances
            };
        }
        
        // Generate detailed attendance report
        async function generateAttendanceReport(teamId) {
            const container = document.getElementById('reports-content');
            container.innerHTML = '<div class="loading">Generando reporte detallado...</div>';
            
            try {
                // Get detailed data
                const playersResponse = await fetch(getApiUrl(`/api/players?team_id=${teamId}`), {
                    headers: getAuthHeaders()
                });
                const playersData = await playersResponse.json();
                
                const trainingsResponse = await fetch(getApiUrl(`/api/trainings?team_id=${teamId}`), {
                    headers: getAuthHeaders()
                });
                const trainingsData = await trainingsResponse.json();
                
                if (!playersData.success || !trainingsData.success) {
                    throw new Error('Error cargando datos del equipo');
                }
                
                const attendanceStats = await getAttendanceStatistics(teamId, trainingsData.trainings, playersData.players);
                
                let html = `
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: between-center; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                            <h2 style="margin: 0; color: #2c5aa0;">üìä Reporte Detallado de Asistencias</h2>
                            <button class="btn btn-secondary" onclick="loadReportsForTeam()">‚Üê Volver a Reportes</button>
                        </div>
                        
                        <!-- Summary Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #28a745;">${attendanceStats.totalSessions}</div>
                                <div>Entrenamientos</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #007bff;">${playersData.players.length}</div>
                                <div>Jugadores</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #fd7e14;">${attendanceStats.averageAttendance}%</div>
                                <div>Asistencia Promedio</div>
                            </div>
                        </div>
                        
                        <!-- Player Details Table -->
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; background: white;">
                                <thead>
                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                        <th style="padding: 12px; text-align: left; border-right: 1px solid #dee2e6;">Jugador</th>
                                        <th style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6;">‚úÖ Presente</th>
                                        <th style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6;">‚è∞ Tarde</th>
                                        <th style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6;">‚ùå Ausente</th>
                                        <th style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6;">Total</th>
                                        <th style="padding: 12px; text-align: center;">% Asistencia</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                attendanceStats.playerStats.forEach((player, index) => {
                    const total = player.presents + player.lates + player.absents;
                    const percentage = total > 0 ? Math.round(((player.presents + player.lates) / total) * 100) : 0;
                    const rowBg = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    let statusColor = percentage >= 80 ? '#28a745' : percentage >= 60 ? '#ffc107' : '#dc3545';
                    
                    html += `
                        <tr style="background: ${rowBg}; border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px; border-right: 1px solid #dee2e6;">
                                <strong>${player.name}</strong>
                                ${player.nickname ? `<br><small style="color: #666;">"${player.nickname}"</small>` : ''}
                                ${player.jersey_number ? `<span style="color: #007bff;"> #${player.jersey_number}</span>` : ''}
                            </td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; color: #28a745; font-weight: bold;">${player.presents}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; color: #ffc107; font-weight: bold;">${player.lates}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; color: #dc3545; font-weight: bold;">${player.absents}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; font-weight: bold;">${total}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;">
                                    ${percentage}%
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Export Actions -->
                        <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; justify-content: center;">
                            <button class="btn btn-success" onclick="exportAttendanceReport('${teamId}', 'csv')">
                                üìä Exportar CSV
                            </button>
                            <button class="btn btn-info" onclick="exportAttendanceReport('${teamId}', 'print')">
                                üñ®Ô∏è Imprimir Reporte
                            </button>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error generating attendance report:', error);
                container.innerHTML = `<div class="message error">Error generando reporte: ${error.message}</div>`;
            }
        }
        
        // Export attendance report
        function exportAttendanceReport(teamId, format) {
            if (format === 'print') {
                window.print();
            } else if (format === 'csv') {
                showMessage('Exportaci√≥n CSV pr√≥ximamente disponible', 'info');
                // TODO: Implement CSV export
            }
        }
        
        // Generate player statistics (placeholder)
        function generatePlayerStats(teamId) {
            showMessage('Estad√≠sticas por jugador pr√≥ximamente disponible', 'info');
            // TODO: Implement detailed player statistics
        }
        
        // Generate temporal report (placeholder)
        function generateTemporalReport(teamId) {
            showMessage('Reporte temporal pr√≥ximamente disponible', 'info');
            // TODO: Implement temporal trending reports
        }
        
        // ==========================================
        // END REPORTS FUNCTIONS
        // ==========================================
        
        // Initialize dashboard on page load
        checkCoachAccess();
    </script>
</body>
</html>
