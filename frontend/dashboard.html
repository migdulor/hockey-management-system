<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hockey Management - Dashboard de Entrenador</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
        }
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }
        
        /* Media Queries para Responsive Design */
        @media (min-width: 768px) {
            .dashboard-container {
                padding: 20px;
            }
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        @media (min-width: 768px) {
            .header {
                flex-direction: row;
                justify-content: space-between;
                padding: 20px;
            }
        }
        
        .header h1 {
            color: #1e3c72;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            text-align: center;
        }
        
        @media (min-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        @media (min-width: 768px) {
            .user-info {
                gap: 15px;
                justify-content: flex-end;
            }
        }
        .btn-logout {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        @media (min-width: 768px) {
            .btn-logout {
                padding: 10px 20px;
                font-size: 1rem;
            }
        }
        
        .btn-logout:hover {
            background: #c82333;
        }
        
        .main-nav {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        @media (min-width: 768px) {
            .main-nav {
                padding: 15px;
            }
        }
        
        .nav-tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        @media (min-width: 768px) {
            .nav-tabs {
                gap: 10px;
                justify-content: flex-start;
            }
        }
        
        .nav-tab {
            padding: 10px 16px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
            font-size: 0.85rem;
            flex: 1;
            text-align: center;
            min-width: fit-content;
        }
        
        @media (min-width: 768px) {
            .nav-tab {
                padding: 12px 24px;
                font-size: 1rem;
                flex: none;
            }
        }
        
        @media (max-width: 480px) {
            .nav-tab {
                font-size: 0.75rem;
                padding: 8px 12px;
            }
        }
        .nav-tab.active {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
        }
        .nav-tab:hover:not(.active) {
            background: #e9ecef;
        }
        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }
        
        @media (min-width: 768px) {
            .tab-content {
                padding: 30px;
                min-height: 500px;
            }
        }
        
        .tab-content.active {
            display: block;
        }
        
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .quick-stats {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
        }
        
        .stat-card {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        @media (min-width: 768px) {
            .stat-card {
                padding: 20px;
            }
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        @media (min-width: 768px) {
            .stat-number {
                font-size: 2.5em;
            }
        }
        
        .stat-label {
            font-size: 0.8em;
            opacity: 0.9;
        }
        
        @media (min-width: 768px) {
            .stat-label {
                font-size: 0.9em;
            }
        }
        .welcome-section {
            text-align: center;
            padding: 20px 10px;
        }
        
        @media (min-width: 768px) {
            .welcome-section {
                padding: 40px 20px;
            }
        }
        
        .welcome-section h2 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        @media (min-width: 768px) {
            .welcome-section h2 {
                font-size: 2em;
                margin-bottom: 20px;
            }
        }
        
        .welcome-section p {
            color: #666;
            font-size: 1em;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }
        
        @media (min-width: 768px) {
            .welcome-section p {
                font-size: 1.1em;
            }
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (min-width: 768px) {
            .feature-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 30px;
            }
        }
        
        .feature-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border-left: 5px solid #1e3c72;
        }
        
        @media (min-width: 768px) {
            .feature-card {
                padding: 25px;
            }
        }
        .feature-card h3 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .feature-card p {
            color: #666;
            line-height: 1.5;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-primary {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 60, 114, 0.3);
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .coming-soon {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .coming-soon h3 {
            color: #1e3c72;
            margin-bottom: 15px;
        }
        .coming-soon .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        .teams-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (min-width: 768px) {
            .teams-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
            }
        }
        
        .team-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        @media (min-width: 768px) {
            .team-card {
                padding: 20px;
            }
        }
        
        .team-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: #1e3c72;
        }
        
        .team-card h3 {
            color: #1e3c72;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        @media (min-width: 768px) {
            .team-card h3 {
                font-size: 1.3em;
            }
        }
        
        .team-info {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        @media (min-width: 768px) {
            .team-info {
                gap: 10px;
            }
        }
        
        .team-badge {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        @media (min-width: 768px) {
            .team-badge {
                font-size: 0.85em;
            }
        }
        
        .team-badge.division {
            background: #d4edda;
            color: #155724;
        }
        .team-badge.category {
            background: #cce5ff;
            color: #004085;
        }
        
        .team-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        @media (min-width: 768px) {
            .team-actions {
                gap: 8px;
            }
        }
        .btn-sm {
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 6px;
            flex: 1;
            min-width: fit-content;
            text-align: center;
        }
        
        @media (min-width: 768px) {
            .btn-sm {
                padding: 6px 12px;
                font-size: 12px;
                flex: none;
            }
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (min-width: 480px) {
            .players-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
        
        @media (min-width: 768px) {
            .players-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 20px;
            }
        }
        
        .player-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        @media (min-width: 768px) {
            .player-card {
                padding: 20px;
            }
        }
        
        .player-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: #28a745;
        }
        .player-header {
            margin-bottom: 15px;
        }
        .player-header h4 {
            color: #1e3c72;
            margin: 0 0 5px 0;
            font-size: 1.2em;
        }
        .player-nickname {
            color: #666;
            font-style: italic;
            font-size: 0.9em;
        }
        .player-info {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .jersey-number {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 50%;
            font-weight: bold;
            min-width: 32px;
            text-align: center;
            font-size: 0.9em;
        }
        .player-position {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .starter-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffc107;
            color: #212529;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
        }
        .player-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        /* Report Cards Hover Effects */
        .report-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 15px rgba(0,123,255,0.2);
            transform: translateY(-2px);
        }
        
        /* Custom button styles */
        .btn-purple {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-purple:hover {
            background: #5a2d91;
            transform: translateY(-1px);
        }
        
        /* Loading animation */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        /* ========== RESPONSIVE IMPROVEMENTS ========== */
        
        /* Form Elements */
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        @media (min-width: 768px) {
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px;
                padding: 12px;
            }
        }
        
        /* Button Groups */
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .button-group .btn {
            flex: 1;
            min-width: 120px;
        }
        
        @media (min-width: 768px) {
            .button-group .btn {
                flex: none;
            }
        }
        
        /* Tables Responsive */
        .table-responsive {
            overflow-x: auto;
            margin: 15px 0;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling en iOS */
        }
        
        .table-responsive table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            background: white;
        }
        
        .table-responsive th,
        .table-responsive td {
            padding: 8px 6px !important; /* Override inline styles */
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 12px !important; /* Smaller on mobile */
            white-space: nowrap;
        }
        
        @media (min-width: 768px) {
            .table-responsive th,
            .table-responsive td {
                padding: 12px 15px !important;
                font-size: 14px !important;
            }
        }
        
        @media (min-width: 1024px) {
            .table-responsive th,
            .table-responsive td {
                font-size: 16px !important;
            }
        }
        
        .table-responsive th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
        }
        
        /* Modal Responsive */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 10px;
            padding: 20px;
            border-radius: 12px;
            width: calc(100% - 20px);
            max-width: 500px;
            margin: 50px auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        @media (min-width: 768px) {
            .modal-content {
                margin: 100px auto;
                padding: 30px;
            }
        }
        
        /* Attendance Controls */
        .attendance-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .attendance-controls {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }
        
        .team-selector,
        .training-selector {
            flex: 1;
            max-width: 300px;
        }
        
        /* Player Actions Responsive */
        .player-actions {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        
        @media (min-width: 768px) {
            .player-actions {
                gap: 8px;
            }
        }
        
        /* Reports Grid */
        .reports-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        @media (min-width: 768px) {
            .reports-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
            }
        }
        
        /* KPIs Responsive */
        .kpis-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 480px) {
            .kpis-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* Filter Controls */
        .filter-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        @media (min-width: 768px) {
            .filter-controls {
                flex-direction: row;
                align-items: center;
                flex-wrap: wrap;
            }
        }
        
        /* Small devices specific */
        @media (max-width: 480px) {
            .dashboard-container {
                padding: 5px;
            }
            
            .header {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
            
            .nav-tab {
                font-size: 0.7rem;
                padding: 6px 8px;
            }
            
            .tab-content {
                padding: 10px;
            }
            
            .btn {
                font-size: 12px;
                padding: 8px 16px;
            }
            
            .modal-content {
                margin: 20px 10px;
                padding: 15px;
            }
            
            /* Report optimizations for mobile */
            .ranking-chart-mobile {
                padding: 10px !important;
            }
            
            .ranking-chart-mobile .bar-container {
                margin-bottom: 8px !important;
            }
            
            .ranking-chart-mobile .player-name {
                width: 100px !important;
                font-size: 0.75rem !important;
                line-height: 1.2 !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .ranking-chart-mobile .progress-bar {
                height: 20px !important;
                margin: 0 8px !important;
            }
            
            .ranking-chart-mobile .percentage-text {
                font-size: 0.7rem !important;
            }
        }
        
        /* Touch-friendly interactions */
        @media (hover: none) {
            .btn:hover,
            .nav-tab:hover,
            .team-card:hover,
            .player-card:hover {
                transform: none;
            }
        }

        /* =============================================
           ESTILOS PARA MÓDULO DE FORMACIONES
           ============================================= */
        
        .formation-step {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .formation-step.active {
            border-color: #2a5298;
            box-shadow: 0 4px 15px rgba(42, 82, 152, 0.1);
        }

        /* Campo 3D móvil mejorado */
        #hockey-field {
            position: relative;
            background: #2a7f3e;
            border-radius: 15px;
            border: 4px solid #fff;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            min-height: 500px;
            perspective: 1500px;
        }

        .field-3d {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 500px;
            transform-style: preserve-3d;
            transform: rotateX(20deg) rotateZ(0deg);
            background: #2a7f3e;
            /* Textura del césped */
            background-image: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 10px,
                rgba(0, 0, 0, 0.03) 10px,
                rgba(0, 0, 0, 0.03) 20px
            );
        }

        .field-position-slot {
            position: absolute;
            width: 45px;
            height: 45px;
            border: 3px dashed rgba(255,255,255,0.6);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .field-position-slot:hover {
            background: rgba(255,255,255,0.3);
            border-color: white;
            transform: translate(-50%, -50%) scale(1.1);
        }

        .formation-preset-btn {
            background: #28a745 !important;
            margin-right: 5px;
            margin-bottom: 5px;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .formation-preset-btn:hover {
            background: #218838 !important;
            transform: translateY(-1px);
        }

        .player-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .player-item:hover {
            background: #e9ecef;
            border-color: #2a5298;
            transform: translateX(3px);
        }

        .player-item[draggable="true"] {
            cursor: grab;
        }

        .player-item[draggable="true"]:active {
            cursor: grabbing;
        }

        /* Estilo para jugadora seleccionada en sistema click-click */
        .player-item.selected {
            border: 2px solid #28a745 !important;
            background-color: #f8f9fa !important;
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(40, 167, 69, 0.3) !important;
        }

        .player-on-field {
            position: absolute;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            border: 3px solid #fff;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.7rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            transform-style: preserve-3d;
            animation: playerPulse 2s infinite;
        }

        .player-on-field:hover {
            transform: scale(1.1) translateZ(10px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .player-on-field.goalkeeper {
            background: linear-gradient(45deg, #4ecdc4, #44d9cc);
        }

        .player-on-field.defender {
            background: linear-gradient(45deg, #45b7d1, #69c7e5);
        }

        .player-on-field.midfielder {
            background: linear-gradient(45deg, #f9ca24, #f0932b);
        }

        .player-on-field.forward {
            background: linear-gradient(45deg, #eb4d4b, #ff6348);
        }

        .substitute-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 4px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .substitute-item:hover {
            background: #e9ecef;
        }

        #substitutes-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 10px;
            min-height: 120px;
            background: white;
            transition: all 0.3s ease;
            position: relative;
        }

        #substitutes-area.drag-over {
            border-color: #28a745;
            background: #f8fff8;
        }

        #substitutes-area:empty::after {
            content: "↓ Zona de Suplentes ↓";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-weight: bold;
            opacity: 0.5;
            pointer-events: none;
            text-align: center;
            z-index: 1;
            font-size: 0.8rem;
        }

        /* Animaciones para jugadoras */
        @keyframes playerPulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.05);
                box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            }
        }
            /* =============================
               RESPONSIVE FORMACIONES MEJORADO
            ============================= */
            @media (max-width: 480px) {
                .player-on-field {
                    width: 12px;
                    height: 12px;
                    font-size: 0.22rem;
                    margin: 2px;
                }
                .field-position-slot {
                    width: 15px;
                    height: 15px;
                    margin: 4px;
                }
                .player-avatar {
                    width: 18px !important;
                    height: 18px !important;
                }
                .player-avatar-small {
                    width: 12px !important;
                    height: 12px !important;
                }
                .field-3d, .formation-field-grid {
                    display: grid !important;
                    grid-template-columns: repeat(4, 1fr) !important;
                    gap: 12px !important;
                    min-height: 200px !important;
                }
            }
            /* =============================
               RESPONSIVE FORMACIONES
            ============================= */
            @media (max-width: 900px) {
                .player-on-field {
                    width: 28px;
                    height: 28px;
                    font-size: 0.6rem;
                }
                .field-position-slot {
                    width: 35px;
                    height: 35px;
                }
                .player-avatar {
                    width: 45px !important;
                    height: 45px !important;
                }
                .player-avatar-small {
                    width: 28px !important;
                    height: 28px !important;
                }
            }
            @media (max-width: 600px) {
                .player-on-field {
                    width: 15px;
                    height: 15px;
                    font-size: 0.3rem;
                }
                .field-position-slot {
                    width: 18px;
                    height: 18x;
                }
                .player-avatar {
                    width: 25px !important;
                    height: 25px !important;
                }
                .player-avatar-small {
                    width: 15px !important;
                    height: 15px !important;
                }
            }

        /* Indicadores de roles en el campo */
        .field-position-slot[data-role="goalkeeper"] {
            border-color: rgba(78, 205, 196, 0.8);
        }

        .field-position-slot[data-role="defender"] {
            border-color: rgba(69, 183, 209, 0.8);
        }

        .field-position-slot[data-role="midfielder"] {
            border-color: rgba(249, 202, 36, 0.8);
        }

        .field-position-slot[data-role="forward"] {
            border-color: rgba(235, 77, 75, 0.8);
        }

        /* RESPONSIVE DESIGNS FOR FORMATIONS */
        @media (max-width: 1200px) {
            #formations-layout {
                grid-template-columns: 1fr !important;
            }

            #hockey-field {
                min-height: 400px !important;
                margin-bottom: 20px;
            }

            .field-3d {
                min-height: 400px !important;
                transform: rotateX(15deg);
            }
        }

        @media (max-width: 768px) {
            .formation-step {
                padding: 10px;
            }

            .formation-preset-btn {
                font-size: 0.8rem;
                padding: 6px 12px;
            }

            #hockey-field {
                min-height: 350px !important;
            }

            .field-3d {
                min-height: 350px !important;
                transform: rotateX(10deg);
            }

            .field-position-slot {
                width: 35px;
                height: 35px;
            }

            .player-on-field {
                width: 30px;
                height: 30px;
                font-size: 0.6rem;
            }

            .player-item {
                font-size: 0.75rem;
                padding: 6px;
            }

            .substitute-item {
                font-size: 0.7rem;
                padding: 4px;
            }
        }

        @media (max-width: 480px) {
            #formation-steps {
                padding: 10px;
            }

            .formation-step h3 {
                font-size: 1.1rem;
            }

            #hockey-field {
                min-height: 300px !important;
                border-width: 2px;
            }

            .field-3d {
                min-height: 300px !important;
                transform: rotateX(5deg);
            }

            .formation-preset-btn {
                font-size: 0.7rem;
                padding: 5px 10px;
                margin-right: 3px;
                margin-bottom: 3px;
            }

            .field-position-slot {
                width: 30px;
                height: 30px;
                border-width: 2px;
            }

            .player-on-field {
                width: 25px;
                height: 25px;
                font-size: 0.5rem;
                border-width: 2px;
            }

            .player-item {
                font-size: 0.7rem;
                padding: 5px;
                gap: 5px;
            }

            .substitute-item {
                font-size: 0.65rem;
                padding: 3px;
                gap: 4px;
            }

            #substitutes-area {
                min-height: 80px;
                padding: 5px;
            }

            #substitutes-area:empty::after {
                font-size: 0.7rem;
            }
            
            /* Layout responsivo para móviles - cancha y jugadoras en columnas */
            .formation-field-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            .formation-sidebar {
                position: static !important;
                margin-top: 20px;
            }
        }

        /* Menús móviles */
        .mobile-menu {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            transform: translateY(100%);
            transition: all 0.3s ease;
        }

        .mobile-menu.show {
            opacity: 1;
            transform: translateY(0);
        }

        .mobile-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .mobile-menu-header h4 {
            margin: 0;
            font-size: 1.1rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .mobile-menu-content {
            background: white;
            max-height: 70vh;
            overflow-y: auto;
            width: 100%;
            max-width: 400px;
            margin: 0 20px;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.3);
        }

        .player-option {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            gap: 12px;
        }

        .player-option:hover {
            background: #f8f9fa;
        }

        .player-option:last-child {
            border-bottom: none;
        }

        .player-details {
            display: flex;
            align-items: center;
            padding: 20px;
            gap: 12px;
            border-bottom: 1px solid #eee;
        }

        .action-btn {
            width: 100%;
            padding: 15px;
            border: none;
            background: #667eea;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .action-btn:hover {
            background: #5a6fd8;
        }

        .remove-btn {
            background: #dc3545;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        /* Estilos para avatares de jugadoras */
        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            transition: all 0.3s ease;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        /* Cuando la jugadora está en la cancha, hacer el avatar más visible */
        .field-position .player-avatar {
            width: 70px;
            height: 70px;
            border: 4px solid #FFD700;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        /* Contenedor de jugadora en el campo */
        .player-field-container {
            position: relative;
        }

        /* Botón de remover jugadora */
        .remove-player-btn {
            transition: all 0.2s ease;
        }

        .remove-player-btn:hover {
            background: #c82333 !important;
            transform: scale(1.1);
        }

        .player-avatar-small {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            flex-shrink: 0;
        }

        .player-avatar-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-nickname {
            font-weight: bold;
            font-size: 12px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
            background: rgba(0,0,0,0.8);
            padding: 4px 8px;
            border-radius: 10px;
            margin-top: 3px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .player-number {
            font-size: 12px;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
            font-weight: bold;
            background: rgba(0,0,0,0.8);
            padding: 3px 6px;
            border-radius: 8px;
            margin-top: 2px;
            border: 1px solid rgba(255,215,0,0.5);
        }

        /* Mejorar el contenedor de información en las posiciones */
        .position-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            min-width: 70px;
            min-height: 70px;
            position: relative;
        }

        .position-slot .player-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 1px;
            margin-top: 2px;
        }

        .position-slot .remove-player-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .position-slot .remove-player-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .player-jersey {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1rem;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: bold;
            font-size: 1rem;
            color: #333;
            margin-bottom: 2px;
        }

        .player-position {
            font-size: 0.85rem;
            color: #666;
        }

        /* Toast messages */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #333;
            color: white;
            border-radius: 5px;
            z-index: 10001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.warning {
            background: #ff9800;
        }

        .toast.success {
            background: #4caf50;
        }

        .toast.error {
            background: #f44336;
        }

        /* CSS responsivo para el layout de formación */
        @media (max-width: 1400px) {
            #formations-layout {
                flex-direction: column !important;
                gap: 20px !important;
            }
            
            .formation-sidebar {
                width: 100% !important;
                max-width: 800px !important;
                margin: 0 auto !important;
                order: 2 !important;
            }
            
            .container {
                max-width: 100% !important;
                order: 1 !important;
            }
        }

        @media (max-width: 768px) {
            .formation-sidebar {
                padding: 10px !important;
            }
            
            #available-players-list {
                max-height: 400px !important;
            }
            
            #formations-layout {
                gap: 15px !important;
            }
        }
    </style>
    
    <!-- SheetJS para leer archivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- html2canvas para capturar elementos como imagen -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>Hockey Management - Dashboard</h1>
            <div class="user-info">
                <span id="user-name">Cargando...</span>
                <button class="btn-logout" onclick="logout()">Cerrar Sesión</button>
            </div>
        </div>

        <!-- Main Navigation -->
        <div class="main-nav">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('overview')">📊 Resumen</button>
                <button class="nav-tab" onclick="showTab('teams')">👥 Mis Equipos</button>
                <button class="nav-tab" onclick="showTab('players')">🏃‍♀️ Jugadores</button>
                <button class="nav-tab" onclick="showTab('attendance')">📋 Asistencias</button>
                <button class="nav-tab" onclick="showTab('formations')">🏑 Formaciones</button>
                <button class="nav-tab" onclick="showTab('matches')">🏑 Partidos</button>
                <button class="nav-tab" onclick="showTab('reports')">📈 Reportes</button>
            </div>
        </div>

        <div id="message" class="message"></div>

        <!-- Tab: Resumen -->
        <div id="overview-tab" class="tab-content active">
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-teams">0</div>
                    <div class="stat-label">Equipos Activos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-players">0</div>
                    <div class="stat-label">Jugadoras Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="upcoming-matches">0</div>
                    <div class="stat-label">Próximos Partidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="formations-created">0</div>
                    <div class="stat-label">Formaciones Creadas</div>
                </div>
            </div>

            <div class="welcome-section">
                <h2>¡Bienvenido al Sistema de Gestión de Hockey!</h2>
                <p>
                    Desde aquí puedes gestionar todos tus equipos, registrar asistencias a entrenamientos, 
                    crear formaciones tácticas visuales y llevar el control completo de tus partidos con 
                    capacidades offline durante los juegos.
                </p>

                <div class="feature-grid">
                    <div class="feature-card">
                        <h3>📋 Registro de Asistencias</h3>
                        <p>
                            Lleva un control detallado de la asistencia de tus jugadoras a los entrenamientos. 
                            Marca presente, tarde o ausente con observaciones adicionales.
                        </p>
                    </div>
                    <div class="feature-card">
                        <h3>🏑 Formaciones Visuales</h3>
                        <p>
                            Crea formaciones tácticas arrastrando jugadoras a posiciones en la cancha. 
                            Exporta como imagen para compartir con tu equipo.
                        </p>
                    </div>
                    <div class="feature-card">
                        <h3>🏑 Gestión de Partidos</h3>
                        <p>
                            Registra acciones en tiempo real durante los partidos con capacidad offline. 
                            Control de tiempos y cambios de jugadoras automático.
                        </p>
                    </div>
                    <div class="feature-card">
                        <h3>📈 Reportes Detallados</h3>
                        <p>
                            Genera mapas de calor tácticos, estadísticas de rendimiento y reportes 
                            completos para análisis estratégico del equipo.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Mis Equipos -->
        <div id="teams-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">👥 Gestión de Equipos</h2>
            
            <!-- Header con botón crear equipo -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <p>Gestiona tus equipos y jugadoras. Máximo permitido: <strong id="max-teams-display">-</strong> equipos</p>
                </div>
                <button class="btn btn-primary" onclick="showCreateTeamModal()">
                    ➕ Crear Nuevo Equipo
                </button>
            </div>

            <!-- Lista de equipos -->
            <div id="teams-list" class="loading">
                Cargando equipos...
            </div>

            <!-- Modal crear/editar equipo -->
            <div id="team-modal" class="modal">
                <div class="modal-content">
                    <h3 id="modal-title">Crear Nuevo Equipo</h3>
                    <form id="team-form" style="margin-top: 20px;">
                        <div class="form-group">
                            <label>Nombre del Equipo *</label>
                            <input type="text" id="team-name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label>Nombre del Club *</label>
                            <input type="text" id="club-name" name="club_name" required>
                        </div>
                        <div class="form-group">
                            <label>Género del Equipo *</label>
                            <select id="team-gender" name="gender" required onchange="loadDivisionsForGender(this.value)">
                                <option value="">Seleccionar género...</option>
                                <option value="female">Femenino</option>
                                <option value="male">Masculino</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>División</label>
                            <select id="team-division" name="division_id">
                                <option value="">Primero selecciona el género...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Máximo de Jugadores</label>
                            <input type="number" id="max-players" name="max_players" min="10" max="22" value="20">
                            <small style="color: #666; font-size: 0.9em; display: block; margin-top: 5px;">Número máximo de jugadores permitidos en el equipo (por defecto: 25)</small>
                        </div>
                        <div class="form-group">
                            <label>Foto de la Camiseta del Equipo</label>
                            <input type="file" id="team-jersey-photo" name="team_jersey_photo" accept="image/*">
                            <small style="color: #666; font-size: 0.9em; display: block; margin-top: 5px;">Imagen de la camiseta sin jugadora (será usada como imagen por defecto en formaciones). Formatos: JPG, PNG, WEBP (máx. 2MB)</small>
                            <div id="team-jersey-preview" style="margin-top: 10px; display: none;">
                                <img id="team-jersey-img" style="max-width: 100px; max-height: 100px; border-radius: 8px; border: 1px solid #ddd;">
                            </div>
                        </div>
                        <div class="button-group">
                            <button type="button" class="btn btn-secondary" onclick="closeTeamModal()">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Guardar Equipo
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tab: Jugadores -->
        <div id="players-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="current-team-name">Selecciona un equipo primero</h2>
                <div id="add-player-btn" style="display: none;">
                    <button class="btn btn-primary" onclick="showCreatePlayerModal()" style="margin-right: 10px;">
                        ➕ Agregar Jugador
                    </button>
                    <button class="btn btn-success" onclick="showExcelImportModal()">
                        📊 Importar Excel
                    </button>
                </div>
            </div>
            
            <div id="players-list">
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3em; margin-bottom: 20px;">🏃‍♀️</div>
                    <h3>Gestión de Jugadores</h3>
                    <p>Ve a "Mis Equipos" y haz clic en "👥 Jugadoras" de cualquier equipo para ver y gestionar sus jugadores</p>
                </div>
            </div>

            <!-- Listado de jugadoras sin equipo -->
            <div id="unassigned-players-section" style="margin-top:40px;">
                <h3>Jugadoras sin equipo</h3>
                <div id="unassignedPlayers"></div>
                <button class="btn btn-secondary" onclick="fetchUnassignedPlayers()">Actualizar listado</button>
            </div>

            <!-- Modal para agregar jugador -->
            <div id="player-modal" class="modal">
                <div class="modal-content">
                    <h3 id="player-modal-title">Agregar Jugador</h3>
                    <form id="player-form" style="margin-top: 20px;">
                        <div class="form-group">
                            <label>Nombre Completo *</label>
                            <input type="text" id="player-name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label>Apodo/Nickname</label>
                            <input type="text" id="player-nickname" name="nickname">
                        </div>
                        <div class="form-group">
                            <label>Fecha de Nacimiento *</label>
                            <input type="date" id="player-birth-date" name="birth_date" required>
                        </div>
                        <div class="form-group">
                            <label>Posición</label>
                            <select id="player-position" name="position">
                                <option value="">Seleccionar posición...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Número de Camiseta</label>
                            <input type="number" id="player-jersey" name="jersey_number" min="1" max="99">
                        </div>
                        <div class="form-group">
                            <label>Foto de la Jugadora</label>
                            <input type="file" id="player-photo" name="player_photo" accept="image/*">
                            <small style="color: #666; font-size: 0.9em; display: block; margin-top: 5px;">Formatos: JPG, PNG, WEBP (máx. 2MB)</small>
                            <div id="player-photo-preview" style="margin-top: 10px; display: none;">
                                <img id="player-photo-img" style="max-width: 100px; max-height: 100px; border-radius: 8px; border: 1px solid #ddd;">
                            </div>
                        </div>
                        <div class="button-group">
                            <button type="button" class="btn btn-secondary" onclick="closePlayerModal()">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Guardar Jugador
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para importar Excel -->
        <div id="excel-import-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 600px; width: 90%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3>📊 Importar Jugadores desde Excel</h3>
                    <button onclick="closeExcelImportModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">×</button>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4>📋 Formato requerido del archivo Excel:</h4>
                    <p>Tu archivo Excel debe tener exactamente estas columnas en la primera fila:</p>
                    <div style="background: white; padding: 15px; border-radius: 4px; margin: 10px 0;">
                        <strong>Columnas obligatorias:</strong><br>
                        <code>Nombre | Apodo | Fecha de Nacimiento | Posición | Número de Camiseta</code>
                    </div>
                    <p><strong>Ejemplo de datos:</strong></p>
                    <div style="background: white; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                        María García | Marita | 15/03/1995 | Portera | 1<br>
                        Ana López | Ana | 22/07/1998 | Defensora | 2<br>
                        Sofia Rodríguez | | 10/11/1996 | Mediocampista | 10
                    </div>
                    <p style="margin-top: 10px; font-size: 14px; color: #666;">
                        • <strong>Fecha de Nacimiento:</strong> Formato DD/MM/YYYY (ejemplo: 15/03/1995)<br>
                        • <strong>Apodo:</strong> Puede estar vacío<br>
                        • <strong>Posiciones válidas:</strong> Para equipos femeninos: Portera, Arquera, Defensora, Mediocampista, Delantera
                    </p>
                </div>
                
                <form id="excel-import-form" style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Seleccionar archivo Excel:</label>
                        <input type="file" id="excel-file" accept=".xlsx,.xls" required 
                               style="width: 100%; padding: 10px; border: 2px dashed #ddd; border-radius: 8px; cursor: pointer;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeExcelImportModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Cancelar
                        </button>
                        <button type="submit" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            📊 Importar Jugadores
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal: Crear Lista de Asistencia -->
        <div id="attendance-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="background: white; width: 90%; max-width: 600px; margin: 5% auto; padding: 0; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
                <div style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                    <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                        📋 Nueva Lista de Asistencia
                    </h2>
                </div>
                <form id="attendance-form" style="padding: 25px;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Fecha de la Actividad:</label>
                        <input type="date" id="attendance-date" required 
                               style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Tipo de Actividad:</label>
                        <select id="attendance-type" required 
                                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px;">
                            <option value="">Seleccionar tipo...</option>
                            <option value="training">🏋️ Entrenamiento</option>
                            <option value="match">🏑 Partido</option>
                            <option value="meeting">👥 Reunión</option>
                            <option value="other">📝 Otro</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Descripción (opcional):</label>
                        <textarea id="attendance-description" rows="3" placeholder="Ej: Entrenamiento de preparación física..."
                                  style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                        <button type="button" onclick="closeAttendanceModal()" 
                                style="padding: 12px 24px; background: #f5f5f5; color: #333; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: all 0.3s;">
                            ❌ Cancelar
                        </button>
                        <button type="submit" 
                                style="padding: 12px 24px; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: all 0.3s;">
                            ✅ Crear Lista
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab: Asistencias -->
        <div id="attendance-tab" class="tab-content">
            <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
                <div style="display: flex; justify-content: between-center; align-items: center; margin-bottom: 20px;">
                    <h2>📋 Gestión de Asistencias</h2>
                    <button class="btn btn-primary" onclick="showCreateAttendanceModal()" style="margin-left: auto;">
                        ➕ Nueva Lista de Asistencia
                    </button>
                </div>
                
                <!-- Selector de equipo para asistencias -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h3>Seleccionar Equipo</h3>
                    <select id="attendance-team-select" onchange="loadAttendanceForTeam()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Selecciona un equipo...</option>
                    </select>
                </div>
                
                <!-- Lista de asistencias -->
                <div id="attendance-list" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">📋</div>
                        <h3>Selecciona un equipo para ver las asistencias</h3>
                        <p>Podrás registrar y gestionar las asistencias de entrenamientos y partidos</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Formaciones -->
        <div id="formations-tab" class="tab-content">
            <div style="max-width: 1600px; margin: 0 auto;">
                <h2 style="margin-bottom: 20px; color: #1e3c72;">🏑 Gestión de Formaciones del Equipo</h2>
                
                <!-- Pasos de configuración -->
                <div id="formation-steps" style="background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    
                    <!-- Paso 1: Selección de Equipo -->
                    <div id="step1" class="formation-step" style="display: block;">
                        <h3 style="color: #2a5298; margin-bottom: 15px;">📋 1. Seleccionar Equipo</h3>
                        <div class="form-group">
                            <label>Selecciona el equipo para crear la formación:</label>
                            <select id="formations-team-select" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 5px; font-size: 16px;">
                                <option value="">Cargando equipos...</option>
                            </select>
                        </div>
                        <button id="step1-next" class="btn btn-primary" style="margin-top: 15px;" disabled>Continuar →</button>
                    </div>

                    <!-- Paso 2: Información del Partido -->
                    <div id="step2" class="formation-step" style="display: none;">
                        <h3 style="color: #2a5298; margin-bottom: 15px;">🏑 2. Información del Partido</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div class="form-group">
                                <label>Rival:</label>
                                <input type="text" id="match-rival" placeholder="Nombre del equipo rival" style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 5px;">
                            </div>
                            <div class="form-group">
                                <label>Fecha:</label>
                                <input type="date" id="match-date" style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 5px;">
                            </div>
                            <div class="form-group">
                                <label>Cancha:</label>
                                <input type="text" id="match-venue" placeholder="Nombre de la cancha" style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 5px;">
                            </div>
                            <div class="form-group">
                                <label>Hora:</label>
                                <input type="time" id="match-time" style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 5px;">
                            </div>
                            <div class="form-group">
                                <label>Hora de Presentación:</label>
                                <input type="time" id="presentation-time" style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 5px;">
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button id="step2-back" class="btn" style="background: #6c757d; margin-right: 10px;">← Atrás</button>
                            <button id="step2-next" class="btn btn-primary">Continuar →</button>
                        </div>
                    </div>

                    <!-- Paso 3: Formación Táctica -->
                    <div id="step3" class="formation-step" style="display: none;">
                        <h3 style="color: #2a5298; margin-bottom: 15px;">🏑 3. Formación Táctica</h3>
                        
                        <!-- Controles de la cancha -->
                        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
                            <button id="formation-1-4-3-3" class="formation-preset-btn btn" style="background: #28a745;">1-4-3-3</button>
                            <button id="formation-1-3-4-3" class="formation-preset-btn btn" style="background: #28a745;">1-3-4-3</button>
                            <button id="formation-1-4-4-2" class="formation-preset-btn btn" style="background: #28a745;">1-4-4-2</button>
                            <button id="clear-formation" class="btn btn-danger">🔄 Limpiar</button>
                        </div>

                        <!-- Campo de hockey mobile-friendly -->
                        <div id="formations-layout" style="display: flex; gap: 20px; align-items: flex-start;">
                            
                            <!-- Campo de hockey 3D -->
                            <div class="container" style="perspective: 1200px; width: 100%; max-width: 800px; flex: 1; min-width: 0;">
                                <div class="field-wrapper" id="fieldWrapper" style="width: 100%; transform-style: preserve-3d; transform: rotateX(45deg) rotateZ(0deg); transition: transform 0.3s ease;">
                                    <div id="hockey-field" class="field" style="width: 100%; height: 550px; position: relative; background: #2a7f3e; border: 4px solid #ffffff; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3); overflow: hidden;">
                                        
                                        <!-- Textura del césped -->
                                        <div class="grass-texture" style="position: absolute; width: 100%; height: 100%; opacity: 0.3; background-image: repeating-linear-gradient(90deg, transparent, transparent 10px, rgba(0, 0, 0, 0.03) 10px, rgba(0, 0, 0, 0.03) 20px);"></div>
                                        
                                        <!-- Líneas del campo -->
                                        <div class="field-lines" style="position: absolute; width: 100%; height: 100%;">
                                            <!-- Línea central -->
                                            <div class="center-line" style="position: absolute; top: 50%; left: 0; right: 0; height: 3px; background: white; transform: translateY(-50%);"></div>
                                            
                                            <!-- Líneas de cuarto -->
                                            <div class="quarter-line top" style="position: absolute; top: 25%; left: 0; right: 0; height: 3px; background: white;"></div>
                                            <div class="quarter-line bottom" style="position: absolute; bottom: 25%; left: 0; right: 0; height: 3px; background: white;"></div>
                                            
                                            <!-- Círculo central -->
                                            <div class="center-circle" style="position: absolute; top: 50%; left: 50%; width: 120px; height: 120px; border: 3px solid white; border-radius: 50%; transform: translate(-50%, -50%);"></div>
                                            <div class="center-dot" style="position: absolute; top: 50%; left: 50%; width: 8px; height: 8px; background: white; border-radius: 50%; transform: translate(-50%, -50%);"></div>
                                            
                                            <!-- Áreas de gol -->
                                            <div class="goal-area top" style="position: absolute; top: 0; left: 50%; width: 300px; height: 120px; transform: translateX(-50%); border: 3px solid white; border-top: none; border-radius: 0 0 150px 150px;"></div>
                                            <div class="goal-area bottom" style="position: absolute; bottom: 0; left: 50%; width: 300px; height: 120px; transform: translateX(-50%); border: 3px solid white; border-bottom: none; border-radius: 150px 150px 0 0;"></div>
                                            
                                            <!-- Porterías -->
                                            <div class="goal top" style="position: absolute; top: -25px; left: 50%; width: 120px; height: 25px; background: linear-gradient(to bottom, #f0f0f0, #ffffff); transform: translateX(-50%); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);"></div>
                                            <div class="goal bottom" style="position: absolute; bottom: -25px; left: 50%; width: 120px; height: 25px; background: linear-gradient(to top, #f0f0f0, #ffffff); transform: translateX(-50%); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);"></div>
                                            
                                            <!-- Puntos de penalti -->
                                            <div class="penalty-spot top" style="position: absolute; top: 80px; width: 8px; height: 8px; background: white; border-radius: 50%; left: 50%; transform: translateX(-50%);"></div>
                                            <div class="penalty-spot bottom" style="position: absolute; bottom: 80px; width: 8px; height: 8px; background: white; border-radius: 50%; left: 50%; transform: translateX(-50%);"></div>
                                        </div>
                                        
                                        <!-- Posiciones de jugadoras -->
                                        <div id="field-positions" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                                            <!-- Las posiciones se generan dinámicamente -->
                                        </div>
                                        
                                        <!-- Sombras laterales para profundidad -->
                                        <div style="content: ''; position: absolute; top: 0; width: 100%; height: 20px; background: linear-gradient(to bottom, rgba(0, 0, 0, 0.2), transparent);"></div>
                                        <div style="content: ''; position: absolute; bottom: 0; width: 100%; height: 20px; background: linear-gradient(to top, rgba(0, 0, 0, 0.2), transparent);"></div>
                                    </div>
                                </div>
                                
                                <!-- Controles del campo 3D -->
                                <!-- <div class="controls" style="margin-top: 20px; text-align: center;">
                                    <button onclick="rotateField('left')" style="background: #2a7f3e; color: white; border: none; padding: 8px 15px; margin: 0 3px; border-radius: 5px; cursor: pointer; font-size: 14px;">⬅ Rotar Izq</button>
                                    <button onclick="rotateField('reset')" style="background: #2a7f3e; color: white; border: none; padding: 8px 15px; margin: 0 3px; border-radius: 5px; cursor: pointer; font-size: 14px;">🔄 Reset</button>
                                    <button onclick="rotateField('right')" style="background: #2a7f3e; color: white; border: none; padding: 8px 15px; margin: 0 3px; border-radius: 5px; cursor: pointer; font-size: 14px;">Rotar Der ➡</button>
                                </div> -->
                            </div>

                            <!-- Panel lateral: Lista de jugadoras disponibles -->
                            <div class="formation-sidebar" style="background: #f8f9fa; border-radius: 10px; padding: 15px; width: 300px; height: fit-content; flex-shrink: 0;">
                                <h4 style="margin-bottom: 15px; text-align: center; font-size: 1rem; color: #1e3c72;">🏃‍♀️ Jugadoras Disponibles</h4>
                                <div id="available-players-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                                    <div style="text-align: center; color: #666; padding: 20px; font-size: 0.9rem;">
                                        Selecciona un equipo para ver las jugadoras
                                    </div>
                                </div>
                                
                                <!-- Panel de suplentes integrado -->
                                <div style="margin-top: 20px;">
                                    <h5 style="margin-bottom: 10px; text-align: center; font-size: 0.9rem; color: #1e3c72;">👥 Suplentes</h5>
                                    <div id="substitutes-area" style="border: 2px dashed #dee2e6; border-radius: 8px; padding: 10px; min-height: 100px; background: white; margin-bottom: 10px; position: relative;">
                                        <div style="text-align: center; color: #666; padding: 10px; font-size: 0.8rem; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none;">
                                            Click en suplentes para volver a disponibles
                                        </div>
                                    </div>
                                    <div style="text-align: center; margin-bottom: 15px; color: #666; font-size: 0.8rem;">
                                        <span id="substitutes-count">0</span>/9 suplentes
                                    </div>
                                </div>

                                <!-- Estadísticas de formación -->
                                <div style="background: white; border-radius: 8px; padding: 12px;">
                                    <h5 style="margin-bottom: 8px; color: #1e3c72; font-size: 0.9rem;">📊 Estadísticas</h5>
                                    <div style="display: grid; grid-template-columns: 1fr; gap: 3px; font-size: 0.8rem;">
                                        <div>Arqueras: <span id="goalkeepers-count">0</span></div>
                                        <div>Defensoras: <span id="defenders-count">0</span></div>
                                        <div>Mediocampistas: <span id="midfielders-count">0</span></div>
                                        <div>Delanteras: <span id="forwards-count">0</span></div>
                                        <div style="border-top: 1px solid #eee; padding-top: 5px; margin-top: 5px; font-weight: bold;">
                                            Total en campo: <span id="total-on-field">0</span>/11
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; text-align: center;">
                            <button id="step3-back" class="btn" style="background: #6c757d; margin-right: 10px;">← Atrás</button>
                            <button id="step3-save" class="btn btn-success">💾 Guardar Formación</button>
                            <button id="step3-export" class="btn" style="background: #17a2b8; margin-left: 10px;">📸 Exportar Imagen</button>
                        </div>
                    </div>
                </div>

                <!-- Formaciones guardadas -->
                <div id="saved-formations" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #1e3c72; margin-bottom: 15px;">📂 Formaciones Guardadas</h3>
                    <div id="formations-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                        <div style="text-align: center; color: #666; padding: 40px; grid-column: 1/-1;">
                            <div style="font-size: 3em; margin-bottom: 15px;">🏑</div>
                            <p>No hay formaciones guardadas</p>
                            <p style="font-size: 14px; color: #999;">Crea tu primera formación usando el asistente de arriba</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Partidos -->
        <div id="matches-tab" class="tab-content">
            <div class="coming-soon">
                <div class="icon">🏑</div>
                <h3>Gestión de Partidos</h3>
                <p>Funcionalidades avanzadas de registro de partidos en desarrollo.</p>
                <p>Incluirá capacidades offline, control de tiempos y registro de acciones en tiempo real.</p>
            </div>
        </div>

        <!-- Tab: Reportes -->
        <div id="reports-tab" class="tab-content">
            <div style="max-width: 1400px; margin: 0 auto; padding: 20px;">
                <h2>📈 Reportes de Asistencia - Sistema Completo</h2>
                
                <!-- Filtros Globales -->
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h3 style="margin: 0 0 20px 0; color: #2c5aa0;">🔍 Filtros de Consulta</h3>
                    <div class="filter-controls">
                        <div class="form-group">
                            <label>Equipo:</label>
                            <select id="reports-team-filter">
                                <option value="">Todos los equipos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Desde:</label>
                            <input type="date" id="reports-date-from">
                        </div>
                        <div class="form-group">
                            <label>Hasta:</label>
                            <input type="date" id="reports-date-to">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="applyReportFilters()" style="width: 100%;">
                                🔍 Aplicar Filtros
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Dashboard Principal -->
                <div id="reports-dashboard" style="display: grid; gap: 20px; margin-bottom: 25px;">
                    <!-- Indicadores Clave -->
                    <div class="kpis-container">
                        <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold;" id="kpi-total-players">0</div>
                            <div>Total Jugadores</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold;" id="kpi-total-sessions">0</div>
                            <div>Entrenamientos</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fd7e14, #e55a4e); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold;" id="kpi-avg-attendance">0%</div>
                            <div>Asistencia Promedio</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #6610f2, #e83e8c); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold;" id="kpi-punctuality">0%</div>
                            <div>Puntualidad Promedio</div>
                        </div>
                    </div>
                </div>
                
                <!-- Menú de Reportes -->
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h3 style="margin: 0 0 20px 0; color: #2c5aa0;">📊 Tipos de Reportes Disponibles</h3>
                    <div class="reports-grid">
                        
                        <!-- Reporte 1: General de Asistencias -->
                        <div class="report-card" style="border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; transition: all 0.3s;">
                            <h4 style="margin: 0 0 10px 0; color: #28a745;">📋 1. Reporte General</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Listado completo con porcentajes de asistencia, ranking y estadísticas generales</p>
                            <button class="btn btn-success" onclick="generateGeneralReport()" style="width: 100%;">
                                Ver Reporte General
                            </button>
                        </div>
                        
                        <!-- Reporte 2: Comparativo por Equipo -->
                        <div class="report-card" style="border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; transition: all 0.3s;">
                            <h4 style="margin: 0 0 10px 0; color: #007bff;">📊 2. Comparativo Equipos</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Comparación de asistencia entre diferentes equipos y categorías</p>
                            <button class="btn btn-primary" onclick="generateComparativeReport()" style="width: 100%;">
                                Ver Comparativo
                            </button>
                        </div>
                        
                        <!-- Reporte 3: Tendencias -->
                        <div class="report-card" style="border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; transition: all 0.3s;">
                            <h4 style="margin: 0 0 10px 0; color: #fd7e14;">📈 3. Tendencias y Evolución</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Evolución temporal de asistencia con gráficos de líneas</p>
                            <button class="btn btn-warning" onclick="generateTrendsReport()" style="width: 100%;">
                                Ver Tendencias
                            </button>
                        </div>
                        
                        <!-- Reporte 4: Justificaciones -->
                        <div class="report-card" style="border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; transition: all 0.3s;">
                            <h4 style="margin: 0 0 10px 0; color: #6c757d;">📝 4. Justificaciones</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Análisis de ausencias justificadas vs injustificadas</p>
                            <button class="btn btn-secondary" onclick="generateJustificationsReport()" style="width: 100%;">
                                Ver Justificaciones
                            </button>
                        </div>
                        
                        <!-- Reporte 5: Puntualidad -->
                        <div class="report-card" style="border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; transition: all 0.3s;">
                            <h4 style="margin: 0 0 10px 0; color: #17a2b8;">⏰ 5. Puntualidad</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Análisis detallado de puntualidad y llegadas tarde</p>
                            <button class="btn btn-info" onclick="generatePunctualityReport()" style="width: 100%;">
                                Ver Puntualidad
                            </button>
                        </div>
                        
                        <!-- Reporte 7: Ficha Individual -->
                        <div class="report-card" style="border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; transition: all 0.3s;">
                            <h4 style="margin: 0 0 10px 0; color: #6f42c1;">👤 7. Ficha Individual</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Reporte personalizado por jugador con historial completo</p>
                            <button class="btn btn-purple" onclick="generateIndividualReport()" style="width: 100%; background: #6f42c1; color: white;">
                                Ver Ficha Individual
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Contenedor de Reportes -->
                <div id="reports-content" style="min-height: 200px;">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">📊</div>
                        <h3>Sistema de Reportes de Asistencia</h3>
                        <p>Selecciona los filtros deseados y luego elige el tipo de reporte que necesitas generar</p>
                        <p><strong>Consejo:</strong> Para mejores resultados, aplica primero los filtros de equipo y fechas</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get JWT token from localStorage
        function getAuthHeaders() {
            const token = localStorage.getItem('hockey_token');
            if (!token) {
                console.log('No token in getAuthHeaders, redirecting...');
                window.location.href = 'login.html';
                return {};
            }
            
            console.log('Using token in headers:', token.substring(0, 20) + '...');
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }
        
        // Handle authentication errors
        function handleAuthError(error, response = null) {
            if (response && response.status === 401) {
                console.log('Token expired or invalid, redirecting to login');
                showMessage('Sesión expirada. Por favor, inicia sesión nuevamente.', 'error');
                localStorage.removeItem('hockey_token');
                localStorage.removeItem('hockey_user');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            console.error('Auth error:', error);
        }
        
        // Check if user is coach on page load
        async function checkCoachAccess() {
            const token = localStorage.getItem('hockey_token');
            if (!token) {
                console.log('No token found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            console.log('Token found, checking profile...');
            
            try {
                const response = await fetch('/api/profile', {
                    headers: getAuthHeaders()
                });
                
                console.log('Profile response status:', response.status);
                
                // Handle 401 specifically
                if (response.status === 401) {
                    console.log('401 Unauthorized - Token expired or invalid, clearing localStorage');
                    localStorage.removeItem('hockey_token');
                    localStorage.removeItem('hockey_user');
                    showMessage('Tu sesión ha expirado. Por favor, inicia sesión nuevamente.', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                const data = await response.json();
                console.log('Profile data:', data);
                
                if (!data.success) {
                    throw new Error('Token inválido');
                }
                
                if (data.data.role === 'admin') {
                    // Redirigir admin al panel de admin
                    window.location.href = 'admin.html';
                    return;
                }
                
                if (data.data.role !== 'coach') {
                    alert('Acceso denegado. Solo entrenadores.');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Mostrar información del usuario
                document.getElementById('user-name').textContent = 
                    `${data.data.firstName} ${data.data.lastName} (Entrenador)`;
                
                // Cargar estadísticas básicas
                loadDashboardStats();
                
            } catch (error) {
                console.error('Error checking coach access:', error);
                localStorage.removeItem('hockey_token');
                localStorage.removeItem('hockey_user');
                window.location.href = 'login.html';
            }
        }
        
        // Load dashboard statistics
        async function loadDashboardStats() {
            console.log('🚀 Cargando estadísticas del dashboard');
            
            // Verificar que los elementos DOM existen
            const totalTeamsElement = document.getElementById('total-teams');
            const totalPlayersElement = document.getElementById('total-players');
            
            if (!totalTeamsElement || !totalPlayersElement) {
                console.error('❌ Elementos DOM no encontrados:', {
                    totalTeams: !!totalTeamsElement,
                    totalPlayers: !!totalPlayersElement
                });
                setTimeout(() => loadDashboardStats(), 1000); // Reintentar en 1 segundo
                return;
            }
            
            try {
                // Run database migration for image fields (one-time)
                if (!sessionStorage.getItem('migration_images_done')) {
                    try {
                        const migrationResponse = await fetch('/api/admin/migrate-images', {
                            method: 'POST'
                        });
                        const migrationResult = await migrationResponse.json();
                        console.log('🔧 Image migration result:', migrationResult);
                        sessionStorage.setItem('migration_images_done', 'true');
                    } catch (error) {
                        console.log('🔧 Migration not needed or already done:', error);
                    }
                }
                
                // Cargar información del usuario para obtener max_teams
                const userResponse = await fetch('/api/profile', {
                    headers: getAuthHeaders()
                });
                
                // Handle 401 specifically
                if (userResponse.status === 401) {
                    console.log('401 in loadDashboardStats - redirecting to login');
                    localStorage.removeItem('hockey_token');
                    localStorage.removeItem('hockey_user');
                    window.location.href = 'login.html';
                    return;
                }
                
                const userData = await userResponse.json();
                
                console.log('=== USER DATA DEBUG ===');
                console.log('User response:', userData);
                console.log('Max teams from API:', userData.data ? userData.data.maxTeams : 'No data');
                
                if (userData.success) {
                    const maxTeams = userData.data.maxTeams !== undefined ? userData.data.maxTeams : 0;
                    const maxTeamsDisplay = document.getElementById('max-teams-display');
                    if (maxTeamsDisplay) {
                        maxTeamsDisplay.textContent = maxTeams;
                    }
                    console.log('Setting max teams display to:', maxTeams);
                }

                // Cargar equipos del entrenador
                console.log('🔍 Cargando equipos del entrenador...');
                const teamsResponse = await fetch('/api/teams', {
                    headers: getAuthHeaders()
                });
                
                console.log('📊 Teams response status:', teamsResponse.status);
                
                // Handle 401 for teams request too
                if (teamsResponse.status === 401) {
                    console.log('401 in teams request - redirecting to login');
                    localStorage.removeItem('hockey_token');
                    localStorage.removeItem('hockey_user');
                    window.location.href = 'login.html';
                    return;
                }
                
                const teamsData = await teamsResponse.json();
                
                console.log('=== TEAMS DATA DEBUG ===');
                console.log('Teams response:', teamsData);
                console.log('Teams array:', teamsData.teams);
                console.log('Teams count:', teamsData.teams ? teamsData.teams.length : 'No teams array');
                
                if (teamsData.success && teamsData.teams) {
                    const currentTeams = teamsData.teams.length;
                    totalTeamsElement.textContent = currentTeams;
                    console.log('✅ Current teams count set to:', currentTeams);
                    
                    // Calcular total de jugadores usando el player_count que viene de /api/teams
                    let totalPlayers = 0;
                    teamsData.teams.forEach(team => {
                        const teamPlayerCount = team.player_count || 0;
                        console.log(`📊 Equipo ${team.name}: ${teamPlayerCount} jugadores`);
                        totalPlayers += teamPlayerCount;
                    });
                    
                    totalPlayersElement.textContent = totalPlayers;
                    console.log('✅ Total players count final:', totalPlayers);
                    
                    // También actualizar el KPI de total players si existe
                    const kpiTotalPlayers = document.getElementById('kpi-total-players');
                    if (kpiTotalPlayers) {
                        kpiTotalPlayers.textContent = totalPlayers;
                        console.log('✅ KPI total players updated:', totalPlayers);
                    }
                } else {
                    console.error('❌ No se pudieron cargar los equipos:', teamsData);
                    totalTeamsElement.textContent = '0';
                    totalPlayersElement.textContent = '0';
                }
                
            } catch (error) {
                console.error('❌ Error loading dashboard stats:', error);
                // Valores por defecto en caso de error
                document.getElementById('total-teams').textContent = '0';
                document.getElementById('total-players').textContent = '0';
            }
            
            // Por ahora, valores mock para las otras estadísticas
            const upcomingMatches = document.getElementById('upcoming-matches');
            const formationsCreated = document.getElementById('formations-created');
            if (upcomingMatches) upcomingMatches.textContent = '0';
            if (formationsCreated) formationsCreated.textContent = '0';
        }
        
        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load tab-specific content
            switch(tabName) {
                case 'teams':
                    loadTeams();
                    break;
                case 'attendance':
                    loadAttendance();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'formations':
                    setTimeout(() => {
                        initFormationsModule();
                    }, 100);
                    break;
                case 'matches':
                    // TODO: loadMatches();
                    break;
            }
        }
        
        // Logout functionality
        function logout() {
            localStorage.removeItem('hockey_token');
            localStorage.removeItem('hockey_user');
            window.location.href = 'login.html';
        }
        
        // Show message
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = `message ${type}`;
            msgDiv.style.display = 'block';
            
            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 5000);
        }

        // =================== TEAMS MANAGEMENT ===================
        
        // Load teams for the coach
        async function loadTeams() {
            const container = document.getElementById('teams-list');
            container.innerHTML = '<div class="loading">Cargando equipos...</div>';
            
            try {
                const response = await fetch('/api/teams', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    const teamsGridHtml = await generateTeamsGrid(data.teams);
                    container.innerHTML = teamsGridHtml;
                } else {
                    container.innerHTML = `<div class="message error">Error: ${data.message || data.error}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="message error">Error de conexión: ${error.message}</div>`;
            }
        }

        // Generate teams grid HTML
        async function generateTeamsGrid(teams) {
            if (teams.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3em; margin-bottom: 20px;">�</div>
                        <h3>No tienes equipos creados</h3>
                        <p>Crea tu primer equipo para comenzar a gestionar jugadoras</p>
                        <button class="btn btn-primary" onclick="showCreateTeamModal()" style="margin-top: 20px;">
                            ➕ Crear Mi Primer Equipo
                        </button>
                    </div>
                `;
            }

            let html = '<div class="teams-grid">';
            
            for (const team of teams) {
                // Obtener el conteo de jugadores para cada equipo
                const playerCount = await getPlayerCountForTeam(team.id);
                const genderText = team.team_gender === 'female' ? 'jugadoras' : 'jugadores';
                
                html += `
                    <div class="team-card">
                        <h3>${team.name}</h3>
                        <div class="team-info">
                            <span class="team-badge division">${team.club_name || 'Sin club'}</span>
                            ${team.max_players ? `<span class="team-badge category">Max: ${team.max_players} ${genderText}</span>` : ''}
                        </div>
                        <div class="team-actions">
                            <button class="btn btn-sm btn-info" onclick="viewTeamPlayers('${team.id}', '${team.name}', '${team.team_gender || 'male'}')" title="Ver ${genderText}">
                                👥 ${team.team_gender === 'female' ? 'Jugadoras' : 'Jugadores'} (${playerCount})
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="editTeam('${team.id}')" title="Editar equipo">
                                ✏️ Editar
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTeam('${team.id}', '${team.name}', ${playerCount})" title="Eliminar equipo">
                                🗑️ Eliminar
                            </button>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        // Get player count for a specific team
        async function getPlayerCountForTeam(teamId) {
            try {
                const response = await fetch(`/api/players?team_id=${teamId}`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    return data.players.length;
                } else {
                    return 0;
                }
            } catch (error) {
                console.error('Error getting player count:', error);
                return 0;
            }
        }

        // Show create team modal
        async function showCreateTeamModal() {
            document.getElementById('modal-title').textContent = 'Crear Nuevo Equipo';
            document.getElementById('team-form').reset();
            
            // Reset image previews
            document.getElementById('team-jersey-preview').style.display = 'none';
            
            // Resetear el select de divisiones
            const divisionSelect = document.getElementById('team-division');
            divisionSelect.innerHTML = '<option value="">Primero selecciona el género...</option>';
            
            // Setup image preview
            setupImagePreview('team-jersey-photo', 'team-jersey-preview', 'team-jersey-img');
            
            // Verificar token antes de abrir el modal
            const token = localStorage.getItem('hockey_token');
            if (!token) {
                showMessage('Sesión expirada. Por favor, inicia sesión nuevamente.', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            // Verificar que el token sea válido y obtener límites de equipos
            try {
                const response = await fetch('/api/profile', {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    showMessage('Sesión expirada. Por favor, inicia sesión nuevamente.', 'error');
                    setTimeout(() => {
                        localStorage.removeItem('hockey_token');
                        localStorage.removeItem('hockey_user');
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                const userData = await response.json();
                if (userData.success) {
                    const maxTeams = userData.data.maxTeams !== undefined ? userData.data.maxTeams : 2;
                    
                    console.log('=== TEAM LIMITS CHECK ===');
                    console.log('Max teams allowed:', maxTeams);
                    
                    // Si el usuario tiene 0 equipos permitidos, no puede crear ningún equipo
                    if (maxTeams === 0) {
                        showMessage('No tienes permisos para crear equipos. Contacta al administrador para solicitar acceso.', 'warning');
                        return;
                    }
                    
                    // Verificar equipos actuales
                    const teamsResponse = await fetch('/api/teams', {
                        headers: getAuthHeaders()
                    });
                    const teamsData = await teamsResponse.json();
                    
                    if (teamsData.success) {
                        const currentTeams = teamsData.teams.length;
                        
                        console.log('Current teams:', currentTeams);
                        console.log('Can create more:', currentTeams < maxTeams);
                        
                        if (currentTeams >= maxTeams) {
                            showMessage(`Has alcanzado el límite máximo de ${maxTeams} equipos. Para crear más equipos, solicita al administrador que amplíe tu límite de equipos.`, 'warning');
                            return;
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error verifying token:', error);
            }
            
            document.getElementById('team-modal').style.display = 'block';
        }

        // Load available divisions
        async function loadDivisions() {
            const divisionSelect = document.getElementById('team-division');
            
            // Mostrar loading
            divisionSelect.innerHTML = '<option value="">Cargando divisiones...</option>';
            
            try {
                const response = await fetch('/api/divisions', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    // Limpiar select
                    divisionSelect.innerHTML = '<option value="">Seleccionar división (opcional)...</option>';
                    
                    // Agregar divisiones
                    data.divisions.forEach(division => {
                        const option = document.createElement('option');
                        option.value = division.id;
                        option.textContent = division.name;
                        divisionSelect.appendChild(option);
                    });
                } else {
                    divisionSelect.innerHTML = '<option value="">Error cargando divisiones</option>';
                    console.error('Error loading divisions:', data.message);
                }
            } catch (error) {
                divisionSelect.innerHTML = '<option value="">Error de conexión</option>';
                console.error('Error fetching divisions:', error);
            }
        }

        // Load divisions filtered by gender
        async function loadDivisionsForGender(gender) {
            const divisionSelect = document.getElementById('team-division');
            
            if (!gender) {
                divisionSelect.innerHTML = '<option value="">Primero selecciona el género...</option>';
                return;
            }
            
            // Mostrar loading
            divisionSelect.innerHTML = '<option value="">Cargando divisiones...</option>';
            
            try {
                const response = await fetch(`/api/divisions?gender=${encodeURIComponent(gender)}`, {
                    headers: getAuthHeaders()
                });
                
                console.log(`Loading divisions for gender: ${gender}`);
                console.log('Response status:', response.status);
                
                // Manejar error de autenticación
                if (response.status === 401) {
                    handleAuthError(new Error('Unauthorized'), response);
                    return;
                }
                
                const data = await response.json();
                console.log('Divisions data:', data);
                
                if (data.success) {
                    // Limpiar select
                    divisionSelect.innerHTML = '<option value="">Seleccionar división (opcional)...</option>';
                    
                    // Verificar que hay divisiones para el género seleccionado
                    if (data.divisions && data.divisions.length > 0) {
                        data.divisions.forEach(division => {
                            const option = document.createElement('option');
                            option.value = division.id;
                            option.textContent = `${division.name} (${division.gender === 'male' ? 'Masculino' : 'Femenino'})`;
                            divisionSelect.appendChild(option);
                        });
                    } else {
                        divisionSelect.innerHTML = `<option value="">No hay divisiones para ${gender === 'male' ? 'masculino' : 'femenino'}</option>`;
                    }
                } else {
                    divisionSelect.innerHTML = '<option value="">Error cargando divisiones</option>';
                    console.error('Error loading divisions:', data.message);
                }
            } catch (error) {
                divisionSelect.innerHTML = '<option value="">Error de conexión</option>';
                console.error('Error fetching divisions:', error);
            }
        }

        // Close team modal
        function closeTeamModal() {
            document.getElementById('team-modal').style.display = 'none';
            // Reset form for next use
            document.getElementById('team-form').reset();
            document.getElementById('modal-title').textContent = 'Crear Nuevo Equipo';
            document.getElementById('team-form').setAttribute('data-mode', 'create');
            document.getElementById('team-form').removeAttribute('data-team-id');
        }

        // Edit team function
        async function editTeam(teamId) {
            try {
                // Fetch team data
                const response = await fetch(`/api/teams`, {
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                if (!data.success) {
                    showMessage('Error al cargar datos del equipo', 'error');
                    return;
                }
                
                // Find the team
                const team = data.teams.find(t => t.id === teamId);
                if (!team) {
                    showMessage('Equipo no encontrado', 'error');
                    return;
                }
                
                // Fill form with team data
                document.getElementById('team-name').value = team.name || '';
                document.getElementById('club-name').value = team.club_name || '';
                document.getElementById('team-gender').value = team.team_gender || '';
                document.getElementById('max-players').value = team.max_players || 20;
                
                // Load divisions for the gender
                if (team.team_gender) {
                    await loadDivisionsForGender(team.team_gender);
                    if (team.division_id) {
                        document.getElementById('team-division').value = team.division_id;
                    }
                }
                
                // Handle team jersey photo
                const jerseyPreview = document.getElementById('team-jersey-preview');
                const jerseyImg = document.getElementById('team-jersey-img');
                
                if (team.team_jersey_photo) {
                    jerseyImg.src = team.team_jersey_photo;
                    jerseyPreview.style.display = 'block';
                    console.log('Loaded team jersey photo for edit');
                } else {
                    jerseyPreview.style.display = 'none';
                    console.log('No team jersey photo found');
                }
                
                // Setup image preview for new uploads
                setupImagePreview('team-jersey-photo', 'team-jersey-preview', 'team-jersey-img');
                
                // Change modal to edit mode
                document.getElementById('modal-title').textContent = 'Editar Equipo';
                document.getElementById('team-form').setAttribute('data-mode', 'edit');
                document.getElementById('team-form').setAttribute('data-team-id', teamId);
                
                // Show modal
                document.getElementById('team-modal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading team for edit:', error);
                showMessage('Error al cargar datos del equipo', 'error');
            }
        }

        // Delete team function
        async function deleteTeam(teamId, teamName, playerCount) {
            if (playerCount > 0) {
                showMessage(`No puedes eliminar el equipo "${teamName}" porque tiene ${playerCount} jugador(es). Primero elimina o transfiere todos los jugadores.`, 'warning');
                return;
            }
            
            const confirmed = confirm(`¿Estás seguro de que quieres eliminar el equipo "${teamName}"?`);
            if (!confirmed) return;
            
            try {
                const response = await fetch(`/api/teams/${teamId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('Equipo eliminado exitosamente', 'success');
                    loadTeams(); // Reload teams list
                    loadDashboardStats(); // Update stats
                } else {
                    showMessage(data.message || 'Error al eliminar equipo', 'error');
                }
            } catch (error) {
                console.error('Error deleting team:', error);
                showMessage('Error de conexión al eliminar equipo', 'error');
            }
        }

        // Handle team form submission
        document.addEventListener('DOMContentLoaded', function() {
            const teamForm = document.getElementById('team-form');
            if (teamForm) {
                teamForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    const teamData = Object.fromEntries(formData.entries());
                    
                    // Handle team jersey photo
                    const jerseyPhotoInput = document.getElementById('team-jersey-photo');
                    if (jerseyPhotoInput && jerseyPhotoInput.files[0]) {
                        try {
                            const jerseyPhotoBase64 = await convertImageToBase64(jerseyPhotoInput.files[0]);
                            teamData.team_jersey_photo = jerseyPhotoBase64;
                        } catch (error) {
                            console.error('Error converting team jersey photo:', error);
                            showMessage('Error procesando la imagen de la camiseta', 'error');
                            return;
                        }
                    }
                    
                    // Check if we're editing or creating
                    const mode = this.getAttribute('data-mode') || 'create';
                    const teamId = this.getAttribute('data-team-id');
                    
                    try {
                        console.log('Sending team data:', teamData, 'Mode:', mode);
                        
                        const url = mode === 'edit' ? `/api/teams/${teamId}` : '/api/teams';
                        const method = mode === 'edit' ? 'PUT' : 'POST';
                        
                        const response = await fetch(url, {
                            method: method,
                            headers: getAuthHeaders(),
                            body: JSON.stringify(teamData)
                        });
                        
                        console.log('Response status:', response.status);
                        
                        // Manejar error de autenticación
                        if (response.status === 401) {
                            handleAuthError(new Error('Unauthorized'), response);
                            return;
                        }
                        
                        // Manejar error de límite de equipos
                        if (response.status === 403) {
                            const data = await response.json();
                            showMessage(data.message || 'No tienes permisos para crear más equipos', 'warning');
                            return;
                        }
                        
                        const data = await response.json();
                        console.log('Response data:', data);
                        
                        if (data.success) {
                            const successMessage = mode === 'edit' ? 'Equipo actualizado exitosamente' : 'Equipo creado exitosamente';
                            showMessage(successMessage, 'success');
                            closeTeamModal();
                            loadTeams(); // Recargar la lista
                            loadDashboardStats(); // Actualizar estadísticas
                        } else {
                            // Mensaje específico para límites
                            const message = data.message || data.error;
                            const messageType = message.includes('límite') || message.includes('solicita') ? 'warning' : 'error';
                            showMessage(`${message}`, messageType);
                        }
                    } catch (error) {
                        console.error('Error in team operation:', error);
                        showMessage(`Error de conexión: ${error.message}`, 'error');
                    }
                });
            }

            // Handle player form submission
            const playerForm = document.getElementById('player-form');
            if (playerForm) {
                playerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    if (!window.currentTeamId) {
                        showMessage('Error: No hay equipo seleccionado', 'error');
                        return;
                    }
                    
                    const formData = new FormData(this);
                    
                    // Construir playerData manualmente para evitar campos vacíos
                    const playerData = {
                        teamId: window.currentTeamId,
                        name: formData.get('name') || '',
                        nickname: formData.get('nickname') || '',
                        birth_date: formData.get('birth_date') || '',
                        position: formData.get('position') || '',
                        jersey_number: formData.get('jersey_number') || ''
                    };
                    
                    // Handle player photo
                    const playerPhotoInput = document.getElementById('player-photo');
                    if (playerPhotoInput && playerPhotoInput.files && playerPhotoInput.files.length > 0) {
                        try {
                            const playerPhotoBase64 = await convertImageToBase64(playerPhotoInput.files[0]);
                            if (playerPhotoBase64 && playerPhotoBase64.trim().length > 0) {
                                playerData.player_photo = playerPhotoBase64;
                            }
                        } catch (error) {
                            console.error('Error converting player photo:', error);
                            showMessage('Error procesando la imagen del jugador', 'error');
                            return;
                        }
                    }
                    // No agregar player_photo si no hay imagen válida
                    
                    console.log('📤 Sending player data:', playerData);
                    
                    try {
                        let response;
                        let successMessage;
                        
                        if (window.editingPlayerId) {
                            // Update existing player
                            response = await fetch(`/api/players/${window.editingPlayerId}`, {
                                method: 'PUT',
                                headers: getAuthHeaders(),
                                body: JSON.stringify(playerData)
                            });
                            successMessage = 'Jugador actualizado exitosamente';
                        } else {
                            // Create new player
                            response = await fetch('/api/players', {
                                method: 'POST',
                                headers: getAuthHeaders(),
                                body: JSON.stringify(playerData)
                            });
                            successMessage = 'Jugador agregado exitosamente';
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showMessage(successMessage, 'success');
                            closePlayerModal();
                            loadPlayersForTeam(window.currentTeamId, window.currentTeamName, window.currentTeamGender);
                        } else {
                            showMessage(`Error: ${data.message || data.error}`, 'error');
                        }
                    } catch (error) {
                        showMessage(`Error de conexión: ${error.message}`, 'error');
                    }
                });
            }
        });

        // View team players
        function viewTeamPlayers(teamId, teamName, teamGender) {
            // Cambiar a la pestaña de jugadores
            showTab('players');
            
            // Cargar jugadores del equipo
            loadPlayersForTeam(teamId, teamName, teamGender);
        }

        // Load players for specific team
        async function loadPlayersForTeam(teamId, teamName, teamGender = 'male') {
            const container = document.getElementById('players-list');
            const teamTitle = document.getElementById('current-team-name');
            const addPlayerBtnContainer = document.getElementById('add-player-btn');
            
            if (teamTitle) {
                const genderText = teamGender === 'female' ? 'Jugadoras' : 'Jugadores';
                teamTitle.textContent = `${genderText} de: ${teamName}`;
            }
            
            // Mostrar los botones de acción
            if (addPlayerBtnContainer) {
                addPlayerBtnContainer.style.display = 'block';
            }
            
            // Guardar el teamId actual para crear nuevos jugadores
            window.currentTeamId = teamId;
            window.currentTeamName = teamName;
            window.currentTeamGender = teamGender;
            
            // Obtener información del equipo para la foto de camiseta
            try {
                const teamResponse = await fetch(`/api/teams/${teamId}`, {
                    headers: getAuthHeaders()
                });
                
                if (teamResponse.ok) {
                    const teamData = await teamResponse.json();
                    console.log('🏆 Team data loaded:', teamData);
                    if (teamData.success) {
                        window.currentTeamJerseyPhoto = teamData.team?.team_jersey_photo || null;
                        window.currentTeamLogo = teamData.team?.logo || null;
                        console.log('🏆 Team jersey photo set:', window.currentTeamJerseyPhoto ? window.currentTeamJerseyPhoto.substring(0, 50) + '...' : 'null');
                    }
                }
            } catch (error) {
                console.warn('No se pudo obtener la información del equipo:', error);
                window.currentTeamJerseyPhoto = null;
                window.currentTeamLogo = null;
            }
            
            container.innerHTML = '<div class="loading">Cargando jugadores...</div>';
            
            try {
                const response = await fetch(`/api/players?team_id=${teamId}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError('Token expired', response);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    container.innerHTML = generatePlayersGrid(data.players, teamGender);
                } else {
                    container.innerHTML = `<div class="message error">Error: ${data.message || data.error}</div>`;
                }
            } catch (error) {
                console.error('Error loading players:', error);
                container.innerHTML = `<div class="message error">Error de conexión: ${error.message}</div>`;
            }
        }

        // Generate players grid HTML
        function generatePlayersGrid(players, teamGender = 'male') {
            const genderText = teamGender === 'female' ? 'jugadoras' : 'jugadores';
            const genderTextSingular = teamGender === 'female' ? 'Jugadora' : 'Jugador';
            
            if (players.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3em; margin-bottom: 20px;">🏃‍♀️</div>
                        <h3>No hay ${genderText} en este equipo</h3>
                        <p>Agrega ${genderText} para comenzar a gestionar el equipo</p>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="showCreatePlayerModal()" style="margin-right: 10px;">
                                ➕ Agregar Primer ${genderTextSingular}
                            </button>
                            <button class="btn btn-success" onclick="showExcelImportModal()">
                                📊 Importar Excel
                            </button>
                        </div>
                    </div>
                `;
            }

            let html = '<div class="players-list-compact" style="display: flex; flex-direction: column; gap: 6px;">';

            players.forEach(player => {
                html += `
                    <div class="player-list-item" style="display: flex; align-items: center; background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.07); padding: 8px 10px; min-width: 0;">
                        <div style="position: relative; margin-right: 12px;">
                            <div style="width: 38px; height: 38px; border-radius: 50%; overflow: hidden; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                                ${generatePlayerImageHTML(player, '38px', false)}
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 0; display: flex; flex-direction: column;">
                            <span style="font-weight: 700; font-size: 1rem; color: #222; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${player.nickname || '-'}</span>
                            <span style="font-size: 0.85rem; color: #666; font-weight: 500;">${player.position || 'Sin posición'}</span>
                        </div>
                        <div style="margin-left: 16px; font-size: 0.95rem; color: #007bff; font-weight: bold; min-width: 32px; text-align: right;">${player.jersey_number ? `#${player.jersey_number}` : ''}</div>
                        <div style="margin-left: 10px; display: flex; gap: 4px;">
                            <button class="btn btn-sm btn-warning" onclick="editPlayer('${player.id}', '${player.name}', '${player.nickname || ''}', '${player.birth_date && player.birth_date !== 'null' ? player.birth_date : ''}', '${player.position || ''}', '${player.jersey_number || ''}')" title="Editar jugador">✏️</button>
                            <button class="btn btn-sm btn-danger" onclick="removePlayerFromTeam('${player.id}', '${player.name}')" title="Eliminar del equipo">🗑️</button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            // Botón para agregar más jugadores
            html += `
                <div style="text-align: center; margin-top: 24px;">
                    <button class="btn btn-primary" onclick="showCreatePlayerModal()" style="margin-right: 10px;">
                        ➕ Agregar ${genderTextSingular}
                    </button>
                    <button class="btn btn-success" onclick="showExcelImportModal()">
                        📊 Importar Excel
                    </button>
                </div>
            `;

            return html;
        }

        // Show create player modal
        function showCreatePlayerModal() {
            console.log('showCreatePlayerModal called');
            console.log('currentTeamId:', window.currentTeamId);
            console.log('currentTeamGender:', window.currentTeamGender);
            
            if (!window.currentTeamId) {
                showMessage('Primero selecciona un equipo desde "Mis Equipos"', 'error');
                return;
            }
            
            // Reset form and set title for creating new player
            document.getElementById('player-modal-title').textContent = `Agregar Jugador a: ${window.currentTeamName}`;
            document.getElementById('player-form').reset();
            
            // Reset image previews
            document.getElementById('player-photo-preview').style.display = 'none';
            
            // Clear edit mode data
            delete window.editingPlayerId;
            
            loadPlayerPositions();
            
            // Setup image preview
            setupImagePreview('player-photo', 'player-photo-preview', 'player-photo-img');
            
            document.getElementById('player-modal').style.display = 'block';
        }

        // Edit existing player
        function editPlayer(playerId, name, nickname, birthDate, position, jerseyNumber) {
            console.log('editPlayer called with:', { playerId, name, nickname, birthDate, position, jerseyNumber });
            
            if (!window.currentTeamId) {
                showMessage('Error: No hay equipo seleccionado', 'error');
                return;
            }
            
            // Set modal title for editing
            document.getElementById('player-modal-title').textContent = `Editar Jugador: ${name}`;
            
            // Fill form with current player data - handle 'null' strings properly
            document.getElementById('player-name').value = name || '';
            document.getElementById('player-nickname').value = (nickname === 'null' || nickname === null || nickname === undefined) ? '' : nickname;
            
            // Handle birth date - ensure proper format for HTML input
            let formattedBirthDate = '';
            // if (birthDate && birthDate !== 'null' && birthDate !== null && birthDate !== undefined && birthDate.trim() !== '') {
            //     console.log('Raw birthDate received:', birthDate, typeof birthDate);
            //     // If date is in format YYYY-MM-DD (from database), keep it as is for input[type="date"]
            //     // If it's in another format, try to parse it
            //     if (birthDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
            //         formattedBirthDate = birthDate;
            //     } else {
            //         console.warn('Unexpected birthDate format:', birthDate);
            //         formattedBirthDate = birthDate;
            //     }
            // }
            //CODIGO CAMBIADO PARA VER SI MUESTRA LA FECHA DE NACIMIENTO
            //--------------------------------------------------------------
            if (birthDate && String(birthDate).trim() !== '') {
                const rawDate = String(birthDate).trim();
                console.log('Fecha de nacimiento recibida:', rawDate);
                
                // Intenta crear un objeto de fecha a partir de la cadena.
                const dateObj = new Date(rawDate);

                // Verifica si el objeto de fecha es válido.
                if (!isNaN(dateObj.getTime())) {
                    // Obtenemos los componentes de la fecha usando los métodos UTC para evitar el desfase de la zona horaria.
                    const year = dateObj.getUTCFullYear();
                    // Usamos `getUTCMonth()` y le sumamos 1.
                    const month = (dateObj.getUTCMonth() + 1).toString().padStart(2, '0');
                    // Usamos `getUTCDate()`.
                    const day = dateObj.getUTCDate().toString().padStart(2, '0');
                    
                    // Formateamos al formato YYYY-MM-DD para el campo input.
                    formattedBirthDate = `${year}-${month}-${day}`;
                    console.log('Fecha de nacimiento formateada:', formattedBirthDate);
                } else {
                    // Si la fecha no es válida, no se asigna nada.
                    console.warn('Formato de fecha de nacimiento inválido o no reconocido:', rawDate);
                    formattedBirthDate = '';
                }
            } else {
                formattedBirthDate = '';
            }
        //----------------------------------------------------------------------------
            document.getElementById('player-birth-date').value = formattedBirthDate;
            document.getElementById('player-jersey').value = (jerseyNumber === 'null' || jerseyNumber === '' || jerseyNumber === null || jerseyNumber === undefined) ? '' : jerseyNumber;
            
            console.log('Form filled with:', {
                name: document.getElementById('player-name').value,
                nickname: document.getElementById('player-nickname').value,
                birthDate: document.getElementById('player-birth-date').value,
                birthDateFormatted: formattedBirthDate,
                jerseyNumber: document.getElementById('player-jersey').value
            });
            
            // Store the player ID for editing
            window.editingPlayerId = playerId;
            
            // Load positions and set current position
            loadPlayerPositions();
            setTimeout(() => {
                if (position && position !== 'null' && position !== null && position !== undefined) {
                    document.getElementById('player-position').value = position;
                }
            }, 100);
            
            document.getElementById('player-modal').style.display = 'block';
        }

        // Load player positions based on team gender
        function loadPlayerPositions() {
            const teamGender = window.currentTeamGender || 'male';
            const femalePositions = ['Portera', 'Arquera', 'Defensora', 'Mediocampista', 'Delantera'];
            const malePositions = ['Portero', 'Arquero', 'Defensor', 'Mediocampista', 'Delantero'];
            
            const positions = teamGender === 'female' ? femalePositions : malePositions;
            console.log('Positions for gender', teamGender, ':', positions);
            
            // Generate position options
            let positionOptions = '<option value="">Seleccionar posición...</option>';
            positions.forEach(position => {
                positionOptions += `<option value="${position}">${position}</option>`;
            });
            
            // Update position select
            const positionSelect = document.getElementById('player-position');
            if (positionSelect) {
                positionSelect.innerHTML = positionOptions;
            }
        }

        // Close player modal
        function closePlayerModal() {
            document.getElementById('player-modal').style.display = 'none';
        }

        // Show Excel import modal
        function showExcelImportModal() {
            if (!window.currentTeamId) {
                showMessage('Primero selecciona un equipo desde "Mis Equipos"', 'error');
                return;
            }
            
            document.getElementById('excel-import-modal').style.display = 'block';
            document.getElementById('excel-import-form').reset();
        }

        // Close Excel import modal
        function closeExcelImportModal() {
            document.getElementById('excel-import-modal').style.display = 'none';
        }

        // Handle Excel import form submission
        document.getElementById('excel-import-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('excel-file');
            if (!fileInput.files[0]) {
                showMessage('Por favor selecciona un archivo Excel', 'error');
                return;
            }
            
            try {
                showMessage('Procesando archivo Excel...', 'info');
                const players = await processExcelFile(fileInput.files[0]);
                
                if (players.length === 0) {
                    showMessage('No se encontraron jugadores válidos en el archivo', 'error');
                    return;
                }
                
                // Import players
                await importPlayersToTeam(players);
                
            } catch (error) {
                console.error('Error processing Excel file:', error);
                showMessage('Error al procesar el archivo Excel: ' + error.message, 'error');
            }
        });

        // Process Excel file and extract players data
        async function processExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Get first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Convert to JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            reject(new Error('El archivo debe tener al menos una fila de encabezados y una fila de datos'));
                            return;
                        }
                        
                        // Expected headers
                        const expectedHeaders = ['Nombre', 'Apodo', 'Fecha de Nacimiento', 'Posición', 'Número de Camiseta'];
                        const actualHeaders = jsonData[0];
                        
                        // Validate headers
                        const missingHeaders = expectedHeaders.filter(header => 
                            !actualHeaders.some(actual => 
                                actual && actual.toString().toLowerCase().trim() === header.toLowerCase()
                            )
                        );
                        
                        if (missingHeaders.length > 0) {
                            reject(new Error(`Faltan las siguientes columnas: ${missingHeaders.join(', ')}`));
                            return;
                        }
                        
                        // Get column indices
                        const getColumnIndex = (headerName) => {
                            return actualHeaders.findIndex(header => 
                                header && header.toString().toLowerCase().trim() === headerName.toLowerCase()
                            );
                        };
                        
                        const nameIndex = getColumnIndex('Nombre');
                        const nicknameIndex = getColumnIndex('Apodo');
                        const birthDateIndex = getColumnIndex('Fecha de Nacimiento');
                        const positionIndex = getColumnIndex('Posición');
                        const jerseyIndex = getColumnIndex('Número de Camiseta');
                        
                        // Process data rows
                        const players = [];
                        const teamGender = window.currentTeamGender || 'male';
                        const validPositions = teamGender === 'female' 
                            ? ['Portera', 'Arquera', 'Defensora', 'Mediocampista', 'Delantera']
                            : ['Portero', 'Arquero', 'Defensor', 'Mediocampista', 'Delantero'];
                        
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            
                            // Skip empty rows
                            if (!row || row.length === 0 || !row[nameIndex]) {
                                continue;
                            }
                            
                            const name = row[nameIndex] ? row[nameIndex].toString().trim() : '';
                            const nickname = row[nicknameIndex] ? row[nicknameIndex].toString().trim() : '';
                            const birthDateRaw = row[birthDateIndex] ? row[birthDateIndex].toString().trim() : '';
                            const position = row[positionIndex] ? row[positionIndex].toString().trim() : '';
                            const jerseyNumber = row[jerseyIndex] ? parseInt(row[jerseyIndex]) : null;
                            
                            // Validate required fields
                            if (!name) {
                                console.warn(`Fila ${i + 1}: Nombre requerido, saltando...`);
                                continue;
                            }
                            
                            if (!birthDateRaw) {
                                console.warn(`Fila ${i + 1}: Fecha de nacimiento requerida, saltando...`);
                                continue;
                            }
                            
                            // Parse birth date - support multiple formats
                            let birthDate = null;
                            try {
                                // Try to parse different date formats
                                if (birthDateRaw.includes('/')) {
                                    // DD/MM/YYYY or MM/DD/YYYY format
                                    const parts = birthDateRaw.split('/');
                                    if (parts.length === 3) {
                                        // Assume DD/MM/YYYY format for Spanish locale
                                        const day = parseInt(parts[0]);
                                        const month = parseInt(parts[1]);
                                        const year = parseInt(parts[2]);
                                        birthDate = `${year.toString().padStart(4, '0')}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                                    }
                                } else if (birthDateRaw.includes('-')) {
                                    // YYYY-MM-DD format
                                    birthDate = birthDateRaw;
                                } else {
                                    // Try to parse as Excel serial date
                                    const excelDate = parseInt(birthDateRaw);
                                    if (!isNaN(excelDate) && excelDate > 25000) { // Excel serial dates start around 25567 for 1970
                                        const jsDate = new Date((excelDate - 25569) * 86400 * 1000);
                                        birthDate = jsDate.toISOString().split('T')[0];
                                    }
                                }
                                
                                if (!birthDate) {
                                    throw new Error('Formato de fecha no reconocido');
                                }
                                
                                // Validate date format YYYY-MM-DD
                                if (!/^\d{4}-\d{2}-\d{2}$/.test(birthDate)) {
                                    throw new Error('Formato de fecha inválido');
                                }
                                
                            } catch (error) {
                                console.warn(`Fila ${i + 1}: Error procesando fecha "${birthDateRaw}": ${error.message}, saltando...`);
                                continue;
                            }
                            
                            // Validate position if provided
                            if (position && !validPositions.includes(position)) {
                                console.warn(`Fila ${i + 1}: Posición "${position}" no válida para equipo ${teamGender}, saltando...`);
                                continue;
                            }
                            
                            players.push({
                                teamId: window.currentTeamId,
                                name,
                                nickname: nickname || null,
                                birth_date: birthDate,
                                position: position || null,
                                jersey_number: jerseyNumber
                            });
                        }
                        
                        resolve(players);
                        
                    } catch (error) {
                        reject(new Error('Error al leer el archivo Excel: ' + error.message));
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Error al leer el archivo'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // Import players to team
        async function importPlayersToTeam(players) {
            try {
                const successfulImports = [];
                const failedImports = [];
                
                for (const player of players) {
                    try {
                        const response = await fetch('/api/players', {
                            method: 'POST',
                            headers: getAuthHeaders(),
                            body: JSON.stringify(player)
                        });

                        if (response.status === 401) {
                            handleAuthError('Token expired during import', response);
                            return;
                        }

                        if (response.ok) {
                            const newPlayer = await response.json();
                            successfulImports.push(player.name);
                        } else {
                            const errorData = await response.json();
                            failedImports.push(`${player.name} (${errorData.message})`);
                        }
                    } catch (error) {
                        failedImports.push(`${player.name} (${error.message})`);
                    }
                }
                
                // Show results
                let message = '';
                if (successfulImports.length > 0) {
                    message += `✅ ${successfulImports.length} jugadores importados exitosamente\n`;
                }
                if (failedImports.length > 0) {
                    message += `❌ ${failedImports.length} jugadores fallaron:\n${failedImports.join('\n')}`;
                }
                
                showMessage(message, successfulImports.length > 0 ? 'success' : 'error');
                
                // Close modal and refresh team view
                closeExcelImportModal();
                if (successfulImports.length > 0) {
                    await loadPlayersForTeam(window.currentTeamId, window.currentTeamName, window.currentTeamGender);
                }
                
            } catch (error) {
                console.error('Error importing players:', error);
                showMessage('Error al importar jugadores: ' + error.message, 'error');
            }
        }

        // Remove player from team
        async function removePlayerFromTeam(playerId, playerName) {
            console.log('🗑️ Intentando eliminar jugador:', { playerId, playerName, teamId: window.currentTeamId });
            
            if (!confirm(`¿Estás seguro de que deseas eliminar a "${playerName}" del equipo?`)) {
                return;
            }

            try {
                const url = `/api/players/${playerId}?team_id=${window.currentTeamId}`;
                console.log('🌐 URL de eliminación:', url);
                
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                console.log('📡 Response status:', response.status);
                const data = await response.json();
                console.log('📦 Response data:', data);
                
                if (data.success) {
                    showMessage(`${playerName} eliminado del equipo exitosamente`, 'success');
                    loadPlayersForTeam(window.currentTeamId, window.currentTeamName); // Recargar lista
                } else {
                    showMessage(`Error: ${data.message || data.error}`, 'error');
                }
            } catch (error) {
                console.error('❌ Error de conexión:', error);
                showMessage(`Error de conexión: ${error.message}`, 'error');
            }
        }

        // ==========================================
        // ATTENDANCE FUNCTIONS
        // ==========================================
        
        // Load attendance management
        async function loadAttendance() {
            console.log('Loading attendance management...');
            await loadTeamsForAttendance();
        }
        
        // Load teams for attendance selector
        async function loadTeamsForAttendance() {
            try {
                const response = await fetch('/api/teams', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('attendance-team-select');
                    select.innerHTML = '<option value="">Selecciona un equipo...</option>';
                    
                    data.teams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = team.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading teams for attendance:', error);
            }
        }
        
        // Show create attendance modal
        function showCreateAttendanceModal() {
            const select = document.getElementById('attendance-team-select');
            if (!select.value) {
                showMessage('Por favor selecciona un equipo primero', 'error');
                return;
            }
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendance-date').value = today;
            
            document.getElementById('attendance-modal').style.display = 'block';
        }
        
        // Close attendance modal
        function closeAttendanceModal() {
            document.getElementById('attendance-modal').style.display = 'none';
            document.getElementById('attendance-form').reset();
        }
        
        // Load attendance for selected team
        async function loadAttendanceForTeam() {
            const select = document.getElementById('attendance-team-select');
            const container = document.getElementById('attendance-list');
            
            if (!select.value) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">📋</div>
                        <h3>Selecciona un equipo para ver las asistencias</h3>
                        <p>Podrás registrar y gestionar las asistencias de entrenamientos y partidos</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div class="loading">Cargando entrenamientos...</div>';
            
            try {
                const response = await fetch(`/api/trainings?team_id=${select.value}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError('Token expired', response);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success && data.trainings.length > 0) {
                    container.innerHTML = generateTrainingsGrid(data.trainings);
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 3em; margin-bottom: 20px;">📋</div>
                            <h3>No hay entrenamientos programados</h3>
                            <p>Crea tu primer entrenamiento para comenzar a registrar la asistencia de las jugadoras</p>
                            <button class="btn btn-primary" onclick="showCreateAttendanceModal()" style="margin-top: 20px;">
                                ➕ Crear Primer Entrenamiento
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading trainings:', error);
                container.innerHTML = `<div class="message error">Error cargando entrenamientos: ${error.message}</div>`;
            }
        }
        
        // Helper function to format date without timezone issues
        function formatDateSafe(dateString) {
            if (!dateString) return '';
            
            // If it's already in YYYY-MM-DD format, parse it directly
            const parts = dateString.split('T')[0].split('-');
            if (parts.length === 3) {
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // JavaScript months are 0-indexed
                const day = parseInt(parts[2]);
                
                // Create date in local timezone
                const date = new Date(year, month, day);
                return date.toLocaleDateString('es-ES');
            }
            
            // Fallback for other formats
            return new Date(dateString).toLocaleDateString('es-ES');
        }

        // Helper function to parse date without timezone issues for comparisons
        function parseDateSafe(dateString) {
            if (!dateString) return null;
            
            // If it's already in YYYY-MM-DD format, parse it directly
            const parts = dateString.split('T')[0].split('-');
            if (parts.length === 3) {
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // JavaScript months are 0-indexed
                const day = parseInt(parts[2]);
                
                // Create date in local timezone
                return new Date(year, month, day);
            }
            
            // Fallback for other formats
            return new Date(dateString);
        }

        // Helper function to handle image preview
        function setupImagePreview(inputId, previewContainerId, imgId) {
            const input = document.getElementById(inputId);
            const previewContainer = document.getElementById(previewContainerId);
            const img = document.getElementById(imgId);
            
            if (!input || !previewContainer || !img) return;
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file size (2MB max)
                    if (file.size > 2 * 1024 * 1024) {
                        showMessage('La imagen es demasiado grande. Máximo 2MB permitido.', 'error');
                        input.value = '';
                        previewContainer.style.display = 'none';
                        return;
                    }
                    
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        showMessage('Por favor selecciona un archivo de imagen válido.', 'error');
                        input.value = '';
                        previewContainer.style.display = 'none';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        img.src = e.target.result;
                        previewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewContainer.style.display = 'none';
                }
            });
        }

        // Helper function to convert image to base64
        async function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Generate trainings grid HTML
        function generateTrainingsGrid(trainings) {
            let html = '<div style="display: grid; gap: 15px;">';
            
            trainings.forEach(training => {
                const date = formatDateSafe(training.training_date);
                const time = training.start_time || '';
                
                html += `
                    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: between-center; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h3 style="margin: 0; color: #2c5aa0;">${training.name}</h3>
                                <p style="margin: 5px 0; color: #666;">📅 ${date} ${time ? `⏰ ${time}` : ''}</p>
                                ${training.location ? `<p style="margin: 5px 0; color: #666;">📍 ${training.location}</p>` : ''}
                            </div>
                            <button class="btn btn-primary" onclick="showAttendanceForTraining('${training.id}', '${training.name}', '${date}')" 
                                    style="margin-left: auto;">
                                📝 Ver Asistencia
                            </button>
                        </div>
                        ${training.notes ? `<p style="margin: 10px 0; font-style: italic; color: #555;">${training.notes}</p>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        // Show attendance for specific training
        async function showAttendanceForTraining(trainingId, trainingName, trainingDate) {
            const container = document.getElementById('attendance-list');
            container.innerHTML = '<div class="loading">Cargando jugadoras y asistencias...</div>';
            
            try {
                const teamId = document.getElementById('attendance-team-select').value;
                
                // Get team players
                const playersResponse = await fetch(`/api/players?team_id=${teamId}`, {
                    headers: getAuthHeaders()
                });
                
                if (playersResponse.status === 401) {
                    handleAuthError('Token expired', playersResponse);
                    return;
                }
                
                const playersData = await playersResponse.json();
                
                // Get existing attendance
                const attendanceResponse = await fetch(`/api/training-attendances?training_session_id=${trainingId}`, {
                    headers: getAuthHeaders()
                });
                
                let attendanceData = { success: true, attendances: [] };
                if (attendanceResponse.ok) {
                    attendanceData = await attendanceResponse.json();
                }
                
                if (playersData.success) {
                    container.innerHTML = generateAttendanceForm(trainingId, trainingName, trainingDate, playersData.players, attendanceData.attendances);
                } else {
                    container.innerHTML = `<div class="message error">Error: ${playersData.message}</div>`;
                }
                
            } catch (error) {
                console.error('Error loading attendance data:', error);
                container.innerHTML = `<div class="message error">Error cargando datos: ${error.message}</div>`;
            }
        }
        
        // Generate attendance form HTML
        function generateAttendanceForm(trainingId, trainingName, trainingDate, players, attendances) {
            // Create attendance map for quick lookup
            const attendanceMap = {};
            attendances.forEach(att => {
                attendanceMap[att.player_id] = att;
            });
            
            let html = `
                <div style="background: white; border-radius: 8px; padding: 20px;">
                    <div style="display: flex; justify-content: between-center; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                        <div>
                            <h2 style="margin: 0; color: #2c5aa0;">📝 ${trainingName}</h2>
                            <p style="margin: 5px 0 0 0; color: #666;">📅 ${trainingDate}</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="saveAllAttendance('${trainingId}')" style="margin-left: auto;">
                                ✅ Guardar Asistencias
                            </button>
                            <button class="btn btn-secondary" onclick="loadAttendanceForTeam()">
                                ← Volver a Entrenamientos
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 10px; max-height: 60vh; overflow-y: auto;">
            `;
            
            players.forEach(player => {
                const attendance = attendanceMap[player.id];
                const status = attendance ? attendance.status : 'ausente';
                const excuse = attendance ? attendance.excuse_reason || '' : '';
                
                html += `
                    <div style="display: flex; align-items: center; padding: 15px; border: 1px solid #ddd; border-radius: 6px; background: #fafafa;">
                        <div style="flex: 1; font-weight: bold; color: #333;">
                            ${player.nickname}
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <label style="display: flex; align-items: center; gap: 15px; cursor: pointer;">
                                <input type="radio" name="status_${player.id}" value="presente" ${status === 'presente' ? 'checked' : ''}>
                                <span style="color: #4CAF50; font-weight: bold;">✅ P</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 15px; cursor: pointer;">
                                <input type="radio" name="status_${player.id}" value="tarde" ${status === 'tarde' ? 'checked' : ''}>
                                <span style="color: #FF9800; font-weight: bold;">⏰ T</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 15px; cursor: pointer;">
                                <input type="radio" name="status_${player.id}" value="ausente" ${status === 'ausente' ? 'checked' : ''}>
                                <span style="color: #f44336; font-weight: bold;">❌ A</span>
                            </label>
                            
                            <input type="text" id="excuse_${player.id}" value="${excuse}" placeholder="Motivo (opcional)"
                                   style="width: 150px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }
        
        // Save all attendance for training
        async function saveAllAttendance(trainingId) {
            const container = document.getElementById('attendance-list');
            const playerRows = container.querySelectorAll('div[style*="display: flex"][style*="padding: 15px"]');
            const attendances = [];
            
            playerRows.forEach(row => {
                const statusRadios = row.querySelectorAll('input[type="radio"]:checked');
                const excuseInput = row.querySelector('input[type="text"]');
                
                if (statusRadios.length > 0) {
                    const playerId = statusRadios[0].name.split('_')[1];
                    const status = statusRadios[0].value;
                    const excuse = excuseInput ? excuseInput.value.trim() : '';
                    
                    attendances.push({
                        training_session_id: trainingId,
                        player_id: playerId,
                        status: status,
                        excuse_reason: excuse || null
                    });
                }
            });
            
            try {
                let savedCount = 0;
                let failedCount = 0;
                
                for (const attendance of attendances) {
                    try {
                        const response = await fetch('/api/training-attendances', {
                            method: 'POST',
                            headers: getAuthHeaders(),
                            body: JSON.stringify(attendance)
                        });
                        
                        if (response.ok) {
                            savedCount++;
                        } else {
                            failedCount++;
                        }
                    } catch (error) {
                        failedCount++;
                        console.error('Error saving attendance:', error);
                    }
                }
                
                if (savedCount > 0 && failedCount === 0) {
                    showMessage(`✅ ${savedCount} asistencias guardadas exitosamente`, 'success');
                } else if (savedCount > 0 && failedCount > 0) {
                    showMessage(`⚠️ ${savedCount} asistencias guardadas, ${failedCount} fallaron`, 'error');
                } else {
                    showMessage('❌ Error guardando las asistencias', 'error');
                }
                
                // Refresh the attendance view
                setTimeout(() => {
                    showAttendanceForTraining(trainingId, '', '');
                }, 1000);
                
            } catch (error) {
                console.error('Error saving attendances:', error);
                showMessage('Error guardando asistencias: ' + error.message, 'error');
            }
        }
        
        // Handle attendance form submission
        document.addEventListener('DOMContentLoaded', function() {
            const attendanceForm = document.getElementById('attendance-form');
            if (attendanceForm) {
                attendanceForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const teamSelect = document.getElementById('attendance-team-select');
                    const formData = new FormData(this);
                    
                    // Get the date and ensure it's in correct format
                    const dateInput = document.getElementById('attendance-date');
                    const selectedDate = dateInput.value; // Format: YYYY-MM-DD
                    
                    const attendanceData = {
                        teamId: teamSelect.value,
                        name: `${document.getElementById('attendance-type').value === 'training' ? 'Entrenamiento' : 
                               document.getElementById('attendance-type').value === 'match' ? 'Partido' : 
                               document.getElementById('attendance-type').value === 'meeting' ? 'Reunión' : 'Actividad'} ${selectedDate}`,
                        trainingDate: selectedDate, // Send as YYYY-MM-DD format
                        startTime: '18:00', // Hora por defecto
                        location: '',
                        notes: document.getElementById('attendance-description').value || ''
                    };
                    
                    try {
                        console.log('Creating training session:', attendanceData);
                        
                        const response = await fetch('/api/trainings', {
                            method: 'POST',
                            headers: getAuthHeaders(),
                            body: JSON.stringify(attendanceData)
                        });
                        
                        if (response.status === 401) {
                            handleAuthError('Token expired during training creation', response);
                            return;
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showMessage('Entrenamiento creado exitosamente', 'success');
                            closeAttendanceModal();
                            loadAttendanceForTeam();
                        } else {
                            showMessage('Error: ' + data.message, 'error');
                        }
                        
                    } catch (error) {
                        console.error('Error creating training:', error);
                        showMessage('Error creando entrenamiento: ' + error.message, 'error');
                    }
                });
            }
        });
        
        // ==========================================
        // END ATTENDANCE FUNCTIONS
        // ==========================================
        
        // ==========================================
        // REPORTS FUNCTIONS
        // ==========================================
        
        // Load reports management
        async function loadReports() {
            console.log('Loading enhanced reports management...');
            await loadTeamsForReports();
            await initializeReportFilters();
            await loadDashboardKPIs();
        }
        
        // Load teams for reports selector
        async function loadTeamsForReports() {
            try {
                const response = await fetch('/api/teams', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('reports-team-filter');
                    select.innerHTML = '<option value="">Todos los equipos</option>';
                    
                    data.teams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = team.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading teams for reports:', error);
            }
        }
        
        // Initialize report filters with default dates
        function initializeReportFilters() {
            const today = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(today.getMonth() - 3);
            
            document.getElementById('reports-date-from').value = threeMonthsAgo.toISOString().split('T')[0];
            document.getElementById('reports-date-to').value = today.toISOString().split('T')[0];
        }
        
        // Apply report filters and update dashboard
        async function applyReportFilters() {
            const teamId = document.getElementById('reports-team-filter').value;
            const dateFrom = document.getElementById('reports-date-from').value;
            const dateTo = document.getElementById('reports-date-to').value;
            
            // Store current filters globally
            window.currentReportFilters = { teamId, dateFrom, dateTo };
            
            showMessage('Aplicando filtros...', 'info');
            await loadDashboardKPIs();
            showMessage('Filtros aplicados correctamente', 'success');
        }
        
        // Load dashboard KPIs with current filters
        async function loadDashboardKPIs() {
            try {
                const filters = window.currentReportFilters || {};
                let totalPlayers = 0;
                let totalSessions = 0;
                let totalAttendances = 0;
                let totalLates = 0;
                let teamsToProcess = [];
                
                // Get teams to process
                if (filters.teamId) {
                    teamsToProcess = [filters.teamId];
                } else {
                    const teamsResponse = await fetch('/api/teams', {
                        headers: getAuthHeaders()
                    });
                    const teamsData = await teamsResponse.json();
                    if (teamsData.success) {
                        teamsToProcess = teamsData.teams.map(t => t.id);
                    }
                }
                
                // Process each team
                for (const teamId of teamsToProcess) {
                    // Get players for team
                    const playersResponse = await fetch(`/api/players?team_id=${teamId}`, {
                        headers: getAuthHeaders()
                    });
                    const playersData = await playersResponse.json();
                    
                    if (playersData.success) {
                        totalPlayers += playersData.players.length;
                        
                        // Get trainings for team
                        const trainingsResponse = await fetch(`/api/trainings?team_id=${teamId}`, {
                            headers: getAuthHeaders()
                        });
                        const trainingsData = await trainingsResponse.json();
                        
                        if (trainingsData.success) {
                            // Filter trainings by date if specified
                            let filteredTrainings = trainingsData.trainings;
                            if (filters.dateFrom || filters.dateTo) {
                                filteredTrainings = trainingsData.trainings.filter(training => {
                                    const trainingDate = parseDateSafe(training.training_date);
                                    const isAfterFrom = !filters.dateFrom || trainingDate >= new Date(filters.dateFrom);
                                    const isBeforeTo = !filters.dateTo || trainingDate <= new Date(filters.dateTo);
                                    return isAfterFrom && isBeforeTo;
                                });
                            }
                            
                            totalSessions += filteredTrainings.length;
                            
                            // Get attendance stats for filtered trainings
                            for (const training of filteredTrainings) {
                                try {
                                    const attendanceResponse = await fetch(`/api/training-attendances?training_session_id=${training.id}`, {
                                        headers: getAuthHeaders()
                                    });
                                    
                                    if (attendanceResponse.ok) {
                                        const attendanceData = await attendanceResponse.json();
                                        if (attendanceData.success) {
                                            attendanceData.attendances.forEach(att => {
                                                if (att.status === 'presente' || att.status === 'tarde') {
                                                    totalAttendances++;
                                                }
                                                if (att.status === 'tarde') {
                                                    totalLates++;
                                                }
                                            });
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error fetching attendance:', error);
                                }
                            }
                        }
                    }
                }
                
                // Calculate percentages
                const avgAttendance = totalSessions > 0 && totalPlayers > 0 
                    ? Math.round((totalAttendances / (totalSessions * totalPlayers)) * 100)
                    : 0;
                
                const punctualityRate = totalAttendances > 0 
                    ? Math.round(((totalAttendances - totalLates) / totalAttendances) * 100)
                    : 0;
                
                // Update KPIs in dashboard
                document.getElementById('kpi-total-players').textContent = totalPlayers;
                document.getElementById('kpi-total-sessions').textContent = totalSessions;
                document.getElementById('kpi-avg-attendance').textContent = `${avgAttendance}%`;
                document.getElementById('kpi-punctuality').textContent = `${punctualityRate}%`;
                
            } catch (error) {
                console.error('Error loading dashboard KPIs:', error);
                // Set default values on error
                document.getElementById('kpi-total-players').textContent = '0';
                document.getElementById('kpi-total-sessions').textContent = '0';
                document.getElementById('kpi-avg-attendance').textContent = '0%';
                document.getElementById('kpi-punctuality').textContent = '0%';
            }
        }
        
        // ===== REPORTES ESPECÍFICOS =====
        
        // 1. Generar Reporte General de Asistencias
        async function generateGeneralReport() {
            const container = document.getElementById('reports-content');
            container.innerHTML = '<div class="loading">Generando reporte general de asistencias...</div>';
            
            try {
                const filters = window.currentReportFilters || {};
                const reportData = await getCompleteAttendanceData(filters);
                
                let html = `
                    <div style="background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                            <h2 style="margin: 0 0 15px 0; color: #28a745; font-size: 1.5rem;">📋 Reporte General de Asistencias</h2>
                            <div class="button-group" style="justify-content: flex-start;">
                                <button class="btn btn-success btn-sm" onclick="exportReport('general', 'excel')">📊 Excel</button>
                                <button class="btn btn-info btn-sm" onclick="exportReport('general', 'pdf')">📄 PDF</button>
                                <button class="btn btn-secondary btn-sm" onclick="loadReports()">← Volver</button>
                            </div>
                        </div>
                        
                        <!-- Filtros Aplicados -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
                            <h4 style="margin: 0 0 10px 0;">🔍 Filtros Aplicados:</h4>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.9rem;">
                                <span><strong>Equipo:</strong> ${filters.teamId ? 'Equipo específico' : 'Todos los equipos'}</span>
                                <span><strong>Período:</strong> ${filters.dateFrom || 'Sin límite'} - ${filters.dateTo || 'Hasta hoy'}</span>
                                <span><strong>Total Jugadores:</strong> ${reportData.totalPlayers}</span>
                                <span><strong>Total Entrenamientos:</strong> ${reportData.totalTrainings}</span>
                            </div>
                        </div>
                        
                        <!-- Resumen Estadístico -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${reportData.stats.avgAttendance}%</div>
                                <div>Asistencia Promedio</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffc107, #fd7e14); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${reportData.stats.punctualityRate}%</div>
                                <div>Puntualidad Promedio</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #dc3545, #e74a3b); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${reportData.stats.totalAbsences}</div>
                                <div>Total Ausencias</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${reportData.stats.bestAttendanceRate}%</div>
                                <div>Mejor Asistencia</div>
                            </div>
                        </div>
                        
                        <!-- Ranking de Asistencia -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #2c5aa0; margin-bottom: 20px;">🏆 Ranking de Asistencia</h3>
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                            <th style="padding: 10px 8px; font-size: 0.85rem;">#</th>
                                            <th style="padding: 10px 8px; font-size: 0.85rem;">Jugador</th>
                                            <th style="padding: 10px 8px; font-size: 0.85rem;">Equipo</th>
                                            <th style="padding: 10px 8px; font-size: 0.85rem; text-align: center;">✅</th>
                                            <th style="padding: 10px 8px; font-size: 0.85rem; text-align: center;">⚠️</th>
                                            <th style="padding: 10px 8px; font-size: 0.85rem; text-align: center;">❌</th>
                                            <th style="padding: 10px 8px; font-size: 0.85rem; text-align: center;">📊</th>
                                            <th style="padding: 10px 8px; font-size: 0.85rem; text-align: center;">⏰</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                reportData.playersRanked.forEach((player, index) => {
                    const position = index + 1;
                    const total = player.presente + player.tarde + player.ausente;
                    const attendanceRate = total > 0 ? Math.round(((player.presente + player.tarde) / total) * 100) : 0;
                    const punctualityRate = (player.presente + player.tarde) > 0 ? Math.round((player.presente / (player.presente + player.tarde)) * 100) : 0;
                    
                    let positionIcon = '';
                    if (position === 1) positionIcon = '🥇';
                    else if (position === 2) positionIcon = '🥈';
                    else if (position === 3) positionIcon = '🥉';
                    
                    let attendanceColor = attendanceRate >= 80 ? '#28a745' : attendanceRate >= 60 ? '#ffc107' : '#dc3545';
                    let punctualityColor = punctualityRate >= 90 ? '#28a745' : punctualityRate >= 70 ? '#ffc107' : '#dc3545';
                    
                    html += `
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 8px 6px; font-weight: bold; color: #2c5aa0; font-size: 0.8rem;">${positionIcon} ${position}</td>
                            <td style="padding: 8px 6px; font-size: 0.8rem;">
                                <div style="font-weight: bold;">${player.name}</div>
                                ${player.nickname ? `<small style="color: #666; font-size: 0.7rem;">"${player.nickname}"</small>` : ''}
                                ${player.jersey_number ? `<span style="color: #007bff; font-size: 0.7rem;"> #${player.jersey_number}</span>` : ''}
                            </td>
                            <td style="padding: 8px 6px; text-align: center; font-size: 0.75rem;">
                                <span style="background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem;">
                                    ${player.teamName}
                                </span>
                            </td>
                            <td style="padding: 8px 6px; text-align: center; color: #28a745; font-weight: bold; font-size: 0.8rem;">${player.presente}</td>
                            <td style="padding: 8px 6px; text-align: center; color: #ffc107; font-weight: bold; font-size: 0.8rem;">${player.tarde}</td>
                            <td style="padding: 8px 6px; text-align: center; color: #dc3545; font-weight: bold; font-size: 0.8rem;">${player.ausente}</td>
                            <td style="padding: 8px 6px; text-align: center;">
                                <span style="background: ${attendanceColor}; color: white; padding: 3px 6px; border-radius: 4px; font-weight: bold; font-size: 0.75rem;">
                                    ${attendanceRate}%
                                </span>
                            </td>
                            <td style="padding: 8px 6px; text-align: center;">
                                <span style="background: ${punctualityColor}; color: white; padding: 3px 6px; border-radius: 4px; font-weight: bold; font-size: 0.75rem;">
                                    ${punctualityRate}%
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Gráfico de Barras de Asistencia (Simulado) -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #2c5aa0; margin-bottom: 20px;">📊 Gráfico de Asistencia (Top 10)</h3>
                            <div class="ranking-chart-mobile" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                `;
                
                reportData.playersRanked.slice(0, 10).forEach((player, index) => {
                    const total = player.presente + player.tarde + player.ausente;
                    const attendanceRate = total > 0 ? Math.round(((player.presente + player.tarde) / total) * 100) : 0;
                    const barWidth = Math.max(attendanceRate, 5); // Minimum 5% for visibility
                    
                    html += `
                        <div class="bar-container" style="display: flex; align-items: center; margin-bottom: 10px;">
                            <div class="player-name" style="width: 150px; font-size: 0.9em; font-weight: bold; color: #333; flex-shrink: 0;">${player.name}</div>
                            <div class="progress-bar" style="flex: 1; background: #e9ecef; border-radius: 4px; margin: 0 10px; height: 25px; position: relative;">
                                <div style="background: ${attendanceRate >= 80 ? '#28a745' : attendanceRate >= 60 ? '#ffc107' : '#dc3545'}; 
                                           height: 100%; width: ${barWidth}%; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    <span class="percentage-text" style="font-size: 0.85em;">${attendanceRate}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error generating general report:', error);
                container.innerHTML = `<div class="message error">Error generando reporte general: ${error.message}</div>`;
            }
        }
        
        // Load reports for selected team
        async function loadReportsForTeam() {
            const select = document.getElementById('reports-team-select');
            const container = document.getElementById('reports-content');
            
            if (!select.value) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">📊</div>
                        <h3>Selecciona un equipo para ver los reportes</h3>
                        <p>Podrás ver estadísticas de asistencia, rendimiento y generar reportes exportables</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div class="loading">Cargando estadísticas del equipo...</div>';
            
            try {
                // Get team data
                const teamResponse = await fetch(`/api/teams`, {
                    headers: getAuthHeaders()
                });
                const teamData = await teamResponse.json();
                const team = teamData.success ? teamData.teams.find(t => t.id === select.value) : null;
                
                // Get players for the team
                const playersResponse = await fetch(`/api/players?team_id=${select.value}`, {
                    headers: getAuthHeaders()
                });
                const playersData = await playersResponse.json();
                
                // Get trainings for the team
                const trainingsResponse = await fetch(`/api/trainings?team_id=${select.value}`, {
                    headers: getAuthHeaders()
                });
                const trainingsData = await trainingsResponse.json();
                
                if (playersData.success && trainingsData.success) {
                    container.innerHTML = await generateReportsDashboard(
                        team, 
                        playersData.players, 
                        trainingsData.trainings,
                        select.value
                    );
                } else {
                    container.innerHTML = `<div class="message error">Error cargando datos del equipo</div>`;
                }
                
            } catch (error) {
                console.error('Error loading reports data:', error);
                container.innerHTML = `<div class="message error">Error cargando reportes: ${error.message}</div>`;
            }
        }
        
        // Generate reports dashboard HTML
        async function generateReportsDashboard(team, players, trainings, teamId) {
            // Get attendance statistics
            const attendanceStats = await getAttendanceStatistics(teamId, trainings, players);
            
            let html = `
                <div style="display: grid; gap: 20px;">
                    <!-- Team Summary Card -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.5em;">📊 Resumen de ${team ? team.name : 'Equipo'}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${players.length}</div>
                                <div>Jugadores</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${trainings.length}</div>
                                <div>Entrenamientos</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${attendanceStats.averageAttendance}%</div>
                                <div>Asistencia Promedio</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${attendanceStats.totalSessions}</div>
                                <div>Sesiones Registradas</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reports Actions -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #2c5aa0;">📋 Reporte de Asistencias</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Estadísticas detalladas de asistencia por jugador y entrenamiento</p>
                            <button class="btn btn-primary" onclick="generateAttendanceReport('${teamId}')" style="width: 100%;">
                                📊 Ver Reporte Detallado
                            </button>
                        </div>
                        
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #2c5aa0;">📈 Estadísticas por Jugador</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Rendimiento individual y comparativas entre jugadores</p>
                            <button class="btn btn-success" onclick="generatePlayerStats('${teamId}')" style="width: 100%;">
                                👥 Ver Estadísticas
                            </button>
                        </div>
                        
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #2c5aa0;">📅 Reporte Temporal</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Tendencias de asistencia a lo largo del tiempo</p>
                            <button class="btn btn-info" onclick="generateTemporalReport('${teamId}')" style="width: 100%;">
                                ⏱️ Ver Tendencias
                            </button>
                        </div>
                    </div>
            `;
            
            // Add player attendance quick view
            if (attendanceStats.playerStats.length > 0) {
                html += `
                    <!-- Quick Player Stats -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 20px 0; color: #2c5aa0;">🏃‍♀️ Vista Rápida - Asistencia por Jugador</h4>
                        <div style="display: grid; gap: 10px; max-height: 300px; overflow-y: auto;">
                `;
                
                attendanceStats.playerStats.forEach(player => {
                    const percentage = player.totalTrainings > 0 ? Math.round((player.presents / player.totalTrainings) * 100) : 0;
                    let statusColor = percentage >= 80 ? '#4CAF50' : percentage >= 60 ? '#FF9800' : '#f44336';
                    
                    html += `
                        <div style="display: flex; justify-content: between-center; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 6px;">
                            <div style="flex: 1;">
                                <strong>${player.name}</strong>
                                ${player.nickname ? `<span style="color: #666;">(${player.nickname})</span>` : ''}
                                ${player.jersey_number ? `<span style="color: #666;"> - #${player.jersey_number}</span>` : ''}
                            </div>
                            <div style="display: flex; gap: 15px; align-items: center; font-size: 0.9em;">
                                <span>✅ ${player.presents}</span>
                                <span>⏰ ${player.lates}</span>
                                <span>❌ ${player.absents}</span>
                                <div style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; margin-left: 10px;">
                                    ${percentage}%
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            html += '</div>';
            return html;
        }
        
        // Get attendance statistics for a team
        async function getAttendanceStatistics(teamId, trainings, players) {
            const playerStats = [];
            let totalSessions = 0;
            let totalAttendances = 0;
            
            // Initialize player stats
            players.forEach(player => {
                playerStats.push({
                    id: player.id,
                    name: player.name,
                    nickname: player.nickname,
                    jersey_number: player.jersey_number,
                    presents: 0,
                    lates: 0,
                    absents: 0,
                    totalTrainings: 0
                });
            });
            
            // Get attendance data for each training
            for (const training of trainings) {
                try {
                    const response = await fetch(`/api/training-attendances?training_session_id=${training.id}`, {
                        headers: getAuthHeaders()
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.attendances.length > 0) {
                            totalSessions++;
                            
                            // Update player stats based on this training
                            data.attendances.forEach(attendance => {
                                const playerStat = playerStats.find(p => p.id == attendance.player_id);
                                if (playerStat) {
                                    playerStat.totalTrainings++;
                                    
                                    switch (attendance.status) {
                                        case 'presente':
                                            playerStat.presents++;
                                            totalAttendances++;
                                            break;
                                        case 'tarde':
                                            playerStat.lates++;
                                            totalAttendances++;
                                            break;
                                        case 'ausente':
                                            playerStat.absents++;
                                            break;
                                    }
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error fetching attendance for training:', training.id, error);
                }
            }
            
            // Calculate overall statistics
            const averageAttendance = totalSessions > 0 && players.length > 0 
                ? Math.round((totalAttendances / (totalSessions * players.length)) * 100)
                : 0;
            
            return {
                playerStats,
                totalSessions,
                averageAttendance,
                totalAttendances
            };
        }
        
        // Generate detailed attendance report
        async function generateAttendanceReport(teamId) {
            const container = document.getElementById('reports-content');
            container.innerHTML = '<div class="loading">Generando reporte detallado...</div>';
            
            try {
                // Get detailed data
                const playersResponse = await fetch(`/api/players?team_id=${teamId}`, {
                    headers: getAuthHeaders()
                });
                const playersData = await playersResponse.json();
                
                const trainingsResponse = await fetch(`/api/trainings?team_id=${teamId}`, {
                    headers: getAuthHeaders()
                });
                const trainingsData = await trainingsResponse.json();
                
                if (!playersData.success || !trainingsData.success) {
                    throw new Error('Error cargando datos del equipo');
                }
                
                const attendanceStats = await getAttendanceStatistics(teamId, trainingsData.trainings, playersData.players);
                
                let html = `
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: between-center; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                            <h2 style="margin: 0; color: #2c5aa0;">📊 Reporte Detallado de Asistencias</h2>
                            <button class="btn btn-secondary" onclick="loadReportsForTeam()">← Volver a Reportes</button>
                        </div>
                        
                        <!-- Summary Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #28a745;">${attendanceStats.totalSessions}</div>
                                <div>Entrenamientos</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #007bff;">${playersData.players.length}</div>
                                <div>Jugadores</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #fd7e14;">${attendanceStats.averageAttendance}%</div>
                                <div>Asistencia Promedio</div>
                            </div>
                        </div>
                        
                        <!-- Player Details Table -->
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                        <th style="border-right: 1px solid #dee2e6;">Jugador</th>
                                        <th style="text-align: center; border-right: 1px solid #dee2e6;">✅ Presente</th>
                                        <th style="text-align: center; border-right: 1px solid #dee2e6;">⏰ Tarde</th>
                                        <th style="text-align: center; border-right: 1px solid #dee2e6;">❌ Ausente</th>
                                        <th style="text-align: center; border-right: 1px solid #dee2e6;">Total</th>
                                        <th style="text-align: center;">% Asistencia</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                attendanceStats.playerStats.forEach((player, index) => {
                    const total = player.presents + player.lates + player.absents;
                    const percentage = total > 0 ? Math.round(((player.presents + player.lates) / total) * 100) : 0;
                    const rowBg = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    let statusColor = percentage >= 80 ? '#28a745' : percentage >= 60 ? '#ffc107' : '#dc3545';
                    
                    html += `
                        <tr style="background: ${rowBg}; border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px; border-right: 1px solid #dee2e6;">
                                <strong>${player.name}</strong>
                                ${player.nickname ? `<br><small style="color: #666;">"${player.nickname}"</small>` : ''}
                                ${player.jersey_number ? `<span style="color: #007bff;"> #${player.jersey_number}</span>` : ''}
                            </td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; color: #28a745; font-weight: bold;">${player.presents}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; color: #ffc107; font-weight: bold;">${player.lates}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; color: #dc3545; font-weight: bold;">${player.absents}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; font-weight: bold;">${total}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;">
                                    ${percentage}%
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Export Actions -->
                        <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; justify-content: center;">
                            <button class="btn btn-success" onclick="exportAttendanceReport('${teamId}', 'csv')">
                                📊 Exportar CSV
                            </button>
                            <button class="btn btn-info" onclick="exportAttendanceReport('${teamId}', 'print')">
                                🖨️ Imprimir Reporte
                            </button>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error generating attendance report:', error);
                container.innerHTML = `<div class="message error">Error generando reporte: ${error.message}</div>`;
            }
        }
        
        // Export attendance report
        function exportAttendanceReport(teamId, format) {
            if (format === 'print') {
                window.print();
            } else if (format === 'csv') {
                showMessage('Exportación CSV próximamente disponible', 'info');
                // TODO: Implement CSV export
            }
        }
        
        // Generate player statistics (placeholder)
        function generatePlayerStats(teamId) {
            showMessage('Estadísticas por jugador próximamente disponible', 'info');
            // TODO: Implement detailed player statistics
        }
        
        // Generate temporal report (placeholder)
        function generateTemporalReport() {
            showMessage('Reporte temporal próximamente disponible', 'info');
            // TODO: Implement temporal trending reports
        }
        
        // Obtener datos completos de asistencia con filtros
        async function getCompleteAttendanceData(filters) {
            let allPlayers = [];
            let totalTrainings = 0;
            let teamsToProcess = [];
            
            // Determinar equipos a procesar
            if (filters.teamId) {
                // Get specific team name
                const teamsResponse = await fetch('/api/teams', {
                    headers: getAuthHeaders()
                });
                const teamsData = await teamsResponse.json();
                if (teamsData.success) {
                    const team = teamsData.teams.find(t => t.id === filters.teamId);
                    teamsToProcess = [{ id: filters.teamId, name: team ? team.name : 'Equipo' }];
                }
            } else {
                const teamsResponse = await fetch('/api/teams', {
                    headers: getAuthHeaders()
                });
                const teamsData = await teamsResponse.json();
                if (teamsData.success) {
                    teamsToProcess = teamsData.teams.map(t => ({ id: t.id, name: t.name }));
                } else {
                    teamsToProcess = [];
                }
            }
            
            // Procesar cada equipo
            for (const team of teamsToProcess) {
                const teamId = team.id;
                const teamName = team.name;
                
                // Obtener jugadores del equipo
                const playersResponse = await fetch(`/api/players?team_id=${teamId}`, {
                    headers: getAuthHeaders()
                });
                const playersData = await playersResponse.json();
                
                if (playersData.success) {
                    // Obtener entrenamientos del equipo
                    const trainingsResponse = await fetch(`/api/trainings?team_id=${teamId}`, {
                        headers: getAuthHeaders()
                    });
                    const trainingsData = await trainingsResponse.json();
                    
                    if (trainingsData.success) {
                        // Filtrar entrenamientos por fecha
                        let filteredTrainings = trainingsData.trainings;
                        if (filters.dateFrom || filters.dateTo) {
                            filteredTrainings = trainingsData.trainings.filter(training => {
                                const trainingDate = parseDateSafe(training.training_date);
                                const isAfterFrom = !filters.dateFrom || trainingDate >= new Date(filters.dateFrom);
                                const isBeforeTo = !filters.dateTo || trainingDate <= new Date(filters.dateTo);
                                return isAfterFrom && isBeforeTo;
                            });
                        }
                        
                        totalTrainings = Math.max(totalTrainings, filteredTrainings.length);
                        
                        // Procesar cada jugador
                        for (const player of playersData.players) {
                            const playerStats = {
                                id: player.id,
                                name: player.name,
                                nickname: player.nickname,
                                jersey_number: player.jersey_number,
                                teamId: teamId,
                                teamName: teamName,
                                presente: 0,
                                tarde: 0,
                                ausente: 0
                            };
                            
                            // Obtener asistencias para cada entrenamiento
                            for (const training of filteredTrainings) {
                                try {
                                    const attendanceResponse = await fetch(`/api/training-attendances?training_session_id=${training.id}`, {
                                        headers: getAuthHeaders()
                                    });
                                    
                                    if (attendanceResponse.ok) {
                                        const attendanceData = await attendanceResponse.json();
                                        if (attendanceData.success) {
                                            const playerAttendance = attendanceData.attendances.find(att => att.player_id == player.id);
                                            if (playerAttendance) {
                                                switch (playerAttendance.status) {
                                                    case 'presente':
                                                        playerStats.presente++;
                                                        break;
                                                    case 'tarde':
                                                        playerStats.tarde++;
                                                        break;
                                                    case 'ausente':
                                                        playerStats.ausente++;
                                                        break;
                                                }
                                            } else {
                                                playerStats.ausente++; // Si no hay registro, asume ausente
                                            }
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error fetching attendance:', error);
                                }
                            }
                            
                            allPlayers.push(playerStats);
                        }
                    }
                }
            }
            
            // Calcular estadísticas globales
            const totalPlayers = allPlayers.length;
            let totalAttendances = 0;
            let totalLates = 0;
            let totalAbsences = 0;
            let bestAttendanceRate = 0;
            
            allPlayers.forEach(player => {
                totalAttendances += (player.presente + player.tarde);
                totalLates += player.tarde;
                totalAbsences += player.ausente;
                
                const total = player.presente + player.tarde + player.ausente;
                const attendanceRate = total > 0 ? Math.round(((player.presente + player.tarde) / total) * 100) : 0;
                bestAttendanceRate = Math.max(bestAttendanceRate, attendanceRate);
            });
            
            const avgAttendance = totalPlayers > 0 && totalTrainings > 0 
                ? Math.round((totalAttendances / (totalTrainings * totalPlayers)) * 100)
                : 0;
            
            const punctualityRate = totalAttendances > 0 
                ? Math.round(((totalAttendances - totalLates) / totalAttendances) * 100)
                : 0;
            
            // Ordenar jugadores por porcentaje de asistencia
            const playersRanked = allPlayers.sort((a, b) => {
                const totalA = a.presente + a.tarde + a.ausente;
                const totalB = b.presente + b.tarde + b.ausente;
                const rateA = totalA > 0 ? ((a.presente + a.tarde) / totalA) * 100 : 0;
                const rateB = totalB > 0 ? ((b.presente + b.tarde) / totalB) * 100 : 0;
                return rateB - rateA; // Descendente
            });
            
            return {
                totalPlayers,
                totalTrainings,
                playersRanked,
                stats: {
                    avgAttendance,
                    punctualityRate,
                    totalAbsences,
                    bestAttendanceRate
                }
            };
        }
        
        // ===== OTROS REPORTES (PLACEHOLDERS) =====
        
        // 2. Reporte Comparativo por Equipo
        async function generateComparativeReport() {
            const container = document.getElementById('reports-content');
            container.innerHTML = '<div class="loading">Generando reporte comparativo...</div>';
            
            try {
                // Get all teams data
                const teamsResponse = await fetch('/api/teams', {
                    headers: getAuthHeaders()
                });
                const teamsData = await teamsResponse.json();
                
                if (!teamsData.success || !teamsData.teams || teamsData.teams.length === 0) {
                    container.innerHTML = `<div class="message warning">No se encontraron equipos para comparar</div>`;
                    return;
                }
                
                // Get comparative data for all teams
                const teamsStats = [];
                for (const team of teamsData.teams) {
                    try {
                        const [playersResponse, trainingsResponse] = await Promise.all([
                            fetch(`/api/players?team_id=${team.id}`, { headers: getAuthHeaders() }),
                            fetch(`/api/trainings?team_id=${team.id}`, { headers: getAuthHeaders() })
                        ]);
                        
                        const playersData = await playersResponse.json();
                        const trainingsData = await trainingsResponse.json();
                        
                        if (playersData.success && trainingsData.success) {
                            const attendanceStats = await getAttendanceStatistics(
                                team.id, 
                                trainingsData.trainings, 
                                playersData.players
                            );
                            
                            teamsStats.push({
                                ...team,
                                playersCount: playersData.players.length,
                                trainingsCount: trainingsData.trainings.length,
                                attendanceStats: attendanceStats,
                                category: team.category || 'Sin categoría'
                            });
                        }
                    } catch (error) {
                        console.warn(`Error loading data for team ${team.name}:`, error);
                    }
                }
                
                if (teamsStats.length === 0) {
                    container.innerHTML = `<div class="message warning">No se pudieron cargar datos de equipos para comparar</div>`;
                    return;
                }
                
                // Sort teams by attendance percentage
                teamsStats.sort((a, b) => b.attendanceStats.averageAttendance - a.attendanceStats.averageAttendance);
                
                let html = `
                    <div style="background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                            <h2 style="margin: 0 0 15px 0; color: #17a2b8; font-size: 1.5rem;">📊 Reporte Comparativo por Equipos</h2>
                            <div class="button-group" style="justify-content: flex-start;">
                                <button class="btn btn-success btn-sm" onclick="exportComparativeReport('excel')">📊 Excel</button>
                                <button class="btn btn-info btn-sm" onclick="exportComparativeReport('pdf')">📄 PDF</button>
                                <button class="btn btn-secondary btn-sm" onclick="loadReports()">← Volver</button>
                            </div>
                        </div>
                        
                        <!-- Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2.5em; font-weight: bold;">${teamsStats.length}</div>
                                <div>Equipos Analizados</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #28a745, #1e7e34); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2.5em; font-weight: bold;">${teamsStats.reduce((sum, team) => sum + team.playersCount, 0)}</div>
                                <div>Total Jugadores</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2.5em; font-weight: bold;">${teamsStats.reduce((sum, team) => sum + team.trainingsCount, 0)}</div>
                                <div>Total Entrenamientos</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #6f42c1, #59359a); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2.5em; font-weight: bold;">${Math.round(teamsStats.reduce((sum, team) => sum + team.attendanceStats.averageAttendance, 0) / teamsStats.length)}%</div>
                                <div>Promedio General</div>
                            </div>
                        </div>
                        
                        <!-- Comparative Table -->
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr style="background: #17a2b8; color: white;">
                                        <th style="padding: 15px; text-align: left; position: sticky; top: 0; z-index: 10;">� Equipo</th>
                                        <th style="padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10;">👥 Jugadores</th>
                                        <th style="padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10;">🏃 Entrenamientos</th>
                                        <th style="padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10;">✅ Asistencias</th>
                                        <th style="padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10;">⚠️ Tardanzas</th>
                                        <th style="padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10;">❌ Faltas</th>
                                        <th style="padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10;">📊 % Asistencia</th>
                                        <th style="padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10;">🏆 Ranking</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                // Generate table rows
                teamsStats.forEach((team, index) => {
                    const stats = team.attendanceStats;
                    const percentage = stats.averageAttendance;
                    let rankingBadge, rowBg;
                    
                    // Determine ranking badge and row background
                    if (index === 0) {
                        rankingBadge = `<span style="background: #ffd700; color: #333; padding: 5px 10px; border-radius: 15px; font-weight: bold;">🥇 1°</span>`;
                        rowBg = '#fff3cd';
                    } else if (index === 1) {
                        rankingBadge = `<span style="background: #c0c0c0; color: #333; padding: 5px 10px; border-radius: 15px; font-weight: bold;">🥈 2°</span>`;
                        rowBg = '#f8f9fa';
                    } else if (index === 2) {
                        rankingBadge = `<span style="background: #cd7f32; color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold;">🥉 3°</span>`;
                        rowBg = '#f8f9fa';
                    } else {
                        rankingBadge = `<span style="background: #6c757d; color: white; padding: 5px 10px; border-radius: 15px;">${index + 1}°</span>`;
                        rowBg = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    }
                    
                    // Performance indicator
                    let performanceColor;
                    if (percentage >= 85) performanceColor = '#28a745';
                    else if (percentage >= 70) performanceColor = '#ffc107';
                    else if (percentage >= 50) performanceColor = '#fd7e14';
                    else performanceColor = '#dc3545';
                    
                    html += `
                        <tr style="background: ${rowBg}; border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px; border-right: 1px solid #dee2e6;">
                                <div style="font-weight: bold; color: #2c5aa0;">${team.name}</div>
                                <small style="color: #666;">${team.category}</small>
                            </td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; font-weight: bold;">${team.playersCount}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; font-weight: bold;">${team.trainingsCount}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; color: #28a745; font-weight: bold;">${stats.totalPresents || 0}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; color: #ffc107; font-weight: bold;">${stats.totalLates || 0}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; color: #dc3545; font-weight: bold;">${stats.totalAbsents || 0}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6;">
                                <span style="background: ${performanceColor}; color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold;">
                                    ${percentage}%
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                ${rankingBadge}
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Analysis Section -->
                        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="margin: 0 0 15px 0; color: #495057;">📈 Análisis Comparativo</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div>
                                    <h5 style="color: #28a745; margin: 0 0 10px 0;">🏆 Mejor Equipo</h5>
                                    <p style="margin: 0; font-weight: bold;">${teamsStats[0].name}</p>
                                    <small style="color: #666;">${teamsStats[0].attendanceStats.averageAttendance}% de asistencia</small>
                                </div>
                                <div>
                                    <h5 style="color: #17a2b8; margin: 0 0 10px 0;">👥 Equipo Más Grande</h5>
                                    <p style="margin: 0; font-weight: bold;">${teamsStats.reduce((max, team) => team.playersCount > max.playersCount ? team : max).name}</p>
                                    <small style="color: #666;">${teamsStats.reduce((max, team) => team.playersCount > max.playersCount ? team : max).playersCount} jugadores</small>
                                </div>
                                <div>
                                    <h5 style="color: #ffc107; margin: 0 0 10px 0;">🏃 Más Entrenamientos</h5>
                                    <p style="margin: 0; font-weight: bold;">${teamsStats.reduce((max, team) => team.trainingsCount > max.trainingsCount ? team : max).name}</p>
                                    <small style="color: #666;">${teamsStats.reduce((max, team) => team.trainingsCount > max.trainingsCount ? team : max).trainingsCount} sesiones</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Export Actions -->
                        <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;">
                            <div class="button-group" style="justify-content: center;">
                                <button class="btn btn-success" onclick="exportComparativeReport('excel')">📊 Exportar Excel</button>
                                <button class="btn btn-info" onclick="exportComparativeReport('pdf')">📄 Exportar PDF</button>
                                <button class="btn btn-warning" onclick="printComparativeReport()">🖨️ Imprimir</button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error generating comparative report:', error);
                container.innerHTML = `<div class="message error">Error generando reporte comparativo: ${error.message}</div>`;
            }
        }
        
        // 3. Reporte de Tendencias
        function generateTrendsReport() {
            showMessage('Reporte de tendencias y evolución próximamente disponible', 'info');
            // TODO: Implement trends report with line charts
        }
        
        // 4. Reporte de Justificaciones
        function generateJustificationsReport() {
            showMessage('Reporte de justificaciones próximamente disponible', 'info');
            // TODO: Implement justifications report
        }
        
        // 5. Reporte de Puntualidad
        function generatePunctualityReport() {
            showMessage('Reporte de puntualidad próximamente disponible', 'info');
            // TODO: Implement punctuality report
        }
        
        // 7. Reporte Individual de Jugador
        function generateIndividualReport() {
            showMessage('Ficha individual de jugador próximamente disponible', 'info');
            // TODO: Implement individual player report
        }
        
        // Función de exportación
        function exportReport(reportType, format) {
            if (format === 'pdf') {
                window.print(); // Simple print for now
                showMessage('Usa la función de imprimir del navegador para generar PDF', 'info');
            } else if (format === 'excel') {
                showMessage('Exportación a Excel próximamente disponible', 'info');
                // TODO: Implement Excel export
            }
        }
        
        // ==========================================
        // PLAYER IMAGE FUNCTIONS
        // ==========================================
        
        // Generate player image HTML with fallback to team jersey
        function generatePlayerImageHTML(player, size = '60px', showPlayerInfo = false) {
            // Debug logging
            if (player.name === 'Abdo Martina') {
                console.log('� DEBUG - Abdo Martina image data:', {
                    playerPhoto: player.player_photo,
                    playerPhotoType: typeof player.player_photo,
                    playerPhotoLength: player.player_photo ? player.player_photo.length : 0,
                    teamJerseyPhoto: window.currentTeamJerseyPhoto ? 'exists' : 'null',
                    teamName: window.currentTeamName
                });
            }
            
            // Check for valid player photo
            if (player.player_photo && 
                typeof player.player_photo === 'string' && 
                player.player_photo.trim().length > 10 &&
                player.player_photo.startsWith('data:image') &&
                player.player_photo !== '{}' &&
                player.player_photo !== '[]' &&
                player.player_photo !== 'null') {
                
                let playerInfoOverlay = '';
                if (showPlayerInfo) {
                    playerInfoOverlay = `
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); color: white; padding: 2px 4px; font-size: ${parseInt(size) * 0.12}px; text-align: center; border-radius: 0 0 50% 50%;">
                            <div style="font-weight: bold;">${player.nickname || player.name}</div>
                            <div>#${player.jersey_number || '?'}</div>
                        </div>`;
                }
                
                return `<div style="position: relative; display: inline-block;">
                    <img src="${player.player_photo}" alt="${player.name}" style="width: ${size}; height: ${size}; border-radius: 50%; object-fit: cover; border: 2px solid #28a745;" title="Foto personal de ${player.name}">
                    ${playerInfoOverlay}
                </div>`;
            }
            
            // Fallback to team jersey photo
            if (window.currentTeamJerseyPhoto && 
                typeof window.currentTeamJerseyPhoto === 'string' && 
                window.currentTeamJerseyPhoto.trim().length > 10 &&
                window.currentTeamJerseyPhoto.startsWith('data:image')) {
                
                let playerInfoOverlay = '';
                if (showPlayerInfo) {
                    playerInfoOverlay = `
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); text-align: center; font-weight: bold; line-height: 1.1;">
                            <div style="font-size: ${parseInt(size) * 0.15}px;">${player.nickname || player.name.split(' ')[0]}</div>
                            <div style="font-size: ${parseInt(size) * 0.20}px; color: #FFD700;">#${player.jersey_number || '?'}</div>
                        </div>`;
                }
                
                return `<div style="position: relative; display: inline-block;">
                    <img src="${window.currentTeamJerseyPhoto}" alt="Camiseta ${window.currentTeamName || 'equipo'}" style="width: ${size}; height: ${size}; border-radius: 50%; object-fit: cover; border: 2px solid #007bff; opacity: 0.9;" title="Usando imagen de camiseta del equipo (${player.name} no tiene foto personal)">
                    ${playerInfoOverlay}
                    <div style="position: absolute; bottom: -2px; right: -2px; background: #007bff; color: white; border-radius: 50%; width: ${parseInt(size) * 0.25}px; height: ${parseInt(size) * 0.25}px; display: flex; align-items: center; justify-content: center; font-size: ${parseInt(size) * 0.15}px; border: 1px solid white;" title="Imagen de camiseta del equipo">👕</div>
                </div>`;
            }
            
            // Default avatar with player info overlay
            let playerInfoOverlay = '';
            if (showPlayerInfo) {
                playerInfoOverlay = `
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(100,100,100,0.8)); color: white; padding: 2px 4px; font-size: ${parseInt(size) * 0.12}px; text-align: center; border-radius: 0 0 50% 50%;">
                        <div style="font-weight: bold;">${player.nickname || player.name.split(' ')[0]}</div>
                        <div>#${player.jersey_number || '?'}</div>
                    </div>`;
            }
            
            return `<div style="position: relative; display: inline-block;">
                        <div style="width: ${size}; height: ${size}; border-radius: 50%; background: linear-gradient(45deg, #f0f0f0, #e0e0e0); display: flex; align-items: center; justify-content: center; margin: 0 auto; border: 2px solid #ddd;" title="Sin foto - ${player.name}">
                            <span style="font-size: ${parseInt(size) * 0.4}px; color: #666;">👤</span>
                        </div>
                        ${playerInfoOverlay}
                    </div>`;
        }

        // ==========================================
        // END REPORTS FUNCTIONS
        // ==========================================
        
        // Export functions for comparative report
        function exportComparativeReport(format) {
            if (format === 'excel') {
                showMessage('Exportación a Excel próximamente disponible', 'info');
            } else if (format === 'pdf') {
                showMessage('Exportación a PDF próximamente disponible', 'info');
            }
        }
        
        function printComparativeReport() {
            window.print();
        }

        // =============================================
        // MÓDULO DE FORMACIONES INTEGRADO
        // =============================================
        
        let formationCurrentStep = 1;
        let formationSelectedTeam = null;
        let formationPlayers = [];
        let fieldPositions = [];
        let substitutePlayers = [];
        
        // Datos de formaciones predefinidas según especificaciones exactas
        const formationPresets = {
            '1-4-3-3': {
                name: '1-4-3-3 (1 Arquera, 4 Defensoras, 3 Mediocampistas, 3 Delanteras)',
                positions: [
                    // Arquera
                    {x: 50, y: 92, role: 'goalkeeper'},
                    // Defensoras (4)
                    {x: 20, y: 75, role: 'defender'}, {x: 40, y: 75, role: 'defender'}, 
                    {x: 60, y: 75, role: 'defender'}, {x: 80, y: 75, role: 'defender'},
                    // Mediocampistas (3)
                    {x: 30, y: 50, role: 'midfielder'}, {x: 50, y: 50, role: 'midfielder'}, {x: 70, y: 50, role: 'midfielder'},
                    // Delanteras (3)
                    {x: 30, y: 25, role: 'forward'}, {x: 50, y: 25, role: 'forward'}, {x: 70, y: 25, role: 'forward'}
                ]
            },
            '1-3-4-3': {
                name: '1-3-4-3 (1 Arquera, 3 Defensoras, 4 Mediocampistas, 3 Delanteras)',
                positions: [
                    // Arquera
                    {x: 50, y: 92, role: 'goalkeeper'},
                    // Defensoras (3)
                    {x: 30, y: 75, role: 'defender'}, {x: 50, y: 75, role: 'defender'}, {x: 70, y: 75, role: 'defender'},
                    // Mediocampistas (4)
                    {x: 20, y: 50, role: 'midfielder'}, {x: 40, y: 50, role: 'midfielder'}, 
                    {x: 60, y: 50, role: 'midfielder'}, {x: 80, y: 50, role: 'midfielder'},
                    // Delanteras (3)
                    {x: 30, y: 25, role: 'forward'}, {x: 50, y: 25, role: 'forward'}, {x: 70, y: 25, role: 'forward'}
                ]
            },
            '1-4-4-2': {
                name: '1-4-4-2 (1 Arquera, 4 Defensoras, 4 Mediocampistas, 2 Delanteras)',
                positions: [
                    // Arquera
                    {x: 50, y: 92, role: 'goalkeeper'},
                    // Defensoras (4)
                    {x: 20, y: 75, role: 'defender'}, {x: 40, y: 75, role: 'defender'}, 
                    {x: 60, y: 75, role: 'defender'}, {x: 80, y: 75, role: 'defender'},
                    // Mediocampistas (4)
                    {x: 20, y: 50, role: 'midfielder'}, {x: 40, y: 50, role: 'midfielder'}, 
                    {x: 60, y: 50, role: 'midfielder'}, {x: 80, y: 50, role: 'midfielder'},
                    // Delanteras (2)
                    {x: 40, y: 25, role: 'forward'}, {x: 60, y: 25, role: 'forward'}
                ]
            }
        };

        // Variable global para el sistema click-click de formación
        let selectedPlayerForFormation = null;

        // Inicializar módulo de formaciones cuando se carga la pestaña
        function initFormationsModule() {
            console.log('Inicializando módulo de formaciones...');
            loadTeamsForFormations();
            setupFormationEventListeners();
        }

        // Cargar equipos para formaciones
        async function loadTeamsForFormations() {
            const select = document.getElementById('formations-team-select');
            select.innerHTML = '<option value="">Cargando equipos...</option>';
            
            try {
                const response = await fetch('/api/teams', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success && data.teams.length > 0) {
                    select.innerHTML = '<option value="">Selecciona un equipo...</option>';
                    data.teams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = `${team.name} (${team.club_name || 'Sin club'})`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No hay equipos disponibles</option>';
                }
            } catch (error) {
                console.error('Error cargando equipos:', error);
                select.innerHTML = '<option value="">Error cargando equipos</option>';
            }
        }

        // Configurar event listeners para formaciones
        function setupFormationEventListeners() {
            // Navegación entre pasos
            document.getElementById('step1-next').addEventListener('click', () => {
                if (formationSelectedTeam) {
                    showFormationStep(2);
                    loadPlayersForFormation();
                }
            });

            document.getElementById('step2-back').addEventListener('click', () => showFormationStep(1));
            document.getElementById('step2-next').addEventListener('click', () => showFormationStep(3));
            document.getElementById('step3-back').addEventListener('click', () => showFormationStep(2));

            // Selección de equipo
            document.getElementById('formations-team-select').addEventListener('change', function() {
                formationSelectedTeam = this.value;
                document.getElementById('step1-next').disabled = !formationSelectedTeam;
            });

            // Formaciones predefinidas
            Object.keys(formationPresets).forEach(presetKey => {
                document.getElementById(`formation-${presetKey}`).addEventListener('click', () => {
                    applyFormationPreset(presetKey);
                });
            });

            // Limpiar formación
            document.getElementById('clear-formation').addEventListener('click', clearFormation);

            // Guardar formación
            document.getElementById('step3-save').addEventListener('click', saveFormation);

            // Exportar imagen
            document.getElementById('step3-export').addEventListener('click', exportFormationImage);

            // Establecer fecha actual por defecto
            document.getElementById('match-date').value = new Date().toISOString().split('T')[0];

            // Configurar drag & drop para área de suplentes
            setupSubstitutesDropZone();
        }

        // Configurar zona de drop para suplentes
        function setupSubstitutesDropZone() {
            const substitutesArea = document.getElementById('substitutes-area');
            
            substitutesArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });

            substitutesArea.addEventListener('dragleave', function(e) {
                this.classList.remove('drag-over');
            });

            substitutesArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                const playerId = e.dataTransfer.getData('text/plain');
                const playerData = JSON.parse(e.dataTransfer.getData('player-data'));
                
                addToSubstitutes(playerData);
            });
        }

        // Agregar jugadora a suplentes
        function addToSubstitutes(player) {
            // Verificar límite de suplentes
            if (substitutePlayers.length >= 9) {
                showMessage('Máximo 9 suplentes permitidos', 'error');
                return;
            }

            // Verificar si ya está en suplentes o en el campo
            if (player.isSubstitute || player.assigned) {
                return;
            }

            // Agregar a suplentes
            player.isSubstitute = true;
            substitutePlayers.push(player);

            // Actualizar visualización
            renderAvailablePlayers();
            updateSubstitutesDisplay();
        }

        // Mostrar paso específico
        function showFormationStep(step) {
            // Ocultar todos los pasos
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`step${i}`).style.display = 'none';
            }
            // Mostrar paso actual
            document.getElementById(`step${step}`).style.display = 'block';
            formationCurrentStep = step;
        }

        // Cargar jugadoras para formación - CORREGIDO
        async function loadPlayersForFormation() {
            if (!formationSelectedTeam) return;

            const container = document.getElementById('available-players-list');
            container.innerHTML = '<div style="text-align: center; padding: 20px; font-size: 0.9rem;">Cargando jugadoras...</div>';

            try {
                // CORREGIDO: Usar la ruta correcta que funciona en el backend
                const response = await fetch(`/api/players?team_id=${formationSelectedTeam}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError('Token expired', response);
                    return;
                }
                
                const data = await response.json();
                console.log('🔍 DEBUG: Players data received:', data);
                console.log('🔍 DEBUG: Sample player data:', data.players?.[0]);

                if (data.success && data.players && data.players.length > 0) {
                    formationPlayers = data.players.map(player => {
                        console.log(`🔍 Player ${player.name} - photo check:`, {
                            hasPlayerPhoto: !!player.player_photo,
                            playerPhotoLength: player.player_photo ? player.player_photo.length : 0,
                            startsWithDataImage: player.player_photo ? player.player_photo.startsWith('data:image') : false
                        });
                        return {
                            ...player,
                            assigned: false,
                            isSubstitute: false
                        };
                    });
                    console.log('✅ Jugadoras cargadas:', formationPlayers.length);
                    renderAvailablePlayers();
                    createFieldPositions();
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666; font-size: 0.9rem;">No hay jugadoras en este equipo</div>';
                    console.log('⚠️ No players found for team:', formationSelectedTeam);
                }
            } catch (error) {
                console.error('❌ Error cargando jugadoras:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545; font-size: 0.9rem;">Error cargando jugadoras</div>';
            }
        }

        // Renderizar jugadoras disponibles - MEJORADO MOBILE-FRIENDLY
        function renderAvailablePlayers() {
            const container = document.getElementById('available-players-list');
            container.innerHTML = '';

            // Filtrar jugadoras: no asignadas, no en suplentes
            const availablePlayers = formationPlayers.filter(player => {
                const isInField = fieldPositions.some(pos => pos.player && pos.player.id === player.id);
                const isInSubstitutes = substitutePlayers.some(sub => sub.id === player.id);
                return !player.assigned && !isInField && !isInSubstitutes;
            });

            if (availablePlayers.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 15px; color: #666; font-size: 0.85rem;">Todas las jugadoras están asignadas</div>';
                return;
            }

            // Crear grid container
            const grid = document.createElement('div');
            grid.className = 'player-grid-list';
            grid.style.cssText = `
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 12px;
                padding: 8px 0;
            `;

            players.forEach(player => {
                const attendance = attendanceMap[player.id];
                const status = attendance ? attendance.status : 'ausente';
                const excuse = attendance ? attendance.excuse_reason || '' : '';
                html += `
                    <div class="attendance-player-row" style="display: flex; flex-wrap: wrap; align-items: center; padding: 15px; border: 1px solid #ddd; border-radius: 6px; background: #fafafa; gap: 10px;">
                        <div style="flex: 0 0 160px; max-width: 160px; min-width: 80px; font-weight: bold; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 1rem;">
                            ${player.nickname}
                        </div>
                        <div style="flex: 1 1 220px; min-width: 180px; display: flex; gap: 10px; align-items: center; justify-content: flex-start;">
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="radio" name="status_${player.id}" value="presente" ${status === 'presente' ? 'checked' : ''}>
                                <span style="color: #4CAF50; font-weight: bold;">✅ P</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="radio" name="status_${player.id}" value="tarde" ${status === 'tarde' ? 'checked' : ''}>
                                <span style="color: #FF9800; font-weight: bold;">⏰ T</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="radio" name="status_${player.id}" value="ausente" ${status === 'ausente' ? 'checked' : ''}>
                                <span style="color: #f44336; font-weight: bold;">❌ A</span>
                            </label>
                        </div>
                        <div style="flex: 0 0 150px; max-width: 150px; min-width: 100px;">
                            <input type="text" id="excuse_${player.id}" value="${excuse}" placeholder="Motivo (opcional)"
                                   style="width: 100%; min-width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        </div>
                    </div>
                `;
            });
                    <div style="text-align: center; width: 100%;">
                        <div style="font-weight: 700; font-size: 0.95rem; color: #222; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${nickname}</div>
                        <div style="font-size: 0.8rem; color: #666; font-weight: 500; margin-bottom: 2px;">${position}</div>
                    </div>
                `;

                // Hover effects
                playerDiv.addEventListener('mouseenter', function() {
                    this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.13)';
                    this.style.borderColor = positionColor;
                });
                playerDiv.addEventListener('mouseleave', function() {
                    this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                    this.style.borderColor = 'transparent';
                });

                // Drag and click events (igual que antes)
                playerDiv.draggable = true;
                playerDiv.dataset.playerId = player.id;
                playerDiv.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', player.id);
                    e.dataTransfer.setData('player-data', JSON.stringify(player));
                    this.style.cursor = 'grabbing';
                    this.style.opacity = '0.7';
                });
                playerDiv.addEventListener('dragend', function(e) {
                    this.style.cursor = 'grab';
                    this.style.opacity = '1';
                });
                playerDiv.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const previousSelected = document.querySelector('.player-item-grid.selected');
                    if (previousSelected) {
                        previousSelected.classList.remove('selected');
                        previousSelected.style.borderColor = 'transparent';
                        previousSelected.style.backgroundColor = 'white';
                    }
                    selectedPlayerForFormation = player;
                    this.classList.add('selected');
                    this.style.borderColor = positionColor;
                    this.style.backgroundColor = '#f8f9fa';
                    showToast(`${nickname} seleccionada. Ahora haz clic en una posición del campo para asignarla.`, 'info');
                    console.log('Jugadora seleccionada:', player.name);
                });

                grid.appendChild(playerDiv);
            });

            container.appendChild(grid);
        }

        // Función centralizada para actualizar todas las visualizaciones
        function updateFieldDisplay() {
            // Actualizar las posiciones del campo
            fieldPositions.forEach((pos, index) => {
                if (pos.player && pos.element) {
                    pos.element.innerHTML = createPlayerHTML(pos.player, true, index);
                    pos.element.style.background = 'transparent';
                } else if (pos.element) {
                    pos.element.innerHTML = '';
                    pos.element.style.background = 'rgba(255,255,255,0.1)';
                }
            });
            
            // Actualizar listas
            renderAvailablePlayers();
        }

        // Obtener color según posición
        function getPositionColor(position) {
            const colors = {
                'Portera': '#4ecdc4',
                'Arquera': '#4ecdc4',
                'Defensora': '#45b7d1',
                'Mediocampista': '#f9ca24',
                'Delantera': '#eb4d4b'
            };
            return colors[position] || '#6c757d';
        }

        // Crear posiciones en el campo - MEJORADO PARA CAMPO 3D
        function createFieldPositions() {
            const field = document.getElementById('field-positions');
            field.innerHTML = '';
            fieldPositions = [];

            // Crear 11 posiciones predefinidas en formación 1-4-3-3 (la primera de nuestras formaciones)
            const defaultPositions = formationPresets['1-4-3-3'].positions;
            
            defaultPositions.forEach((pos, index) => {
                const positionSlot = document.createElement('div');
                positionSlot.className = 'field-position-slot';
                positionSlot.style.cssText = `
                    position: absolute;
                    left: ${pos.x}%;
                    top: ${pos.y}%;
                    width: 50px;
                    height: 50px;
                    border: 3px dashed rgba(255,255,255,0.8);
                    border-radius: 50%;
                    transform: translate(-50%, -50%);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: rgba(255,255,255,0.2);
                    backdrop-filter: blur(5px);
                    transition: all 0.3s ease;
                    pointer-events: auto;
                    cursor: pointer;
                    z-index: 10;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                `;
                
                positionSlot.dataset.positionIndex = index;
                positionSlot.dataset.role = pos.role;

                // Hover effect
                positionSlot.addEventListener('mouseenter', function() {
                    if (!fieldPositions[index].player) {
                        this.style.background = 'rgba(255,255,255,0.4)';
                        this.style.borderColor = 'white';
                        this.style.transform = 'translate(-50%, -50%) scale(1.1)';
                    }
                });

                positionSlot.addEventListener('mouseleave', function() {
                    if (!fieldPositions[index].player) {
                        this.style.background = 'rgba(255,255,255,0.2)';
                        this.style.borderColor = 'rgba(255,255,255,0.8)';
                        this.style.transform = 'translate(-50%, -50%) scale(1)';
                    }
                });

                // Eventos drag & drop
                positionSlot.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.style.background = 'rgba(46, 213, 115, 0.4)';
                    this.style.borderColor = '#2ed573';
                    this.style.transform = 'translate(-50%, -50%) scale(1.1)';
                });

                positionSlot.addEventListener('dragleave', function(e) {
                    if (!fieldPositions[index].player) {
                        this.style.background = 'rgba(255,255,255,0.2)';
                        this.style.borderColor = 'rgba(255,255,255,0.8)';
                        this.style.transform = 'translate(-50%, -50%) scale(1)';
                    }
                });

                positionSlot.addEventListener('drop', function(e) {
                    e.preventDefault();
                    const playerId = e.dataTransfer.getData('text/plain');
                    const playerData = JSON.parse(e.dataTransfer.getData('player-data'));
                    
                    assignPlayerToPosition(playerData, index);
                    this.style.transform = 'translate(-50%, -50%) scale(1)';
                });

                // NUEVO: Sistema click-click para asignar posiciones
                positionSlot.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    if (fieldPositions[index].player) {
                        // Si hay jugadora en la posición, removerla
                        removePlayerFromPosition(index);
                    } else if (selectedPlayerForFormation) {
                        // Si hay una jugadora seleccionada, asignarla a esta posición
                        assignPlayerToPosition(selectedPlayerForFormation, index);
                        // Limpiar selección
                        selectedPlayerForFormation = null;
                        const selectedElement = document.querySelector('.player-item.selected');
                        if (selectedElement) {
                            selectedElement.classList.remove('selected');
                            selectedElement.style.borderColor = 'transparent';
                            selectedElement.style.backgroundColor = 'white';
                        }
                    } else {
                        // No hay jugadora seleccionada
                        showToast('Primero selecciona una jugadora de la lista de disponibles', 'warning');
                    }
                });

                field.appendChild(positionSlot);
                fieldPositions.push({ element: positionSlot, player: null, role: pos.role });
            });

            // Configurar interacción del campo después de crear posiciones
            setTimeout(() => {
                setupFieldInteraction();
            }, 100);
        }

        // Asignar jugadora a posición
        function assignPlayerToPosition(player, positionIndex) {
            // Verificar si ya está asignada en el campo
            if (fieldPositions.some(pos => pos.player && pos.player.id === player.id)) {
                showToast('Esta jugadora ya está asignada a otra posición', 'warning');
                return;
            }

            // Verificar si ya está en suplentes
            if (substitutePlayers.some(sub => sub.id === player.id)) {
                showToast('Esta jugadora ya está en la lista de suplentes', 'warning');
                return;
            }

            // Verificar que la posición está disponible
            if (fieldPositions[positionIndex].player) {
                showToast('Esta posición ya está ocupada', 'warning');
                return;
            }

            // Asignar jugadora a la posición
            fieldPositions[positionIndex].player = player;
            const positionSlot = fieldPositions[positionIndex].element;
            
            const positionColor = getPositionColor(player.main_position || player.position);
            
            positionSlot.innerHTML = createPlayerHTML(player, true, positionIndex);

            // Marcar jugadora como asignada
            player.assigned = true;
            
            // Actualizar listas
            renderAvailablePlayers();
            updateFormationStats();
            
            // Mostrar confirmación
            showToast(`${player.name} asignada a la posición`, 'success');

            // Remover event listeners previos y agregar nuevo con sistema click-click
            const newSlot = positionSlot.cloneNode(true);
            positionSlot.parentNode.replaceChild(newSlot, positionSlot);
            fieldPositions[positionIndex].element = newSlot;
            
            // Agregar event listener para el click en posición ocupada (remover jugadora)
            newSlot.addEventListener('click', function(e) {
                e.stopPropagation();
                removePlayerFromPosition(positionIndex);
            });
        }

        // Remover jugadora de posición
        function removePlayerFromPosition(positionIndex) {
            const position = fieldPositions[positionIndex];
            if (position.player) {
                // Marcar jugadora como disponible
                position.player.assigned = false;
                const playerName = position.player.name;
                position.player = null;
                
                const positionSlot = position.element;
                positionSlot.innerHTML = '';
                
                // Restaurar estilo de posición vacía
                positionSlot.style.background = 'rgba(255,255,255,0.2)';
                positionSlot.style.borderColor = 'rgba(255,255,255,0.8)';
                positionSlot.style.border = '3px dashed rgba(255,255,255,0.8)';
                
                // Remover event listeners y restaurar los originales
                const newSlot = positionSlot.cloneNode(true);
                positionSlot.parentNode.replaceChild(newSlot, positionSlot);
                fieldPositions[positionIndex].element = newSlot;
                
                // Restaurar event listeners originales para posición vacía
                setupPositionEvents(newSlot, positionIndex);
                
                renderAvailablePlayers();
                updateFormationStats();
                
                showToast(`${playerName} removida de la posición`, 'info');
            }
        }

        // Funciones para dispositivos móviles
        function showPlayerSelectionMenu(positionIndex, event) {
            hideAllMenus();
            
            // Filtrar jugadoras disponibles correctamente
            const availablePlayers = formationPlayers.filter(player => {
                const isInField = fieldPositions.some(pos => pos.player && pos.player.id === player.id);
                const isInSubstitutes = substitutePlayers.some(sub => sub.id === player.id);
                return !player.assigned && !isInField && !isInSubstitutes;
            });
            if (availablePlayers.length === 0) {
                showToast('No hay jugadoras disponibles', 'warning');
                return;
            }

            const menu = document.createElement('div');
            menu.className = 'mobile-menu';
            menu.innerHTML = `
                <div class="mobile-menu-header">
                    <h4>Seleccionar Jugadora</h4>
                    <button onclick="hideAllMenus()" class="close-btn">×</button>
                </div>
                <div class="mobile-menu-content">
                    ${availablePlayers.map(player => {
                        const playerImage = getPlayerImage(player);
                        const nickname = player.nickname || player.name.split(' ')[0];
                        const jerseyNumber = player.jersey_number || '?';
                        return `
                            <div class="player-option" onclick="selectPlayerForPositionById(${player.id}, ${positionIndex})">
                                <div class="player-avatar-small">
                                    <img src="${playerImage}" alt="${player.name}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNFMEUwRTAiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNSIgcj0iNiIgZmlsbD0iIzk5OTk5OSIvPgo8cGF0aCBkPSJNOCAzMkM4IDI2LjQ3NzIgMTIuNDc3MiAyMiAxOCAyMkMyMy41MjI4IDIyIDI4IDI2LjQ3NzIgMjggMzJIOFoiIGZpbGw9IiM5OTk5OTkiLz4KPC9zdmc+'">
                                </div>
                                <div class="player-jersey" style="background: ${getPositionColor(player.main_position)};">
                                    ${jerseyNumber}
                                </div>
                                <div class="player-info">
                                    <div class="player-name">${nickname}</div>
                                    <div class="player-position">${player.main_position}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            document.body.appendChild(menu);
            setTimeout(() => menu.classList.add('show'), 10);
        }

        function showPositionMenu(positionIndex, event) {
            hideAllMenus();
            
            const player = fieldPositions[positionIndex].player;
            const menu = document.createElement('div');
            menu.className = 'mobile-menu';
            menu.innerHTML = `
                <div class="mobile-menu-header">
                    <h4>${player.name}</h4>
                    <button onclick="hideAllMenus()" class="close-btn">×</button>
                </div>
                <div class="mobile-menu-content">
                    <div class="player-details">
                        <div class="player-jersey" style="background: ${getPositionColor(player.main_position)};">
                            ${player.jersey_number || '?'}
                        </div>
                        <div class="player-info">
                            <div class="player-name">${player.name}</div>
                            <div class="player-position">${player.main_position}</div>
                        </div>
                    </div>
                    <button class="action-btn remove-btn" onclick="removePlayerFromPosition(${positionIndex}); hideAllMenus();">
                        Quitar de Posición
                    </button>
                </div>
            `;

            document.body.appendChild(menu);
            setTimeout(() => menu.classList.add('show'), 10);
        }

        function selectPlayerForPosition(player, positionIndex) {
            assignPlayerToPosition(player, positionIndex);
            hideAllMenus();
        }

        function selectPlayerForPositionById(playerId, positionIndex) {
            const player = formationPlayers.find(p => p.id === playerId);
            
            if (!player) {
                showToast('Error: Jugadora no encontrada', 'error');
                return;
            }
            
            // Verificar que la jugadora esté disponible
            if (player.assigned) {
                showToast(`${player.name} ya está asignada`, 'warning');
                hideAllMenus();
                return;
            }
            
            // Verificar que no esté en el campo o en suplentes
            const isInField = fieldPositions.some(pos => pos.player && pos.player.id === player.id);
            const isInSubstitutes = substitutePlayers.some(sub => sub.id === player.id);
            
            if (isInField || isInSubstitutes) {
                showToast(`${player.name} ya está asignada`, 'warning');
                hideAllMenus();
                return;
            }
            
            // Asignar jugadora usando la función mejorada
            assignPlayerToPosition(player, positionIndex);
            hideAllMenus();
        }

        function hideAllMenus() {
            document.querySelectorAll('.mobile-menu').forEach(menu => {
                menu.classList.remove('show');
                setTimeout(() => menu.remove(), 300);
            });
        }

        function setupPositionEvents(positionSlot, positionIndex) {
            // NUEVO: Event listeners para sistema click-click en posición vacía
            positionSlot.addEventListener('click', (e) => {
                e.stopPropagation();
                
                if (selectedPlayerForFormation) {
                    // Si hay una jugadora seleccionada, asignarla a esta posición
                    assignPlayerToPosition(selectedPlayerForFormation, positionIndex);
                    // Limpiar selección
                    selectedPlayerForFormation = null;
                    const selectedElement = document.querySelector('.player-item.selected');
                    if (selectedElement) {
                        selectedElement.classList.remove('selected');
                        selectedElement.style.borderColor = 'transparent';
                        selectedElement.style.backgroundColor = 'white';
                    }
                } else {
                    // No hay jugadora seleccionada
                    showToast('Primero selecciona una jugadora de la lista de disponibles', 'warning');
                }
            });
            
            // Mantener eventos touch para dispositivos móviles
            positionSlot.addEventListener('touchstart', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (selectedPlayerForFormation) {
                    assignPlayerToPosition(selectedPlayerForFormation, positionIndex);
                    selectedPlayerForFormation = null;
                    const selectedElement = document.querySelector('.player-item.selected');
                    if (selectedElement) {
                        selectedElement.classList.remove('selected');
                        selectedElement.style.borderColor = 'transparent';
                        selectedElement.style.backgroundColor = 'white';
                    }
                } else {
                    showToast('Primero selecciona una jugadora de la lista de disponibles', 'warning');
                }
            });
        }

        // Función para obtener la imagen de la jugadora con fallbacks MEJORADA
        function getPlayerImage(player) {
            console.log('🔍 getPlayerImage called for:', player.name);
            console.log('🔍 Full player data:', player);
            console.log('🔍 Photo fields check:', {
                player_photo: player.player_photo ? `${player.player_photo.substring(0, 50)}... (length: ${player.player_photo.length})` : 'null/empty',
                image: player.image ? `${player.image.substring(0, 50)}... (length: ${player.image.length})` : 'null/empty',
                currentTeamJerseyPhoto: window.currentTeamJerseyPhoto ? `${window.currentTeamJerseyPhoto.substring(0, 50)}... (length: ${window.currentTeamJerseyPhoto.length})` : 'null/empty'
            });
            
            // 1. PRIORIDAD: Si la jugadora tiene imagen propia en player_photo
            if (player.player_photo && 
                typeof player.player_photo === 'string' && 
                player.player_photo.trim().length > 20 &&
                player.player_photo.startsWith('data:image') &&
                player.player_photo !== '{}' &&
                player.player_photo !== '[]' &&
                player.player_photo !== 'null' &&
                player.player_photo !== 'undefined') {
                console.log('✅ Using player_photo:', player.player_photo.substring(0, 50) + '...');
                return player.player_photo;
            }
            
            // 2. Si no tiene foto en player_photo, verificar el campo 'image'
            if (player.image && 
                typeof player.image === 'string' &&
                player.image.trim().length > 20 &&
                player.image.startsWith('data:image') &&
                player.image !== '{}' &&
                player.image !== '[]' &&
                player.image !== 'null' &&
                player.image !== 'undefined') {
                console.log('✅ Using player.image:', player.image.substring(0, 50) + '...');
                return player.image;
            }
            
            // 3. Si no tiene imagen personal, usar la camiseta del equipo
            if (window.currentTeamJerseyPhoto && 
                typeof window.currentTeamJerseyPhoto === 'string' && 
                window.currentTeamJerseyPhoto.trim().length > 20 &&
                window.currentTeamJerseyPhoto.startsWith('data:image')) {
                console.log('✅ Using team jersey photo:', window.currentTeamJerseyPhoto.substring(0, 50) + '...');
                return window.currentTeamJerseyPhoto;
            }
            
            // Debugging adicional para entender por qué no funciona
            console.log('❌ No valid image found. Debug info:', {
                playerPhotoValid: player.player_photo && player.player_photo.startsWith('data:image'),
                playerImageValid: player.image && player.image.startsWith('data:image'),
                teamJerseyValid: window.currentTeamJerseyPhoto && window.currentTeamJerseyPhoto.startsWith('data:image'),
                teamJerseyExists: !!window.currentTeamJerseyPhoto
            });
            
            // 4. ÚLTIMO RECURSO: placeholder genérico mejorado
            console.log('⚠️ Using generic placeholder for player:', player.name);
            return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM0ZWNkYzQiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNSIgcj0iNiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTggMzJDOCAyNi40NzcyIDEyLjQ3NzIgMjIgMTggMjJDMjMuNTIyOCAyMiAyOCAyNi40NzcyIDI4IDMySEhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4=';
        }

        // Función para crear el HTML de la jugadora con imagen y datos
        function createPlayerHTML(player, showRemoveButton = false, positionIndex = null) {
            console.log('🎯 createPlayerHTML called for:', player.name);
            const nickname = player.nickname || player.name.split(' ')[0];
            const jerseyNumber = player.jersey_number || '?';
            
            // Usar generatePlayerImageHTML con tamaño reducido y overlays siempre visibles
            const playerImageHTML = generatePlayerImageHTML(player, '50px', true);

            return `
                <div class="player-field-container" style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                    ${playerImageHTML}
                    <div class="player-info" style="text-align: center;">
                        <span class="player-nickname" style="font-size: 0.85rem; font-weight: 600; color: #222;">${nickname}</span>
                        <span class="player-number" style="font-size: 0.8rem; color: #007bff; font-weight: 500;">#${jerseyNumber}</span>
                    </div>
                    ${showRemoveButton ? `<button class="remove-player-btn" onclick="event.stopPropagation(); removePlayerFromPosition(${positionIndex})" style="position: absolute; top: -5px; right: -5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">×</button>` : ''}
                </div>
            `;
        }

        // Mostrar toast messages
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Actualizar estadísticas de formación
        function updateFormationStats() {
            const stats = {
                goalkeepers: 0,
                defenders: 0,
                midfielders: 0,
                forwards: 0,
                total: 0
            };

            fieldPositions.forEach(pos => {
                if (pos.player) {
                    stats.total++;
                    switch(pos.role) {
                        case 'goalkeeper': stats.goalkeepers++; break;
                        case 'defender': stats.defenders++; break;
                        case 'midfielder': stats.midfielders++; break;
                        case 'forward': stats.forwards++; break;
                    }
                }
            });

            document.getElementById('goalkeepers-count').textContent = stats.goalkeepers;
            document.getElementById('defenders-count').textContent = stats.defenders;
            document.getElementById('midfielders-count').textContent = stats.midfielders;
            document.getElementById('forwards-count').textContent = stats.forwards;
            document.getElementById('total-on-field').textContent = stats.total;
        }

        // Aplicar formación predefinida
        function applyFormationPreset(presetKey) {
            clearFormation();
            const preset = formationPresets[presetKey];
            
            preset.positions.forEach((pos, index) => {
                const positionSlot = fieldPositions[index].element;
                positionSlot.style.left = pos.x + '%';
                positionSlot.style.top = pos.y + '%';
                fieldPositions[index].role = pos.role;
                positionSlot.dataset.role = pos.role;
                
                // CORREGIDO: Restaurar event listeners para el sistema click-click
                const newSlot = positionSlot.cloneNode(true);
                positionSlot.parentNode.replaceChild(newSlot, positionSlot);
                fieldPositions[index].element = newSlot;
                setupPositionEvents(newSlot, index);
            });
            
            showToast(`Formación ${presetKey} aplicada`, 'success');
        }

        // Limpiar formación
        function clearFormation() {
            fieldPositions.forEach(pos => {
                if (pos.player) {
                    pos.player.assigned = false;
                    pos.player = null;
                }
                pos.element.innerHTML = '';
                pos.element.style.background = 'rgba(255,255,255,0.1)';
            });
            
            substitutePlayers.forEach(player => {
                player.isSubstitute = false;
            });
            substitutePlayers = [];
            
            renderAvailablePlayers();
            updateFormationStats();
            updateSubstitutesDisplay();
        }

        // Actualizar display de suplentes
        function updateSubstitutesDisplay() {
            const container = document.getElementById('substitutes-area');
            const countElement = document.getElementById('substitutes-count');
            
            if (substitutePlayers.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px; font-size: 0.8rem;">Click en suplentes para volver a disponibles</div>';
            } else {
                container.innerHTML = '';
                substitutePlayers.forEach(player => {
                    const subDiv = document.createElement('div');
                    subDiv.className = 'substitute-item';
                    subDiv.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 8px;
                        margin: 4px 0;
                        background: white;
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        border: 1px solid #dee2e6;
                    `;
                    
                    const positionColor = getPositionColor(player.main_position || player.position);
                    const playerImage = getPlayerImage(player);
                    const nickname = player.nickname || player.name.split(' ')[0];
                    const jerseyNumber = player.jersey_number || '?';
                    
                    subDiv.innerHTML = `
                        <div class="player-avatar-small" style="border-color: ${positionColor};">
                            <img src="${playerImage}" alt="${player.name}" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNFMEUwRTAiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNSIgcj0iNiIgZmlsbD0iIzk5OTk5OSIvPgo8cGF0aCBkPSJNOCAzMkM4IDI2LjQ3NzIgMTIuNDc3MiAyMiAxOCAyMkMyMy41MjI4IDIyIDI4IDI2LjQ3NzIgMjggMzJIOFoiIGZpbGw9IiM5OTk5OTkiLz4KPC9zdmc+'">
                        </div>
                        <div style="width: 22px; height: 22px; border-radius: 50%; background: ${positionColor}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.7rem; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                            ${jerseyNumber}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 0.8rem; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #333;">${nickname}</div>
                            <div style="font-size: 0.65rem; color: #666; line-height: 1;">${player.main_position || player.position || 'Sin posición'}</div>
                        </div>
                    `;
                    
                    // NUEVO: Click en toda la suplente para regresar a disponibles
                    subDiv.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        removeFromSubstitutes(player.id);
                        showToast(`${nickname} regresa a jugadoras disponibles`, 'info');
                    });
                    
                    // Hover effects
                    subDiv.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#f8f9fa';
                        this.style.borderColor = positionColor;
                        this.style.transform = 'translateY(-1px)';
                        this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    });
                    
                    subDiv.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'white';
                        this.style.borderColor = '#dee2e6';
                        this.style.transform = 'translateY(0)';
                        this.style.boxShadow = 'none';
                    });
                    
                    container.appendChild(subDiv);
                });
            }
            
            countElement.textContent = substitutePlayers.length;
        }

        // Remover de suplentes
        function removeFromSubstitutes(playerId) {
            const playerIndex = substitutePlayers.findIndex(p => p.id === playerId);
            if (playerIndex > -1) {
                substitutePlayers[playerIndex].isSubstitute = false;
                substitutePlayers.splice(playerIndex, 1);
                renderAvailablePlayers();
                updateSubstitutesDisplay();
            }
        }

        // Guardar formación
        async function saveFormation() {
            const formationData = {
                team_id: formationSelectedTeam,
                name: `Formación vs ${document.getElementById('match-rival').value || 'Rival'}`,
                match_date: document.getElementById('match-date').value,
                rival_team: document.getElementById('match-rival').value,
                venue: document.getElementById('match-venue').value,
                match_time: document.getElementById('match-time').value,
                presentation_time: document.getElementById('presentation-time').value,
                tactical_formation: getCurrentFormationData(),
                players_data: getPlayersFormationData(),
                substitutes_data: substitutePlayers.map(p => ({ player_id: p.id, jersey_number: p.jersey_number }))
            };

            try {
                const response = await fetch('/api/formations', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formationData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('Formación guardada exitosamente', 'success');
                    loadSavedFormations();
                } else {
                    showMessage('Error guardando formación: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error guardando formación:', error);
                showMessage('Error de conexión al guardar formación', 'error');
            }
        }

        // Obtener datos actuales de formación
        function getCurrentFormationData() {
            const formation = {};
            fieldPositions.forEach((pos, index) => {
                if (pos.player) {
                    formation[`pos_${index}`] = {
                        player_id: pos.player.id,
                        x: parseFloat(pos.element.style.left),
                        y: parseFloat(pos.element.style.top),
                        role: pos.role
                    };
                }
            });
            return JSON.stringify(formation);
        }

        // Obtener datos de jugadoras en formación
        function getPlayersFormationData() {
            return fieldPositions
                .filter(pos => pos.player)
                .map(pos => ({
                    player_id: pos.player.id,
                    position_role: pos.role,
                    jersey_number: pos.player.jersey_number
                }));
        }

        // Exportar formación como imagen completa
        async function exportFormationImage() {
            try {
                // Mostrar loading
                showToast('Generando imagen de la formación...', 'info');
                
                // Crear un contenedor temporal para la imagen
                const exportContainer = createFormationExportContainer();
                document.body.appendChild(exportContainer);
                
                // Generar la imagen con html2canvas
                const canvas = await html2canvas(exportContainer, {
                    width: 1200,
                    height: 800,
                    scale: 2,
                    useCORS: true,
                    allowTaint: false,
                    backgroundColor: '#ffffff'
                });
                
                // Remover el contenedor temporal
                document.body.removeChild(exportContainer);
                
                // Descargar la imagen
                const link = document.createElement('a');
                link.download = `formacion-${window.currentTeamName || 'equipo'}-${new Date().toLocaleDateString().replace(/\//g, '-')}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Imagen exportada exitosamente', 'success');
                
            } catch (error) {
                console.error('Error al exportar imagen:', error);
                showToast('Error al exportar la imagen. Inténtalo de nuevo.', 'error');
            }
        }

        // Crear contenedor para exportar la formación
        function createFormationExportContainer() {
            const container = document.createElement('div');
            container.style.cssText = `
                position: fixed;
                top: -10000px;
                left: -10000px;
                width: 1200px;
                height: 800px;
                background: linear-gradient(135deg, #2a7f3e 0%, #1e5a2a 100%);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                padding: 40px;
                box-sizing: border-box;
            `;
            
            // Obtener información del equipo y formación
            const teamName = window.currentTeamName || 'Equipo';
            const formation = getCurrentFormationName();
            const starters = getStartingPlayers();
            const substitutes = getSubstitutePlayers();
            const currentDate = new Date().toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            container.innerHTML = `
                <!-- Header -->
                <div style="background: rgba(255,255,255,0.95); border-radius: 15px; padding: 25px; margin-bottom: 30px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                    <h1 style="color: #1e3c72; margin: 0 0 10px 0; font-size: 2.5rem;">🏒 ${teamName}</h1>
                    <h2 style="color: #2a7f3e; margin: 0 0 5px 0; font-size: 1.8rem;">Formación: ${formation}</h2>
                    <p style="color: #666; margin: 0; font-size: 1.2rem;">📅 ${currentDate}</p>
                </div>
                
                <!-- Contenido principal -->
                <div style="display: flex; gap: 30px; height: calc(100% - 150px);">
                    
                    <!-- Campo de hockey -->
                    <div style="flex: 2; background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; position: relative;">
                        <h3 style="color: white; text-align: center; margin-bottom: 15px; font-size: 1.4rem;">⚽ Titulares en Campo</h3>
                        ${createFieldForExport(starters)}
                    </div>
                    
                    <!-- Panel lateral con jugadoras -->
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 20px;">
                        
                        <!-- Titulares -->
                        <div style="background: rgba(255,255,255,0.95); border-radius: 15px; padding: 20px; flex: 1;">
                            <h3 style="color: #1e3c72; margin-bottom: 15px; font-size: 1.3rem; text-align: center;">👥 TITULARES (${starters.length}/11)</h3>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${starters.map(player => createPlayerCardForExport(player, '#28a745')).join('')}
                            </div>
                        </div>
                        
                        <!-- Suplentes -->
                        <div style="background: rgba(255,255,255,0.95); border-radius: 15px; padding: 20px; flex: 1;">
                            <h3 style="color: #dc3545; margin-bottom: 15px; font-size: 1.3rem; text-align: center;">🔄 SUPLENTES (${substitutes.length})</h3>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${substitutes.length > 0 ? substitutes.map(player => createPlayerCardForExport(player, '#6c757d')).join('') : '<p style="text-align: center; color: #666; font-style: italic;">No hay suplentes asignados</p>'}
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="position: absolute; bottom: 10px; right: 20px; color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                    Generado por Hockey Management System
                </div>
            `;
            
            return container;
        }

        // Funciones auxiliares para la exportación
        function getCurrentFormationName() {
            // Detectar la formación actual basada en las posiciones ocupadas
            const occupiedPositions = fieldPositions.filter(pos => pos.player).length;
            if (occupiedPositions === 0) return 'Sin formación';
            
            // Buscar en los presets la formación que coincida
            for (const [name, preset] of Object.entries(formationPresets)) {
                if (preset.positions.length === occupiedPositions) {
                    return name;
                }
            }
            
            return `Formación personalizada (${occupiedPositions} jugadoras)`;
        }

        function getStartingPlayers() {
            return fieldPositions
                .filter(pos => pos.player)
                .map(pos => pos.player)
                .sort((a, b) => (a.jersey_number || 999) - (b.jersey_number || 999));
        }

        function getSubstitutePlayers() {
            const starterIds = fieldPositions
                .filter(pos => pos.player)
                .map(pos => pos.player.id);
                
            return formationPlayers
                .filter(player => !starterIds.includes(player.id))
                .sort((a, b) => (a.jersey_number || 999) - (b.jersey_number || 999));
        }

        function createPlayerCardForExport(player, borderColor) {
            const nickname = player.nickname || player.name.split(' ')[0];
            const position = player.main_position || player.position || 'Sin posición';
            const imageUrl = getPlayerImage(player);
            
            return `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding: 8px; border-left: 4px solid ${borderColor}; background: #f8f9fa; border-radius: 6px;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; border: 2px solid ${borderColor}; flex-shrink: 0;">
                        <img src="${imageUrl}" alt="${player.name}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: bold; color: #333; font-size: 0.9rem; line-height: 1.2;">${nickname}</div>
                        <div style="font-size: 0.75rem; color: #666;">
                            #${player.jersey_number || '?'} • ${position}
                        </div>
                    </div>
                </div>
            `;
        }

        function createFieldForExport(starters) {
            return `
                <div style="width: 100%; height: 100%; background: #2a7f3e; border: 4px solid white; border-radius: 15px; position: relative; overflow: hidden;">
                    
                    <!-- Líneas del campo -->
                    <div style="position: absolute; width: 100%; height: 100%;">
                        <!-- Línea central -->
                        <div style="position: absolute; top: 50%; left: 0; right: 0; height: 3px; background: white; transform: translateY(-50%);"></div>
                        <!-- Círculo central -->
                        <div style="position: absolute; top: 50%; left: 50%; width: 80px; height: 80px; border: 3px solid white; border-radius: 50%; transform: translate(-50%, -50%);"></div>
                        <!-- Áreas de gol -->
                        <div style="position: absolute; top: 0; left: 50%; width: 150px; height: 60px; transform: translateX(-50%); border: 3px solid white; border-top: none; border-radius: 0 0 75px 75px;"></div>
                        <div style="position: absolute; bottom: 0; left: 50%; width: 150px; height: 60px; transform: translateX(-50%); border: 3px solid white; border-bottom: none; border-radius: 75px 75px 0 0;"></div>
                    </div>
                    
                    <!-- Jugadoras en posiciones -->
                    ${createPlayersOnFieldForExport(starters)}
                </div>
            `;
        }

        function createPlayersOnFieldForExport(starters) {
            if (starters.length === 0) {
                return '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 1.2rem; text-align: center;">No hay jugadoras asignadas</div>';
            }
            
            // Usar las posiciones del preset actual o distribuir uniformemente
            const positions = formationPresets['1-4-3-3']?.positions || [];
            
            return starters.map((player, index) => {
                const pos = positions[index] || { x: 50, y: 50 + (index * 10) };
                const imageUrl = getPlayerImage(player);
                const nickname = player.nickname || player.name.split(' ')[0];
                
                return `
                    <div style="position: absolute; left: ${pos.x}%; top: ${pos.y}%; transform: translate(-50%, -50%); text-align: center;">
                        <div style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; border: 3px solid #FFD700; margin: 0 auto 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                            <img src="${imageUrl}" alt="${player.name}" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div style="background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; margin-bottom: 2px; border: 1px solid rgba(255,255,255,0.3);">
                            ${nickname}
                        </div>
                        <div style="background: rgba(0,0,0,0.8); color: #FFD700; padding: 1px 4px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; border: 1px solid rgba(255,215,0,0.5);">
                            #${player.jersey_number || '?'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Cargar formaciones guardadas
        async function loadSavedFormations() {
            const container = document.getElementById('formations-list');
            
            try {
                const response = await fetch('/api/formations', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success && data.formations.length > 0) {
                    container.innerHTML = '';
                    data.formations.forEach(formation => {
                        const formationCard = document.createElement('div');
                        formationCard.style.cssText = `
                            background: #f8f9fa;
                            border-radius: 10px;
                            padding: 15px;
                            border: 2px solid #e9ecef;
                            transition: all 0.3s ease;
                            cursor: pointer;
                        `;
                        
                        formationCard.innerHTML = `
                            <h5 style="margin-bottom: 10px; color: #1e3c72;">${formation.name}</h5>
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                                <div>📅 ${formation.match_date || 'Sin fecha'}</div>
                                <div>🏟️ ${formation.venue || 'Sin cancha'}</div>
                                <div>🆚 ${formation.rival_team || 'Sin rival'}</div>
                            </div>
                            <div style="display: flex; gap: 5px; margin-top: 10px;">
                                <button onclick="loadFormation(${formation.id})" class="btn" style="flex: 1; padding: 5px 10px; font-size: 12px;">📋 Cargar</button>
                                <button onclick="deleteFormation(${formation.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">🗑️</button>
                            </div>
                        `;
                        
                        container.appendChild(formationCard);
                    });
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 40px; grid-column: 1/-1;">
                            <div style="font-size: 3em; margin-bottom: 15px;">🏑</div>
                            <p>No hay formaciones guardadas</p>
                            <p style="font-size: 14px; color: #999;">Crea tu primera formación usando el asistente de arriba</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error cargando formaciones:', error);
                container.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">Error cargando formaciones</div>';
            }
        }

        // Cargar formación específica
        async function loadFormation(formationId) {
            showMessage('Función de cargar formación próximamente disponible', 'info');
        }

        // Eliminar formación
        async function deleteFormation(formationId) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta formación?')) return;
            
            try {
                const response = await fetch(`/api/formations/${formationId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Formación eliminada exitosamente', 'success');
                    loadSavedFormations();
                } else {
                    showMessage('Error eliminando formación: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error eliminando formación:', error);
                showMessage('Error de conexión al eliminar formación', 'error');
            }
        }

        // =============================================
        // FUNCIONES DEL CAMPO 3D
        // =============================================
        
        let currentRotation = 0;
        let currentTilt = 45;

        function rotateField(direction) {
            const fieldWrapper = document.getElementById('fieldWrapper');
            if (!fieldWrapper) return;
            
            switch(direction) {
                case 'left':
                    currentRotation -= 15;
                    break;
                case 'right':
                    currentRotation += 15;
                    break;
                case 'reset':
                    currentRotation = 0;
                    currentTilt = 45;
                    break;
            }
            
            fieldWrapper.style.transform = `rotateX(${currentTilt}deg) rotateZ(${currentRotation}deg)`;
        }

        // Configurar interacción con mouse para rotar el campo
        function setupFieldInteraction() {
            const fieldWrapper = document.getElementById('fieldWrapper');
            if (!fieldWrapper) return;
            
            let isDragging = false;
            let startX = 0;
            let startRotation = 0;

            fieldWrapper.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startRotation = currentRotation;
                fieldWrapper.style.cursor = 'grabbing';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - startX;
                    currentRotation = startRotation + (deltaX * 0.5);
                    fieldWrapper.style.transform = `rotateX(${currentTilt}deg) rotateZ(${currentRotation}deg)`;
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                if (fieldWrapper) {
                    fieldWrapper.style.cursor = 'grab';
                }
            });

            fieldWrapper.style.cursor = 'grab';
        }

        // Initialize dashboard on page load
        checkCoachAccess();
    </script>
</body>
</html>

