<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hockey Management - Dashboard de Entrenador</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
        }
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }
        
        /* Media Queries para Responsive Design */
        @media (min-width: 768px) {
            .dashboard-container {
                padding: 20px;
            }
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        @media (min-width: 768px) {
            .header {
                flex-direction: row;
                justify-content: space-between;
                padding: 20px;
            }
        }
        
        .header h1 {
            color: #1e3c72;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            text-align: center;
        }
        
        @media (min-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        @media (min-width: 768px) {
            .user-info {
                gap: 15px;
                justify-content: flex-end;
            }
        }
        .btn-logout {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        @media (min-width: 768px) {
            .btn-logout {
                padding: 10px 20px;
                font-size: 1rem;
            }
        }
        
        .btn-logout:hover {
            background: #c82333;
        }
        
        .main-nav {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        @media (min-width: 768px) {
            .main-nav {
                padding: 15px;
            }
        }
        
        .nav-tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        @media (min-width: 768px) {
            .nav-tabs {
                gap: 10px;
                justify-content: flex-start;
            }
        }
        
        .nav-tab {
            padding: 10px 16px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
            font-size: 0.85rem;
            flex: 1;
            text-align: center;
            min-width: fit-content;
        }
        
        @media (min-width: 768px) {
            .nav-tab {
                padding: 12px 24px;
                font-size: 1rem;
                flex: none;
            }
        }
        
        @media (max-width: 480px) {
            .nav-tab {
                font-size: 0.75rem;
                padding: 8px 12px;
            }
        }
        .nav-tab.active {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
        }
        .nav-tab:hover:not(.active) {
            background: #e9ecef;
        }
        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }
        
        @media (min-width: 768px) {
            .tab-content {
                padding: 30px;
                min-height: 500px;
            }
        }
        
        .tab-content.active {
            display: block;
        }
        
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .quick-stats {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
        }
        
        .stat-card {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        @media (min-width: 768px) {
            .stat-card {
                padding: 20px;
            }
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        @media (min-width: 768px) {
            .stat-number {
                font-size: 2.5em;
            }
        }
        
        .stat-label {
            font-size: 0.8em;
            opacity: 0.9;
        }
        
        @media (min-width: 768px) {
            .stat-label {
                font-size: 0.9em;
            }
        }
        .welcome-section {
            text-align: center;
            padding: 20px 10px;
        }
        
        @media (min-width: 768px) {
            .welcome-section {
                padding: 40px 20px;
            }
        }
        
        .welcome-section h2 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        @media (min-width: 768px) {
            .welcome-section h2 {
                font-size: 2em;
                margin-bottom: 20px;
            }
        }
        
        .welcome-section p {
            color: #666;
            font-size: 1em;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }
        
        @media (min-width: 768px) {
            .welcome-section p {
                font-size: 1.1em;
            }
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (min-width: 768px) {
            .feature-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 30px;
            }
        }
        
        .feature-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border-left: 5px solid #1e3c72;
        }
        
        @media (min-width: 768px) {
            .feature-card {
                padding: 25px;
            }
        }
        .feature-card h3 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .feature-card p {
            color: #666;
            line-height: 1.5;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-primary {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 60, 114, 0.3);
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .coming-soon {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .coming-soon h3 {
            color: #1e3c72;
            margin-bottom: 15px;
        }
        .coming-soon .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        .teams-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (min-width: 768px) {
            .teams-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
            }
        }
        
        .team-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        @media (min-width: 768px) {
            .team-card {
                padding: 20px;
            }
        }
        
        .team-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: #1e3c72;
        }
        
        .team-card h3 {
            color: #1e3c72;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        @media (min-width: 768px) {
            .team-card h3 {
                font-size: 1.3em;
            }
        }
        
        .team-info {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        @media (min-width: 768px) {
            .team-info {
                gap: 10px;
            }
        }
        
        .team-badge {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        @media (min-width: 768px) {
            .team-badge {
                font-size: 0.85em;
            }
        }
        
        .team-badge.division {
            background: #d4edda;
            color: #155724;
        }
        .team-badge.category {
            background: #cce5ff;
            color: #004085;
        }
        
        .team-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        @media (min-width: 768px) {
            .team-actions {
                gap: 8px;
            }
        }
        .btn-sm {
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 6px;
            flex: 1;
            min-width: fit-content;
            text-align: center;
        }
        
        @media (min-width: 768px) {
            .btn-sm {
                padding: 6px 12px;
                font-size: 12px;
                flex: none;
            }
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (min-width: 480px) {
            .players-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
        
        @media (min-width: 768px) {
            .players-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 20px;
            }
        }
        
        .player-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        @media (min-width: 768px) {
            .player-card {
                padding: 20px;
            }
        }
        
        .player-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: #28a745;
        }
        .player-header {
            margin-bottom: 15px;
        }
        .player-header h4 {
            color: #1e3c72;
            margin: 0 0 5px 0;
            font-size: 1.2em;
        }
        .player-nickname {
            color: #666;
            font-style: italic;
            font-size: 0.9em;
        }
        .player-info {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .jersey-number {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 50%;
            font-weight: bold;
            min-width: 32px;
            text-align: center;
            font-size: 0.9em;
        }
        .player-position {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .starter-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffc107;
            color: #212529;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
        }
        .player-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        /* Report Cards Hover Effects */
        .report-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 15px rgba(0,123,255,0.2);
            transform: translateY(-2px);
        }
        
        /* Custom button styles */
        .btn-purple {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-purple:hover {
            background: #5a2d91;
            transform: translateY(-1px);
        }
        
        /* Loading animation */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        /* ========== RESPONSIVE IMPROVEMENTS ========== */
        
        /* Form Elements */
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        @media (min-width: 768px) {
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px;
                padding: 12px;
            }
        }
        
        /* Button Groups */
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .button-group .btn {
            flex: 1;
            min-width: 120px;
        }
        
        @media (min-width: 768px) {
            .button-group .btn {
                flex: none;
            }
        }
        
        /* Tables Responsive */
        .table-responsive {
            overflow-x: auto;
            margin: 15px 0;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling en iOS */
        }
        
        .table-responsive table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            background: white;
        }
        
        .table-responsive th,
        .table-responsive td {
            padding: 8px 6px !important; /* Override inline styles */
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 12px !important; /* Smaller on mobile */
            white-space: nowrap;
        }
        
        @media (min-width: 768px) {
            .table-responsive th,
            .table-responsive td {
                padding: 12px 15px !important;
                font-size: 14px !important;
            }
        }
        
        @media (min-width: 1024px) {
            .table-responsive th,
            .table-responsive td {
                font-size: 16px !important;
            }
        }
        
        .table-responsive th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
        }
        
        /* Modal Responsive */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 10px;
            padding: 20px;
            border-radius: 12px;
            width: calc(100% - 20px);
            max-width: 500px;
            margin: 50px auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        @media (min-width: 768px) {
            .modal-content {
                margin: 100px auto;
                padding: 30px;
            }
        }
        
        /* Attendance Controls */
        .attendance-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .attendance-controls {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }
        
        .team-selector,
        .training-selector {
            flex: 1;
            max-width: 300px;
        }
        
        /* Player Actions Responsive */
        .player-actions {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        
        @media (min-width: 768px) {
            .player-actions {
                gap: 8px;
            }
        }
        
        /* Reports Grid */
        .reports-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        @media (min-width: 768px) {
            .reports-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
            }
        }
        
        /* KPIs Responsive */
        .kpis-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 480px) {
            .kpis-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* Filter Controls */
        .filter-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        @media (min-width: 768px) {
            .filter-controls {
                flex-direction: row;
                align-items: center;
                flex-wrap: wrap;
            }
        }
        
        /* Small devices specific */
        @media (max-width: 480px) {
            .dashboard-container {
                padding: 5px;
            }
            
            .header {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
            
            .nav-tab {
                font-size: 0.7rem;
                padding: 6px 8px;
            }
            
            .tab-content {
                padding: 10px;
            }
            
            .btn {
                font-size: 12px;
                padding: 8px 16px;
            }
            
            .modal-content {
                margin: 20px 10px;
                padding: 15px;
            }
            
            /* Report optimizations for mobile */
            .ranking-chart-mobile {
                padding: 10px !important;
            }
            
            .ranking-chart-mobile .bar-container {
                margin-bottom: 8px !important;
            }
            
            .ranking-chart-mobile .player-name {
                width: 100px !important;
                font-size: 0.75rem !important;
                line-height: 1.2 !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .ranking-chart-mobile .progress-bar {
                height: 20px !important;
                margin: 0 8px !important;
            }
            
            .ranking-chart-mobile .percentage-text {
                font-size: 0.7rem !important;
            }
        }
        
        /* Touch-friendly interactions */
        @media (hover: none) {
            .btn:hover,
            .nav-tab:hover,
            .team-card:hover,
            .player-card:hover {
                transform: none;
            }
        }
    </style>
    
    <!-- SheetJS para leer archivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>üèí Hockey Management - Dashboard</h1>
            <div class="user-info">
                <span id="user-name">Cargando...</span>
                <button class="btn" onclick="checkTokenStatus()" style="background: #17a2b8; color: white; margin-right: 10px; font-size: 0.8rem;">üîç Debug Token</button>
                <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <!-- Main Navigation -->
        <div class="main-nav">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('overview')">üìä Resumen</button>
                <button class="nav-tab" onclick="showTab('teams')">üë• Mis Equipos</button>
                <button class="nav-tab" onclick="showTab('players')">üèÉ‚Äç‚ôÄÔ∏è Jugadores</button>
                <button class="nav-tab" onclick="showTab('attendance')">üìã Asistencias</button>
                <button class="nav-tab" onclick="showTab('formations')">üèë Formaciones</button>
                <button class="nav-tab" onclick="showTab('matches')">‚öΩ Partidos</button>
                <button class="nav-tab" onclick="showTab('reports')">üìà Reportes</button>
            </div>
        </div>

        <div id="message" class="message"></div>

        <!-- Tab: Resumen -->
        <div id="overview-tab" class="tab-content active">
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-teams">0</div>
                    <div class="stat-label">Equipos Activos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-players">0</div>
                    <div class="stat-label">Jugadoras Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="upcoming-matches">0</div>
                    <div class="stat-label">Pr√≥ximos Partidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="formations-created">0</div>
                    <div class="stat-label">Formaciones Creadas</div>
                </div>
            </div>

            <div class="welcome-section">
                <h2>¬°Bienvenido al Sistema de Gesti√≥n de Hockey!</h2>
                <p>
                    Desde aqu√≠ puedes gestionar todos tus equipos, registrar asistencias a entrenamientos, 
                    crear formaciones t√°cticas visuales y llevar el control completo de tus partidos con 
                    capacidades offline durante los juegos.
                </p>

                <div class="feature-grid">
                    <div class="feature-card">
                        <h3>üìã Registro de Asistencias</h3>
                        <p>
                            Lleva un control detallado de la asistencia de tus jugadoras a los entrenamientos. 
                            Marca presente, tarde o ausente con observaciones adicionales.
                        </p>
                    </div>
                    <div class="feature-card">
                        <h3>üèë Formaciones Visuales</h3>
                        <p>
                            Crea formaciones t√°cticas arrastrando jugadoras a posiciones en la cancha. 
                            Exporta como imagen para compartir con tu equipo.
                        </p>
                    </div>
                    <div class="feature-card">
                        <h3>‚öΩ Gesti√≥n de Partidos</h3>
                        <p>
                            Registra acciones en tiempo real durante los partidos con capacidad offline. 
                            Control de tiempos y cambios de jugadoras autom√°tico.
                        </p>
                    </div>
                    <div class="feature-card">
                        <h3>üìà Reportes Detallados</h3>
                        <p>
                            Genera mapas de calor t√°cticos, estad√≠sticas de rendimiento y reportes 
                            completos para an√°lisis estrat√©gico del equipo.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Mis Equipos -->
        <div id="teams-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">üë• Gesti√≥n de Equipos</h2>
            
            <!-- Header con bot√≥n crear equipo -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <p>Gestiona tus equipos y jugadoras. M√°ximo permitido: <strong id="max-teams-display">-</strong> equipos</p>
                </div>
                <button class="btn btn-primary" onclick="showCreateTeamModal()">
                    ‚ûï Crear Nuevo Equipo
                </button>
            </div>

            <!-- Lista de equipos -->
            <div id="teams-list" class="loading">
                Cargando equipos...
            </div>

            <!-- Modal crear/editar equipo -->
            <div id="team-modal" class="modal">
                <div class="modal-content">
                    <h3 id="modal-title">Crear Nuevo Equipo</h3>
                    <form id="team-form" style="margin-top: 20px;">
                        <div class="form-group">
                            <label>Nombre del Equipo *</label>
                            <input type="text" id="team-name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label>Nombre del Club *</label>
                            <input type="text" id="club-name" name="club_name" required>
                        </div>
                        <div class="form-group">
                            <label>G√©nero del Equipo *</label>
                            <select id="team-gender" name="gender" required onchange="loadDivisionsForGender(this.value)">
                                <option value="">Seleccionar g√©nero...</option>
                                <option value="female">Femenino</option>
                                <option value="male">Masculino</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Divisi√≥n</label>
                            <select id="team-division" name="division_id">
                                <option value="">Primero selecciona el g√©nero...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>M√°ximo de Jugadores</label>
                            <input type="number" id="max-players" name="max_players" min="10" max="50" value="25">
                            <small style="color: #666; font-size: 0.9em; display: block; margin-top: 5px;">N√∫mero m√°ximo de jugadores permitidos en el equipo (por defecto: 25)</small>
                        </div>
                        <div class="button-group">
                            <button type="button" class="btn btn-secondary" onclick="closeTeamModal()">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Guardar Equipo
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tab: Jugadores -->
        <div id="players-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="current-team-name">Selecciona un equipo primero</h2>
                <div id="add-player-btn" style="display: none;">
                    <button class="btn btn-primary" onclick="showCreatePlayerModal()" style="margin-right: 10px;">
                        ‚ûï Agregar Jugador
                    </button>
                    <button class="btn btn-success" onclick="showExcelImportModal()">
                        üìä Importar Excel
                    </button>
                </div>
            </div>
            
            <div id="players-list">
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3em; margin-bottom: 20px;">üèÉ‚Äç‚ôÄÔ∏è</div>
                    <h3>Gesti√≥n de Jugadores</h3>
                    <p>Ve a "Mis Equipos" y haz clic en "üë• Jugadoras" de cualquier equipo para ver y gestionar sus jugadores</p>
                </div>
            </div>

            <!-- Modal para agregar jugador -->
            <div id="player-modal" class="modal">
                <div class="modal-content">
                    <h3 id="player-modal-title">Agregar Jugador</h3>
                    <form id="player-form" style="margin-top: 20px;">
                        <div class="form-group">
                            <label>Nombre Completo *</label>
                            <input type="text" id="player-name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label>Apodo/Nickname</label>
                            <input type="text" id="player-nickname" name="nickname">
                        </div>
                        <div class="form-group">
                            <label>Fecha de Nacimiento *</label>
                            <input type="date" id="player-birth-date" name="birth_date" required>
                        </div>
                        <div class="form-group">
                            <label>Posici√≥n</label>
                            <select id="player-position" name="position">
                                <option value="">Seleccionar posici√≥n...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>N√∫mero de Camiseta</label>
                            <input type="number" id="player-jersey" name="jersey_number" min="1" max="99">
                        </div>
                        <div class="button-group">
                            <button type="button" class="btn btn-secondary" onclick="closePlayerModal()">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Guardar Jugador
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para importar Excel -->
        <div id="excel-import-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 600px; width: 90%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3>üìä Importar Jugadores desde Excel</h3>
                    <button onclick="closeExcelImportModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4>üìã Formato requerido del archivo Excel:</h4>
                    <p>Tu archivo Excel debe tener exactamente estas columnas en la primera fila:</p>
                    <div style="background: white; padding: 15px; border-radius: 4px; margin: 10px 0;">
                        <strong>Columnas obligatorias:</strong><br>
                        <code>Nombre | Apodo | Fecha de Nacimiento | Posici√≥n | N√∫mero de Camiseta</code>
                    </div>
                    <p><strong>Ejemplo de datos:</strong></p>
                    <div style="background: white; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                        Mar√≠a Garc√≠a | Marita | 15/03/1995 | Portera | 1<br>
                        Ana L√≥pez | Ana | 22/07/1998 | Defensora | 2<br>
                        Sofia Rodr√≠guez | | 10/11/1996 | Mediocampista | 10
                    </div>
                    <p style="margin-top: 10px; font-size: 14px; color: #666;">
                        ‚Ä¢ <strong>Fecha de Nacimiento:</strong> Formato DD/MM/YYYY (ejemplo: 15/03/1995)<br>
                        ‚Ä¢ <strong>Apodo:</strong> Puede estar vac√≠o<br>
                        ‚Ä¢ <strong>Posiciones v√°lidas:</strong> Para equipos femeninos: Portera, Arquera, Defensora, Mediocampista, Delantera
                    </p>
                </div>
                
                <form id="excel-import-form" style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Seleccionar archivo Excel:</label>
                        <input type="file" id="excel-file" accept=".xlsx,.xls" required 
                               style="width: 100%; padding: 10px; border: 2px dashed #ddd; border-radius: 8px; cursor: pointer;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeExcelImportModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Cancelar
                        </button>
                        <button type="submit" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            üìä Importar Jugadores
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal: Crear Lista de Asistencia -->
        <div id="attendance-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="background: white; width: 90%; max-width: 600px; margin: 5% auto; padding: 0; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
                <div style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                    <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                        üìã Nueva Lista de Asistencia
                    </h2>
                </div>
                <form id="attendance-form" style="padding: 25px;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Fecha de la Actividad:</label>
                        <input type="date" id="attendance-date" required 
                               style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Tipo de Actividad:</label>
                        <select id="attendance-type" required 
                                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px;">
                            <option value="">Seleccionar tipo...</option>
                            <option value="training">üèãÔ∏è Entrenamiento</option>
                            <option value="match">‚öΩ Partido</option>
                            <option value="meeting">üë• Reuni√≥n</option>
                            <option value="other">üìù Otro</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Descripci√≥n (opcional):</label>
                        <textarea id="attendance-description" rows="3" placeholder="Ej: Entrenamiento de preparaci√≥n f√≠sica..."
                                  style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                        <button type="button" onclick="closeAttendanceModal()" 
                                style="padding: 12px 24px; background: #f5f5f5; color: #333; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: all 0.3s;">
                            ‚ùå Cancelar
                        </button>
                        <button type="submit" 
                                style="padding: 12px 24px; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: all 0.3s;">
                            ‚úÖ Crear Lista
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab: Asistencias -->
        <div id="attendance-tab" class="tab-content">
            <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
                <div style="display: flex; justify-content: between-center; align-items: center; margin-bottom: 20px;">
                    <h2>üìã Gesti√≥n de Asistencias</h2>
                    <button class="btn btn-primary" onclick="showCreateAttendanceModal()" style="margin-left: auto;">
                        ‚ûï Nueva Lista de Asistencia
                    </button>
                </div>
                
                <!-- Selector de equipo para asistencias -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h3>Seleccionar Equipo</h3>
                    <select id="attendance-team-select" onchange="loadAttendanceForTeam()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Selecciona un equipo...</option>
                    </select>
                </div>
                
                <!-- Lista de asistencias -->
                <div id="attendance-list" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üìã</div>
                        <h3>Selecciona un equipo para ver las asistencias</h3>
                        <p>Podr√°s registrar y gestionar las asistencias de entrenamientos y partidos</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Formaciones -->
        <div id="formations-tab" class="tab-content">
            <div class="coming-soon">
                <div class="icon">üèë</div>
                <h3>M√≥dulo de Formaciones</h3>
                <p><strong>PR√ìXIMO A IMPLEMENTAR</strong></p>
                <p>Este m√≥dulo permitir√°:</p>
                <ul style="text-align: left; max-width: 400px; margin: 20px auto;">
                    <li>üéØ Planificaci√≥n visual drag & drop en cancha</li>
                    <li>üì∑ Fotos de jugadoras en posiciones</li>
                    <li>üìù Datos del partido (rival, cancha, fecha)</li>
                    <li>üì§ Exportaci√≥n como imagen para compartir</li>
                    <li>üíæ Guardar formaciones como plantillas</li>
                </ul>
            </div>
        </div>

        <!-- Tab: Partidos -->
        <div id="matches-tab" class="tab-content">
            <div class="coming-soon">
                <div class="icon">‚öΩ</div>
                <h3>Gesti√≥n de Partidos</h3>
                <p>Funcionalidades avanzadas de registro de partidos en desarrollo.</p>
                <p>Incluir√° capacidades offline, control de tiempos y registro de acciones en tiempo real.</p>
            </div>
        </div>

        <!-- Tab: Reportes -->
        <div id="reports-tab" class="tab-content">
            <div style="max-width: 1400px; margin: 0 auto; padding: 20px;">
                <h2>üìà Reportes de Asistencia - Sistema Completo</h2>
                
                <!-- Filtros Globales -->
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h3 style="margin: 0 0 20px 0; color: #2c5aa0;">üîç Filtros de Consulta</h3>
                    <div class="filter-controls">
                        <div class="form-group">
                            <label>Equipo:</label>
                            <select id="reports-team-filter">
                                <option value="">Todos los equipos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Desde:</label>
                            <input type="date" id="reports-date-from">
                        </div>
                        <div class="form-group">
                            <label>Hasta:</label>
                            <input type="date" id="reports-date-to">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="applyReportFilters()" style="width: 100%;">
                                üîç Aplicar Filtros
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Dashboard Principal -->
                <div id="reports-dashboard" style="display: grid; gap: 20px; margin-bottom: 25px;">
                    <!-- Indicadores Clave -->
                    <div class="kpis-container">
                        <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold;" id="kpi-total-players">0</div>
                            <div>Total Jugadores</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold;" id="kpi-total-sessions">0</div>
                            <div>Entrenamientos</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fd7e14, #e55a4e); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold;" id="kpi-avg-attendance">0%</div>
                            <div>Asistencia Promedio</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #6610f2, #e83e8c); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold;" id="kpi-punctuality">0%</div>
                            <div>Puntualidad Promedio</div>
                        </div>
                    </div>
                </div>
                
                <!-- Men√∫ de Reportes -->
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h3 style="margin: 0 0 20px 0; color: #2c5aa0;">üìä Tipos de Reportes Disponibles</h3>
                    <div class="reports-grid">
                        
                        <!-- Reporte 1: General de Asistencias -->
                        <div class="report-card" style="border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; transition: all 0.3s;">
                            <h4 style="margin: 0 0 10px 0; color: #28a745;">üìã 1. Reporte General</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Listado completo con porcentajes de asistencia, ranking y estad√≠sticas generales</p>
                            <button class="btn btn-success" onclick="generateGeneralReport()" style="width: 100%;">
                                Ver Reporte General
                            </button>
                        </div>
                        
                        <!-- Reporte 2: Comparativo por Equipo -->
                        <div class="report-card" style="border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; transition: all 0.3s;">
                            <h4 style="margin: 0 0 10px 0; color: #007bff;">üìä 2. Comparativo Equipos</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Comparaci√≥n de asistencia entre diferentes equipos y categor√≠as</p>
                            <button class="btn btn-primary" onclick="generateComparativeReport()" style="width: 100%;">
                                Ver Comparativo
                            </button>
                        </div>
                        
                        <!-- Reporte 3: Tendencias -->
                        <div class="report-card" style="border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; transition: all 0.3s;">
                            <h4 style="margin: 0 0 10px 0; color: #fd7e14;">üìà 3. Tendencias y Evoluci√≥n</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Evoluci√≥n temporal de asistencia con gr√°ficos de l√≠neas</p>
                            <button class="btn btn-warning" onclick="generateTrendsReport()" style="width: 100%;">
                                Ver Tendencias
                            </button>
                        </div>
                        
                        <!-- Reporte 4: Justificaciones -->
                        <div class="report-card" style="border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; transition: all 0.3s;">
                            <h4 style="margin: 0 0 10px 0; color: #6c757d;">üìù 4. Justificaciones</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">An√°lisis de ausencias justificadas vs injustificadas</p>
                            <button class="btn btn-secondary" onclick="generateJustificationsReport()" style="width: 100%;">
                                Ver Justificaciones
                            </button>
                        </div>
                        
                        <!-- Reporte 5: Puntualidad -->
                        <div class="report-card" style="border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; transition: all 0.3s;">
                            <h4 style="margin: 0 0 10px 0; color: #17a2b8;">‚è∞ 5. Puntualidad</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">An√°lisis detallado de puntualidad y llegadas tarde</p>
                            <button class="btn btn-info" onclick="generatePunctualityReport()" style="width: 100%;">
                                Ver Puntualidad
                            </button>
                        </div>
                        
                        <!-- Reporte 7: Ficha Individual -->
                        <div class="report-card" style="border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; transition: all 0.3s;">
                            <h4 style="margin: 0 0 10px 0; color: #6f42c1;">üë§ 7. Ficha Individual</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Reporte personalizado por jugador con historial completo</p>
                            <button class="btn btn-purple" onclick="generateIndividualReport()" style="width: 100%; background: #6f42c1; color: white;">
                                Ver Ficha Individual
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Contenedor de Reportes -->
                <div id="reports-content" style="min-height: 200px;">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üìä</div>
                        <h3>Sistema de Reportes de Asistencia</h3>
                        <p>Selecciona los filtros deseados y luego elige el tipo de reporte que necesitas generar</p>
                        <p><strong>Consejo:</strong> Para mejores resultados, aplica primero los filtros de equipo y fechas</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get JWT token from localStorage
        function getAuthHeaders() {
            const token = localStorage.getItem('hockey_token');
            if (!token) {
                window.location.href = 'login.html';
                return {};
            }
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }
        
        // Handle authentication errors
        function handleAuthError(error, response = null) {
            if (response && response.status === 401) {
                console.log('Token expired or invalid, redirecting to login');
                showMessage('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'error');
                localStorage.removeItem('hockey_token');
                localStorage.removeItem('hockey_user');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            console.error('Auth error:', error);
        }
        
        // Check if user is coach on page load
        async function checkCoachAccess() {
            const token = localStorage.getItem('hockey_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const response = await fetch('/api/profile', {
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Token inv√°lido');
                }
                
                if (data.data.role === 'admin') {
                    // Redirigir admin al panel de admin
                    window.location.href = 'admin.html';
                    return;
                }
                
                if (data.data.role !== 'coach') {
                    alert('Acceso denegado. Solo entrenadores.');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Mostrar informaci√≥n del usuario
                document.getElementById('user-name').textContent = 
                    `${data.data.firstName} ${data.data.lastName} (Entrenador)`;
                
                // Cargar estad√≠sticas b√°sicas
                loadDashboardStats();
                
            } catch (error) {
                console.error('Error checking coach access:', error);
                localStorage.removeItem('hockey_token');
                localStorage.removeItem('hockey_user');
                window.location.href = 'login.html';
            }
        }
        
        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                // Cargar informaci√≥n del usuario para obtener max_teams
                const userResponse = await fetch('/api/profile', {
                    headers: getAuthHeaders()
                });
                const userData = await userResponse.json();
                
                console.log('=== USER DATA DEBUG ===');
                console.log('User response:', userData);
                console.log('Max teams from API:', userData.data ? userData.data.maxTeams : 'No data');
                
                if (userData.success) {
                    const maxTeams = userData.data.maxTeams !== undefined ? userData.data.maxTeams : 0;
                    document.getElementById('max-teams-display').textContent = maxTeams;
                    console.log('Setting max teams display to:', maxTeams);
                }

                // Cargar equipos del entrenador
                const teamsResponse = await fetch('/api/teams', {
                    headers: getAuthHeaders()
                });
                const teamsData = await teamsResponse.json();
                
                console.log('Teams data:', teamsData);
                
                if (teamsData.success) {
                    const currentTeams = teamsData.teams.length;
                    document.getElementById('total-teams').textContent = currentTeams;
                    console.log('Current teams count:', currentTeams);
                    
                    // Calcular total de jugadoras (cuando tengamos los datos)
                    let totalPlayers = 0;
                    // TODO: Sumar jugadoras de todos los equipos
                    document.getElementById('total-players').textContent = totalPlayers;
                }
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                // Valores por defecto en caso de error
                document.getElementById('total-teams').textContent = '0';
                document.getElementById('total-players').textContent = '0';
            }
            
            // Por ahora, valores mock para las otras estad√≠sticas
            document.getElementById('upcoming-matches').textContent = '0';
            document.getElementById('formations-created').textContent = '0';
        }
        
        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load tab-specific content
            switch(tabName) {
                case 'teams':
                    loadTeams();
                    break;
                case 'attendance':
                    loadAttendance();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'formations':
                    // TODO: loadFormations();
                    break;
                case 'matches':
                    // TODO: loadMatches();
                    break;
                case 'reports':
                    // TODO: loadReports();
                    break;
            }
        }
        
        // Logout functionality
        function logout() {
            localStorage.removeItem('hockey_token');
            localStorage.removeItem('hockey_user');
            window.location.href = 'login.html';
        }
        
        // Show message
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = `message ${type}`;
            msgDiv.style.display = 'block';
            
            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 5000);
        }

        // =================== TEAMS MANAGEMENT ===================
        
        // Load teams for the coach
        async function loadTeams() {
            const container = document.getElementById('teams-list');
            container.innerHTML = '<div class="loading">Cargando equipos...</div>';
            
            try {
                const response = await fetch('/api/teams', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    const teamsGridHtml = await generateTeamsGrid(data.teams);
                    container.innerHTML = teamsGridHtml;
                } else {
                    container.innerHTML = `<div class="message error">Error: ${data.message || data.error}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="message error">Error de conexi√≥n: ${error.message}</div>`;
            }
        }

        // Generate teams grid HTML
        async function generateTeamsGrid(teams) {
            if (teams.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üèí</div>
                        <h3>No tienes equipos creados</h3>
                        <p>Crea tu primer equipo para comenzar a gestionar jugadoras</p>
                        <button class="btn btn-primary" onclick="showCreateTeamModal()" style="margin-top: 20px;">
                            ‚ûï Crear Mi Primer Equipo
                        </button>
                    </div>
                `;
            }

            let html = '<div class="teams-grid">';
            
            for (const team of teams) {
                // Obtener el conteo de jugadores para cada equipo
                const playerCount = await getPlayerCountForTeam(team.id);
                const genderText = team.team_gender === 'female' ? 'jugadoras' : 'jugadores';
                
                html += `
                    <div class="team-card">
                        <h3>${team.name}</h3>
                        <div class="team-info">
                            <span class="team-badge division">${team.club_name || 'Sin club'}</span>
                            ${team.max_players ? `<span class="team-badge category">Max: ${team.max_players} ${genderText}</span>` : ''}
                        </div>
                        <div class="team-actions">
                            <button class="btn btn-sm btn-info" onclick="viewTeamPlayers('${team.id}', '${team.name}', '${team.team_gender || 'male'}')" title="Ver ${genderText}">
                                üë• ${team.team_gender === 'female' ? 'Jugadoras' : 'Jugadores'} (${playerCount})
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="editTeam('${team.id}')" title="Editar equipo">
                                ‚úèÔ∏è Editar
                            </button>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        // Get player count for a specific team
        async function getPlayerCountForTeam(teamId) {
            try {
                const response = await fetch(`/api/players?team_id=${teamId}`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    return data.players.length;
                } else {
                    return 0;
                }
            } catch (error) {
                console.error('Error getting player count:', error);
                return 0;
            }
        }

        // Show create team modal
        async function showCreateTeamModal() {
            document.getElementById('modal-title').textContent = 'Crear Nuevo Equipo';
            document.getElementById('team-form').reset();
            
            // Resetear el select de divisiones
            const divisionSelect = document.getElementById('team-division');
            divisionSelect.innerHTML = '<option value="">Primero selecciona el g√©nero...</option>';
            
            // Verificar token antes de abrir el modal
            const token = localStorage.getItem('hockey_token');
            if (!token) {
                showMessage('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            // Verificar que el token sea v√°lido y obtener l√≠mites de equipos
            try {
                const response = await fetch('/api/profile', {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    showMessage('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'error');
                    setTimeout(() => {
                        localStorage.removeItem('hockey_token');
                        localStorage.removeItem('hockey_user');
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                const userData = await response.json();
                if (userData.success) {
                    const maxTeams = userData.data.maxTeams !== undefined ? userData.data.maxTeams : 2;
                    
                    console.log('=== TEAM LIMITS CHECK ===');
                    console.log('Max teams allowed:', maxTeams);
                    
                    // Si el usuario tiene 0 equipos permitidos, no puede crear ning√∫n equipo
                    if (maxTeams === 0) {
                        showMessage('No tienes permisos para crear equipos. Contacta al administrador para solicitar acceso.', 'warning');
                        return;
                    }
                    
                    // Verificar equipos actuales
                    const teamsResponse = await fetch('/api/teams', {
                        headers: getAuthHeaders()
                    });
                    const teamsData = await teamsResponse.json();
                    
                    if (teamsData.success) {
                        const currentTeams = teamsData.teams.length;
                        
                        console.log('Current teams:', currentTeams);
                        console.log('Can create more:', currentTeams < maxTeams);
                        
                        if (currentTeams >= maxTeams) {
                            showMessage(`Has alcanzado el l√≠mite m√°ximo de ${maxTeams} equipos. Para crear m√°s equipos, solicita al administrador que ampl√≠e tu l√≠mite de equipos.`, 'warning');
                            return;
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error verifying token:', error);
            }
            
            document.getElementById('team-modal').style.display = 'block';
        }

        // Load available divisions
        async function loadDivisions() {
            const divisionSelect = document.getElementById('team-division');
            
            // Mostrar loading
            divisionSelect.innerHTML = '<option value="">Cargando divisiones...</option>';
            
            try {
                const response = await fetch('/api/divisions', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    // Limpiar select
                    divisionSelect.innerHTML = '<option value="">Seleccionar divisi√≥n (opcional)...</option>';
                    
                    // Agregar divisiones
                    data.divisions.forEach(division => {
                        const option = document.createElement('option');
                        option.value = division.id;
                        option.textContent = division.name;
                        divisionSelect.appendChild(option);
                    });
                } else {
                    divisionSelect.innerHTML = '<option value="">Error cargando divisiones</option>';
                    console.error('Error loading divisions:', data.message);
                }
            } catch (error) {
                divisionSelect.innerHTML = '<option value="">Error de conexi√≥n</option>';
                console.error('Error fetching divisions:', error);
            }
        }

        // Load divisions filtered by gender
        async function loadDivisionsForGender(gender) {
            const divisionSelect = document.getElementById('team-division');
            
            if (!gender) {
                divisionSelect.innerHTML = '<option value="">Primero selecciona el g√©nero...</option>';
                return;
            }
            
            // Mostrar loading
            divisionSelect.innerHTML = '<option value="">Cargando divisiones...</option>';
            
            try {
                const response = await fetch(`/api/divisions?gender=${encodeURIComponent(gender)}`, {
                    headers: getAuthHeaders()
                });
                
                console.log(`Loading divisions for gender: ${gender}`);
                console.log('Response status:', response.status);
                
                // Manejar error de autenticaci√≥n
                if (response.status === 401) {
                    handleAuthError(new Error('Unauthorized'), response);
                    return;
                }
                
                const data = await response.json();
                console.log('Divisions data:', data);
                
                if (data.success) {
                    // Limpiar select
                    divisionSelect.innerHTML = '<option value="">Seleccionar divisi√≥n (opcional)...</option>';
                    
                    // Verificar que hay divisiones para el g√©nero seleccionado
                    if (data.divisions && data.divisions.length > 0) {
                        data.divisions.forEach(division => {
                            const option = document.createElement('option');
                            option.value = division.id;
                            option.textContent = `${division.name} (${division.gender === 'male' ? 'Masculino' : 'Femenino'})`;
                            divisionSelect.appendChild(option);
                        });
                    } else {
                        divisionSelect.innerHTML = `<option value="">No hay divisiones para ${gender === 'male' ? 'masculino' : 'femenino'}</option>`;
                    }
                } else {
                    divisionSelect.innerHTML = '<option value="">Error cargando divisiones</option>';
                    console.error('Error loading divisions:', data.message);
                }
            } catch (error) {
                divisionSelect.innerHTML = '<option value="">Error de conexi√≥n</option>';
                console.error('Error fetching divisions:', error);
            }
        }

        // Close team modal
        function closeTeamModal() {
            document.getElementById('team-modal').style.display = 'none';
        }

        // Handle team form submission
        document.addEventListener('DOMContentLoaded', function() {
            const teamForm = document.getElementById('team-form');
            if (teamForm) {
                teamForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    const teamData = Object.fromEntries(formData.entries());
                    
                    try {
                        console.log('Sending team data:', teamData);
                        
                        const response = await fetch('/api/teams', {
                            method: 'POST',
                            headers: getAuthHeaders(),
                            body: JSON.stringify(teamData)
                        });
                        
                        console.log('Response status:', response.status);
                        
                        // Manejar error de autenticaci√≥n
                        if (response.status === 401) {
                            handleAuthError(new Error('Unauthorized'), response);
                            return;
                        }
                        
                        // Manejar error de l√≠mite de equipos
                        if (response.status === 403) {
                            const data = await response.json();
                            showMessage(data.message || 'No tienes permisos para crear m√°s equipos', 'warning');
                            return;
                        }
                        
                        const data = await response.json();
                        console.log('Response data:', data);
                        
                        if (data.success) {
                            showMessage('Equipo creado exitosamente', 'success');
                            closeTeamModal();
                            loadTeams(); // Recargar la lista
                            loadDashboardStats(); // Actualizar estad√≠sticas
                        } else {
                            // Mensaje espec√≠fico para l√≠mites
                            const message = data.message || data.error;
                            const messageType = message.includes('l√≠mite') || message.includes('solicita') ? 'warning' : 'error';
                            showMessage(`${message}`, messageType);
                        }
                    } catch (error) {
                        console.error('Error in team creation:', error);
                        showMessage(`Error de conexi√≥n: ${error.message}`, 'error');
                    }
                });
            }

            // Handle player form submission
            const playerForm = document.getElementById('player-form');
            if (playerForm) {
                playerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    if (!window.currentTeamId) {
                        showMessage('Error: No hay equipo seleccionado', 'error');
                        return;
                    }
                    
                    const formData = new FormData(this);
                    const playerData = Object.fromEntries(formData.entries());
                    playerData.teamId = window.currentTeamId;
                    
                    try {
                        let response;
                        let successMessage;
                        
                        if (window.editingPlayerId) {
                            // Update existing player
                            response = await fetch(`/api/players/${window.editingPlayerId}`, {
                                method: 'PUT',
                                headers: getAuthHeaders(),
                                body: JSON.stringify(playerData)
                            });
                            successMessage = 'Jugador actualizado exitosamente';
                        } else {
                            // Create new player
                            response = await fetch('/api/players', {
                                method: 'POST',
                                headers: getAuthHeaders(),
                                body: JSON.stringify(playerData)
                            });
                            successMessage = 'Jugador agregado exitosamente';
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showMessage(successMessage, 'success');
                            closePlayerModal();
                            loadPlayersForTeam(window.currentTeamId, window.currentTeamName, window.currentTeamGender);
                        } else {
                            showMessage(`Error: ${data.message || data.error}`, 'error');
                        }
                    } catch (error) {
                        showMessage(`Error de conexi√≥n: ${error.message}`, 'error');
                    }
                });
            }
        });

        // View team players
        function viewTeamPlayers(teamId, teamName, teamGender) {
            // Cambiar a la pesta√±a de jugadores
            showTab('players');
            
            // Cargar jugadores del equipo
            loadPlayersForTeam(teamId, teamName, teamGender);
        }

        // Load players for specific team
        async function loadPlayersForTeam(teamId, teamName, teamGender = 'male') {
            const container = document.getElementById('players-list');
            const teamTitle = document.getElementById('current-team-name');
            const addPlayerBtnContainer = document.getElementById('add-player-btn');
            
            if (teamTitle) {
                const genderText = teamGender === 'female' ? 'Jugadoras' : 'Jugadores';
                teamTitle.textContent = `${genderText} de: ${teamName}`;
            }
            
            // Mostrar los botones de acci√≥n
            if (addPlayerBtnContainer) {
                addPlayerBtnContainer.style.display = 'block';
            }
            
            // Guardar el teamId actual para crear nuevos jugadores
            window.currentTeamId = teamId;
            window.currentTeamName = teamName;
            window.currentTeamGender = teamGender;
            
            container.innerHTML = '<div class="loading">Cargando jugadores...</div>';
            
            try {
                const response = await fetch(`/api/players?team_id=${teamId}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError('Token expired', response);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    container.innerHTML = generatePlayersGrid(data.players, teamGender);
                } else {
                    container.innerHTML = `<div class="message error">Error: ${data.message || data.error}</div>`;
                }
            } catch (error) {
                console.error('Error loading players:', error);
                container.innerHTML = `<div class="message error">Error de conexi√≥n: ${error.message}</div>`;
            }
        }

        // Generate players grid HTML
        function generatePlayersGrid(players, teamGender = 'male') {
            const genderText = teamGender === 'female' ? 'jugadoras' : 'jugadores';
            const genderTextSingular = teamGender === 'female' ? 'Jugadora' : 'Jugador';
            
            if (players.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üèÉ‚Äç‚ôÄÔ∏è</div>
                        <h3>No hay ${genderText} en este equipo</h3>
                        <p>Agrega ${genderText} para comenzar a gestionar el equipo</p>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="showCreatePlayerModal()" style="margin-right: 10px;">
                                ‚ûï Agregar Primer ${genderTextSingular}
                            </button>
                            <button class="btn btn-success" onclick="showExcelImportModal()">
                                üìä Importar Excel
                            </button>
                        </div>
                    </div>
                `;
            }

            let html = '<div class="players-grid">';
            
            players.forEach(player => {
                html += `
                    <div class="player-card">
                        <div class="player-header">
                            <h4>${player.name}</h4>
                            ${player.nickname ? `<span class="player-nickname">"${player.nickname}"</span>` : ''}
                        </div>
                        <div class="player-info">
                            ${player.jersey_number ? `<span class="jersey-number">#${player.jersey_number}</span>` : '<span class="jersey-number">Sin #</span>'}
                            <span class="player-position">${player.position || 'Sin posici√≥n'}</span>
                        </div>
                        <div class="player-actions">
                            <button class="btn btn-sm btn-warning" onclick="editPlayer('${player.id}', '${player.name}', '${player.nickname || ''}', '${player.birth_date || ''}', '${player.position || ''}', '${player.jersey_number || ''}')" title="Editar jugador">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="removePlayerFromTeam('${player.id}', '${player.name}')" title="Eliminar del equipo">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Bot√≥n para agregar m√°s jugadores
            html += `
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="showCreatePlayerModal()" style="margin-right: 10px;">
                        ‚ûï Agregar ${genderTextSingular}
                    </button>
                    <button class="btn btn-success" onclick="showExcelImportModal()">
                        üìä Importar Excel
                    </button>
                </div>
            `;
            
            return html;
        }

        // Show create player modal
        function showCreatePlayerModal() {
            console.log('showCreatePlayerModal called');
            console.log('currentTeamId:', window.currentTeamId);
            console.log('currentTeamGender:', window.currentTeamGender);
            
            if (!window.currentTeamId) {
                showMessage('Primero selecciona un equipo desde "Mis Equipos"', 'error');
                return;
            }
            
            // Reset form and set title for creating new player
            document.getElementById('player-modal-title').textContent = `Agregar Jugador a: ${window.currentTeamName}`;
            document.getElementById('player-form').reset();
            
            // Clear edit mode data
            delete window.editingPlayerId;
            
            loadPlayerPositions();
            document.getElementById('player-modal').style.display = 'block';
        }

        // Edit existing player
        function editPlayer(playerId, name, nickname, birthDate, position, jerseyNumber) {
            console.log('editPlayer called with:', { playerId, name, nickname, birthDate, position, jerseyNumber });
            
            if (!window.currentTeamId) {
                showMessage('Error: No hay equipo seleccionado', 'error');
                return;
            }
            
            // Set modal title for editing
            document.getElementById('player-modal-title').textContent = `Editar Jugador: ${name}`;
            
            // Fill form with current player data
            document.getElementById('player-name').value = name;
            document.getElementById('player-nickname').value = nickname === 'null' ? '' : nickname;
            document.getElementById('player-birth-date').value = birthDate === 'null' ? '' : birthDate;
            document.getElementById('player-jersey').value = jerseyNumber === 'null' || jerseyNumber === '' ? '' : jerseyNumber;
            
            // Store the player ID for editing
            window.editingPlayerId = playerId;
            
            // Load positions and set current position
            loadPlayerPositions();
            setTimeout(() => {
                if (position && position !== 'null') {
                    document.getElementById('player-position').value = position;
                }
            }, 100);
            
            document.getElementById('player-modal').style.display = 'block';
        }

        // Load player positions based on team gender
        function loadPlayerPositions() {
            const teamGender = window.currentTeamGender || 'male';
            const femalePositions = ['Portera', 'Arquera', 'Defensora', 'Mediocampista', 'Delantera'];
            const malePositions = ['Portero', 'Arquero', 'Defensor', 'Mediocampista', 'Delantero'];
            
            const positions = teamGender === 'female' ? femalePositions : malePositions;
            console.log('Positions for gender', teamGender, ':', positions);
            
            // Generate position options
            let positionOptions = '<option value="">Seleccionar posici√≥n...</option>';
            positions.forEach(position => {
                positionOptions += `<option value="${position}">${position}</option>`;
            });
            
            // Update position select
            const positionSelect = document.getElementById('player-position');
            if (positionSelect) {
                positionSelect.innerHTML = positionOptions;
            }
        }

        // Close player modal
        function closePlayerModal() {
            document.getElementById('player-modal').style.display = 'none';
        }

        // Show Excel import modal
        function showExcelImportModal() {
            if (!window.currentTeamId) {
                showMessage('Primero selecciona un equipo desde "Mis Equipos"', 'error');
                return;
            }
            
            document.getElementById('excel-import-modal').style.display = 'block';
            document.getElementById('excel-import-form').reset();
        }

        // Close Excel import modal
        function closeExcelImportModal() {
            document.getElementById('excel-import-modal').style.display = 'none';
        }

        // Handle Excel import form submission
        document.getElementById('excel-import-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('excel-file');
            if (!fileInput.files[0]) {
                showMessage('Por favor selecciona un archivo Excel', 'error');
                return;
            }
            
            try {
                showMessage('Procesando archivo Excel...', 'info');
                const players = await processExcelFile(fileInput.files[0]);
                
                if (players.length === 0) {
                    showMessage('No se encontraron jugadores v√°lidos en el archivo', 'error');
                    return;
                }
                
                // Import players
                await importPlayersToTeam(players);
                
            } catch (error) {
                console.error('Error processing Excel file:', error);
                showMessage('Error al procesar el archivo Excel: ' + error.message, 'error');
            }
        });

        // Process Excel file and extract players data
        async function processExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Get first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Convert to JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            reject(new Error('El archivo debe tener al menos una fila de encabezados y una fila de datos'));
                            return;
                        }
                        
                        // Expected headers
                        const expectedHeaders = ['Nombre', 'Apodo', 'Fecha de Nacimiento', 'Posici√≥n', 'N√∫mero de Camiseta'];
                        const actualHeaders = jsonData[0];
                        
                        // Validate headers
                        const missingHeaders = expectedHeaders.filter(header => 
                            !actualHeaders.some(actual => 
                                actual && actual.toString().toLowerCase().trim() === header.toLowerCase()
                            )
                        );
                        
                        if (missingHeaders.length > 0) {
                            reject(new Error(`Faltan las siguientes columnas: ${missingHeaders.join(', ')}`));
                            return;
                        }
                        
                        // Get column indices
                        const getColumnIndex = (headerName) => {
                            return actualHeaders.findIndex(header => 
                                header && header.toString().toLowerCase().trim() === headerName.toLowerCase()
                            );
                        };
                        
                        const nameIndex = getColumnIndex('Nombre');
                        const nicknameIndex = getColumnIndex('Apodo');
                        const birthDateIndex = getColumnIndex('Fecha de Nacimiento');
                        const positionIndex = getColumnIndex('Posici√≥n');
                        const jerseyIndex = getColumnIndex('N√∫mero de Camiseta');
                        
                        // Process data rows
                        const players = [];
                        const teamGender = window.currentTeamGender || 'male';
                        const validPositions = teamGender === 'female' 
                            ? ['Portera', 'Arquera', 'Defensora', 'Mediocampista', 'Delantera']
                            : ['Portero', 'Arquero', 'Defensor', 'Mediocampista', 'Delantero'];
                        
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            
                            // Skip empty rows
                            if (!row || row.length === 0 || !row[nameIndex]) {
                                continue;
                            }
                            
                            const name = row[nameIndex] ? row[nameIndex].toString().trim() : '';
                            const nickname = row[nicknameIndex] ? row[nicknameIndex].toString().trim() : '';
                            const birthDateRaw = row[birthDateIndex] ? row[birthDateIndex].toString().trim() : '';
                            const position = row[positionIndex] ? row[positionIndex].toString().trim() : '';
                            const jerseyNumber = row[jerseyIndex] ? parseInt(row[jerseyIndex]) : null;
                            
                            // Validate required fields
                            if (!name) {
                                console.warn(`Fila ${i + 1}: Nombre requerido, saltando...`);
                                continue;
                            }
                            
                            if (!birthDateRaw) {
                                console.warn(`Fila ${i + 1}: Fecha de nacimiento requerida, saltando...`);
                                continue;
                            }
                            
                            // Parse birth date - support multiple formats
                            let birthDate = null;
                            try {
                                // Try to parse different date formats
                                if (birthDateRaw.includes('/')) {
                                    // DD/MM/YYYY or MM/DD/YYYY format
                                    const parts = birthDateRaw.split('/');
                                    if (parts.length === 3) {
                                        // Assume DD/MM/YYYY format for Spanish locale
                                        const day = parseInt(parts[0]);
                                        const month = parseInt(parts[1]);
                                        const year = parseInt(parts[2]);
                                        birthDate = `${year.toString().padStart(4, '0')}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                                    }
                                } else if (birthDateRaw.includes('-')) {
                                    // YYYY-MM-DD format
                                    birthDate = birthDateRaw;
                                } else {
                                    // Try to parse as Excel serial date
                                    const excelDate = parseInt(birthDateRaw);
                                    if (!isNaN(excelDate) && excelDate > 25000) { // Excel serial dates start around 25567 for 1970
                                        const jsDate = new Date((excelDate - 25569) * 86400 * 1000);
                                        birthDate = jsDate.toISOString().split('T')[0];
                                    }
                                }
                                
                                if (!birthDate) {
                                    throw new Error('Formato de fecha no reconocido');
                                }
                                
                                // Validate date format YYYY-MM-DD
                                if (!/^\d{4}-\d{2}-\d{2}$/.test(birthDate)) {
                                    throw new Error('Formato de fecha inv√°lido');
                                }
                                
                            } catch (error) {
                                console.warn(`Fila ${i + 1}: Error procesando fecha "${birthDateRaw}": ${error.message}, saltando...`);
                                continue;
                            }
                            
                            // Validate position if provided
                            if (position && !validPositions.includes(position)) {
                                console.warn(`Fila ${i + 1}: Posici√≥n "${position}" no v√°lida para equipo ${teamGender}, saltando...`);
                                continue;
                            }
                            
                            players.push({
                                teamId: window.currentTeamId,
                                name,
                                nickname: nickname || null,
                                birth_date: birthDate,
                                position: position || null,
                                jersey_number: jerseyNumber
                            });
                        }
                        
                        resolve(players);
                        
                    } catch (error) {
                        reject(new Error('Error al leer el archivo Excel: ' + error.message));
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Error al leer el archivo'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // Import players to team
        async function importPlayersToTeam(players) {
            try {
                const successfulImports = [];
                const failedImports = [];
                
                for (const player of players) {
                    try {
                        const response = await fetch('/api/players', {
                            method: 'POST',
                            headers: getAuthHeaders(),
                            body: JSON.stringify(player)
                        });

                        if (response.status === 401) {
                            handleAuthError('Token expired during import', response);
                            return;
                        }

                        if (response.ok) {
                            const newPlayer = await response.json();
                            successfulImports.push(player.name);
                        } else {
                            const errorData = await response.json();
                            failedImports.push(`${player.name} (${errorData.message})`);
                        }
                    } catch (error) {
                        failedImports.push(`${player.name} (${error.message})`);
                    }
                }
                
                // Show results
                let message = '';
                if (successfulImports.length > 0) {
                    message += `‚úÖ ${successfulImports.length} jugadores importados exitosamente\n`;
                }
                if (failedImports.length > 0) {
                    message += `‚ùå ${failedImports.length} jugadores fallaron:\n${failedImports.join('\n')}`;
                }
                
                showMessage(message, successfulImports.length > 0 ? 'success' : 'error');
                
                // Close modal and refresh team view
                closeExcelImportModal();
                if (successfulImports.length > 0) {
                    await loadPlayersForTeam(window.currentTeamId, window.currentTeamName, window.currentTeamGender);
                }
                
            } catch (error) {
                console.error('Error importing players:', error);
                showMessage('Error al importar jugadores: ' + error.message, 'error');
            }
        }

        // Remove player from team
        async function removePlayerFromTeam(playerId, playerName) {
            if (!confirm(`¬øEst√°s seguro de que deseas eliminar a "${playerName}" del equipo?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/players/${playerId}?team_id=${window.currentTeamId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`${playerName} eliminado del equipo exitosamente`, 'success');
                    loadPlayersForTeam(window.currentTeamId, window.currentTeamName); // Recargar lista
                } else {
                    showMessage(`Error: ${data.message || data.error}`, 'error');
                }
            } catch (error) {
                showMessage(`Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        // Edit team (placeholder for now)
        function editTeam(teamId) {
            showMessage('Funcionalidad de edici√≥n pr√≥ximamente disponible', 'success');
            // TODO: Implement team editing
        }
        
        // ==========================================
        // ATTENDANCE FUNCTIONS
        // ==========================================
        
        // Load attendance management
        async function loadAttendance() {
            console.log('Loading attendance management...');
            await loadTeamsForAttendance();
        }
        
        // Load teams for attendance selector
        async function loadTeamsForAttendance() {
            try {
                const response = await fetch('/api/teams', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('attendance-team-select');
                    select.innerHTML = '<option value="">Selecciona un equipo...</option>';
                    
                    data.teams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = team.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading teams for attendance:', error);
            }
        }
        
        // Show create attendance modal
        function showCreateAttendanceModal() {
            const select = document.getElementById('attendance-team-select');
            if (!select.value) {
                showMessage('Por favor selecciona un equipo primero', 'error');
                return;
            }
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendance-date').value = today;
            
            document.getElementById('attendance-modal').style.display = 'block';
        }
        
        // Close attendance modal
        function closeAttendanceModal() {
            document.getElementById('attendance-modal').style.display = 'none';
            document.getElementById('attendance-form').reset();
        }
        
        // Load attendance for selected team
        async function loadAttendanceForTeam() {
            const select = document.getElementById('attendance-team-select');
            const container = document.getElementById('attendance-list');
            
            if (!select.value) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üìã</div>
                        <h3>Selecciona un equipo para ver las asistencias</h3>
                        <p>Podr√°s registrar y gestionar las asistencias de entrenamientos y partidos</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div class="loading">Cargando entrenamientos...</div>';
            
            try {
                const response = await fetch(`/api/trainings?team_id=${select.value}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    handleAuthError('Token expired', response);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success && data.trainings.length > 0) {
                    container.innerHTML = generateTrainingsGrid(data.trainings);
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 3em; margin-bottom: 20px;">üìã</div>
                            <h3>No hay entrenamientos programados</h3>
                            <p>Crea tu primer entrenamiento para comenzar a registrar la asistencia de las jugadoras</p>
                            <button class="btn btn-primary" onclick="showCreateAttendanceModal()" style="margin-top: 20px;">
                                ‚ûï Crear Primer Entrenamiento
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading trainings:', error);
                container.innerHTML = `<div class="message error">Error cargando entrenamientos: ${error.message}</div>`;
            }
        }
        
        // Generate trainings grid HTML
        function generateTrainingsGrid(trainings) {
            let html = '<div style="display: grid; gap: 15px;">';
            
            trainings.forEach(training => {
                const date = new Date(training.training_date).toLocaleDateString('es-ES');
                const time = training.start_time || '';
                
                html += `
                    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: between-center; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h3 style="margin: 0; color: #2c5aa0;">${training.name}</h3>
                                <p style="margin: 5px 0; color: #666;">üìÖ ${date} ${time ? `‚è∞ ${time}` : ''}</p>
                                ${training.location ? `<p style="margin: 5px 0; color: #666;">üìç ${training.location}</p>` : ''}
                            </div>
                            <button class="btn btn-primary" onclick="showAttendanceForTraining('${training.id}', '${training.name}', '${date}')" 
                                    style="margin-left: auto;">
                                üìù Ver Asistencia
                            </button>
                        </div>
                        ${training.notes ? `<p style="margin: 10px 0; font-style: italic; color: #555;">${training.notes}</p>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        // Show attendance for specific training
        async function showAttendanceForTraining(trainingId, trainingName, trainingDate) {
            const container = document.getElementById('attendance-list');
            container.innerHTML = '<div class="loading">Cargando jugadoras y asistencias...</div>';
            
            try {
                const teamId = document.getElementById('attendance-team-select').value;
                
                // Get team players
                const playersResponse = await fetch(`/api/players?team_id=${teamId}`, {
                    headers: getAuthHeaders()
                });
                
                if (playersResponse.status === 401) {
                    handleAuthError('Token expired', playersResponse);
                    return;
                }
                
                const playersData = await playersResponse.json();
                
                // Get existing attendance
                const attendanceResponse = await fetch(`/api/training-attendances?training_session_id=${trainingId}`, {
                    headers: getAuthHeaders()
                });
                
                let attendanceData = { success: true, attendances: [] };
                if (attendanceResponse.ok) {
                    attendanceData = await attendanceResponse.json();
                }
                
                if (playersData.success) {
                    container.innerHTML = generateAttendanceForm(trainingId, trainingName, trainingDate, playersData.players, attendanceData.attendances);
                } else {
                    container.innerHTML = `<div class="message error">Error: ${playersData.message}</div>`;
                }
                
            } catch (error) {
                console.error('Error loading attendance data:', error);
                container.innerHTML = `<div class="message error">Error cargando datos: ${error.message}</div>`;
            }
        }
        
        // Generate attendance form HTML
        function generateAttendanceForm(trainingId, trainingName, trainingDate, players, attendances) {
            // Create attendance map for quick lookup
            const attendanceMap = {};
            attendances.forEach(att => {
                attendanceMap[att.player_id] = att;
            });
            
            let html = `
                <div style="background: white; border-radius: 8px; padding: 20px;">
                    <div style="display: flex; justify-content: between-center; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                        <div>
                            <h2 style="margin: 0; color: #2c5aa0;">üìù ${trainingName}</h2>
                            <p style="margin: 5px 0 0 0; color: #666;">üìÖ ${trainingDate}</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="saveAllAttendance('${trainingId}')" style="margin-left: auto;">
                                ‚úÖ Guardar Asistencias
                            </button>
                            <button class="btn btn-secondary" onclick="loadAttendanceForTeam()">
                                ‚Üê Volver a Entrenamientos
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 10px; max-height: 60vh; overflow-y: auto;">
            `;
            
            players.forEach(player => {
                const attendance = attendanceMap[player.id];
                const status = attendance ? attendance.status : 'ausente';
                const excuse = attendance ? attendance.excuse_reason || '' : '';
                
                html += `
                    <div style="display: flex; align-items: center; padding: 15px; border: 1px solid #ddd; border-radius: 6px; background: #fafafa;">
                        <div style="flex: 1; font-weight: bold; color: #333;">
                            ${player.name} ${player.nickname ? `(${player.nickname})` : ''}
                            ${player.jersey_number ? `<span style="color: #666; font-weight: normal;"> - #${player.jersey_number}</span>` : ''}
                        </div>
                        
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="status_${player.id}" value="presente" ${status === 'presente' ? 'checked' : ''}>
                                <span style="color: #4CAF50; font-weight: bold;">‚úÖ Presente</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="status_${player.id}" value="tarde" ${status === 'tarde' ? 'checked' : ''}>
                                <span style="color: #FF9800; font-weight: bold;">‚è∞ Tarde</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="status_${player.id}" value="ausente" ${status === 'ausente' ? 'checked' : ''}>
                                <span style="color: #f44336; font-weight: bold;">‚ùå Ausente</span>
                            </label>
                            
                            <input type="text" id="excuse_${player.id}" value="${excuse}" placeholder="Motivo (opcional)"
                                   style="width: 150px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }
        
        // Save all attendance for training
        async function saveAllAttendance(trainingId) {
            const container = document.getElementById('attendance-list');
            const playerRows = container.querySelectorAll('div[style*="display: flex"][style*="padding: 15px"]');
            const attendances = [];
            
            playerRows.forEach(row => {
                const statusRadios = row.querySelectorAll('input[type="radio"]:checked');
                const excuseInput = row.querySelector('input[type="text"]');
                
                if (statusRadios.length > 0) {
                    const playerId = statusRadios[0].name.split('_')[1];
                    const status = statusRadios[0].value;
                    const excuse = excuseInput ? excuseInput.value.trim() : '';
                    
                    attendances.push({
                        training_session_id: trainingId,
                        player_id: playerId,
                        status: status,
                        excuse_reason: excuse || null
                    });
                }
            });
            
            try {
                let savedCount = 0;
                let failedCount = 0;
                
                for (const attendance of attendances) {
                    try {
                        const response = await fetch('/api/training-attendances', {
                            method: 'POST',
                            headers: getAuthHeaders(),
                            body: JSON.stringify(attendance)
                        });
                        
                        if (response.ok) {
                            savedCount++;
                        } else {
                            failedCount++;
                        }
                    } catch (error) {
                        failedCount++;
                        console.error('Error saving attendance:', error);
                    }
                }
                
                if (savedCount > 0 && failedCount === 0) {
                    showMessage(`‚úÖ ${savedCount} asistencias guardadas exitosamente`, 'success');
                } else if (savedCount > 0 && failedCount > 0) {
                    showMessage(`‚ö†Ô∏è ${savedCount} asistencias guardadas, ${failedCount} fallaron`, 'error');
                } else {
                    showMessage('‚ùå Error guardando las asistencias', 'error');
                }
                
                // Refresh the attendance view
                setTimeout(() => {
                    showAttendanceForTraining(trainingId, '', '');
                }, 1000);
                
            } catch (error) {
                console.error('Error saving attendances:', error);
                showMessage('Error guardando asistencias: ' + error.message, 'error');
            }
        }
        
        // Handle attendance form submission
        document.addEventListener('DOMContentLoaded', function() {
            const attendanceForm = document.getElementById('attendance-form');
            if (attendanceForm) {
                attendanceForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const teamSelect = document.getElementById('attendance-team-select');
                    const formData = new FormData(this);
                    
                    const attendanceData = {
                        teamId: teamSelect.value,
                        name: `${document.getElementById('attendance-type').value === 'training' ? 'Entrenamiento' : 
                               document.getElementById('attendance-type').value === 'match' ? 'Partido' : 
                               document.getElementById('attendance-type').value === 'meeting' ? 'Reuni√≥n' : 'Actividad'} - ${document.getElementById('attendance-date').value}`,
                        trainingDate: document.getElementById('attendance-date').value,
                        startTime: '18:00', // Hora por defecto
                        location: '',
                        notes: document.getElementById('attendance-description').value || ''
                    };
                    
                    try {
                        console.log('Creating training session:', attendanceData);
                        
                        const response = await fetch('/api/trainings', {
                            method: 'POST',
                            headers: getAuthHeaders(),
                            body: JSON.stringify(attendanceData)
                        });
                        
                        if (response.status === 401) {
                            handleAuthError('Token expired during training creation', response);
                            return;
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showMessage('Entrenamiento creado exitosamente', 'success');
                            closeAttendanceModal();
                            loadAttendanceForTeam();
                        } else {
                            showMessage('Error: ' + data.message, 'error');
                        }
                        
                    } catch (error) {
                        console.error('Error creating training:', error);
                        showMessage('Error creando entrenamiento: ' + error.message, 'error');
                    }
                });
            }
        });
        
        // ==========================================
        // END ATTENDANCE FUNCTIONS
        // ==========================================
        
        // ==========================================
        // REPORTS FUNCTIONS
        // ==========================================
        
        // Load reports management
        async function loadReports() {
            console.log('Loading enhanced reports management...');
            await loadTeamsForReports();
            await initializeReportFilters();
            await loadDashboardKPIs();
        }
        
        // Load teams for reports selector
        async function loadTeamsForReports() {
            try {
                const response = await fetch('/api/teams', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('reports-team-filter');
                    select.innerHTML = '<option value="">Todos los equipos</option>';
                    
                    data.teams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = team.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading teams for reports:', error);
            }
        }
        
        // Initialize report filters with default dates
        function initializeReportFilters() {
            const today = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(today.getMonth() - 3);
            
            document.getElementById('reports-date-from').value = threeMonthsAgo.toISOString().split('T')[0];
            document.getElementById('reports-date-to').value = today.toISOString().split('T')[0];
        }
        
        // Apply report filters and update dashboard
        async function applyReportFilters() {
            const teamId = document.getElementById('reports-team-filter').value;
            const dateFrom = document.getElementById('reports-date-from').value;
            const dateTo = document.getElementById('reports-date-to').value;
            
            // Store current filters globally
            window.currentReportFilters = { teamId, dateFrom, dateTo };
            
            showMessage('Aplicando filtros...', 'info');
            await loadDashboardKPIs();
            showMessage('Filtros aplicados correctamente', 'success');
        }
        
        // Load dashboard KPIs with current filters
        async function loadDashboardKPIs() {
            try {
                const filters = window.currentReportFilters || {};
                let totalPlayers = 0;
                let totalSessions = 0;
                let totalAttendances = 0;
                let totalLates = 0;
                let teamsToProcess = [];
                
                // Get teams to process
                if (filters.teamId) {
                    teamsToProcess = [filters.teamId];
                } else {
                    const teamsResponse = await fetch('/api/teams', {
                        headers: getAuthHeaders()
                    });
                    const teamsData = await teamsResponse.json();
                    if (teamsData.success) {
                        teamsToProcess = teamsData.teams.map(t => t.id);
                    }
                }
                
                // Process each team
                for (const teamId of teamsToProcess) {
                    // Get players for team
                    const playersResponse = await fetch(`/api/players?team_id=${teamId}`, {
                        headers: getAuthHeaders()
                    });
                    const playersData = await playersResponse.json();
                    
                    if (playersData.success) {
                        totalPlayers += playersData.players.length;
                        
                        // Get trainings for team
                        const trainingsResponse = await fetch(`/api/trainings?team_id=${teamId}`, {
                            headers: getAuthHeaders()
                        });
                        const trainingsData = await trainingsResponse.json();
                        
                        if (trainingsData.success) {
                            // Filter trainings by date if specified
                            let filteredTrainings = trainingsData.trainings;
                            if (filters.dateFrom || filters.dateTo) {
                                filteredTrainings = trainingsData.trainings.filter(training => {
                                    const trainingDate = new Date(training.training_date);
                                    const isAfterFrom = !filters.dateFrom || trainingDate >= new Date(filters.dateFrom);
                                    const isBeforeTo = !filters.dateTo || trainingDate <= new Date(filters.dateTo);
                                    return isAfterFrom && isBeforeTo;
                                });
                            }
                            
                            totalSessions += filteredTrainings.length;
                            
                            // Get attendance stats for filtered trainings
                            for (const training of filteredTrainings) {
                                try {
                                    const attendanceResponse = await fetch(`/api/training-attendances?training_session_id=${training.id}`, {
                                        headers: getAuthHeaders()
                                    });
                                    
                                    if (attendanceResponse.ok) {
                                        const attendanceData = await attendanceResponse.json();
                                        if (attendanceData.success) {
                                            attendanceData.attendances.forEach(att => {
                                                if (att.status === 'presente' || att.status === 'tarde') {
                                                    totalAttendances++;
                                                }
                                                if (att.status === 'tarde') {
                                                    totalLates++;
                                                }
                                            });
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error fetching attendance:', error);
                                }
                            }
                        }
                    }
                }
                
                // Calculate percentages
                const avgAttendance = totalSessions > 0 && totalPlayers > 0 
                    ? Math.round((totalAttendances / (totalSessions * totalPlayers)) * 100)
                    : 0;
                
                const punctualityRate = totalAttendances > 0 
                    ? Math.round(((totalAttendances - totalLates) / totalAttendances) * 100)
                    : 0;
                
                // Update KPIs in dashboard
                document.getElementById('kpi-total-players').textContent = totalPlayers;
                document.getElementById('kpi-total-sessions').textContent = totalSessions;
                document.getElementById('kpi-avg-attendance').textContent = `${avgAttendance}%`;
                document.getElementById('kpi-punctuality').textContent = `${punctualityRate}%`;
                
            } catch (error) {
                console.error('Error loading dashboard KPIs:', error);
                // Set default values on error
                document.getElementById('kpi-total-players').textContent = '0';
                document.getElementById('kpi-total-sessions').textContent = '0';
                document.getElementById('kpi-avg-attendance').textContent = '0%';
                document.getElementById('kpi-punctuality').textContent = '0%';
            }
        }
        
        // ===== REPORTES ESPEC√çFICOS =====
        
        // 1. Generar Reporte General de Asistencias
        async function generateGeneralReport() {
            const container = document.getElementById('reports-content');
            container.innerHTML = '<div class="loading">Generando reporte general de asistencias...</div>';
            
            try {
                const filters = window.currentReportFilters || {};
                const reportData = await getCompleteAttendanceData(filters);
                
                let html = `
                    <div style="background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                            <h2 style="margin: 0 0 15px 0; color: #28a745; font-size: 1.5rem;">üìã Reporte General de Asistencias</h2>
                            <div class="button-group" style="justify-content: flex-start;">
                                <button class="btn btn-success btn-sm" onclick="exportReport('general', 'excel')">üìä Excel</button>
                                <button class="btn btn-info btn-sm" onclick="exportReport('general', 'pdf')">üìÑ PDF</button>
                                <button class="btn btn-secondary btn-sm" onclick="loadReports()">‚Üê Volver</button>
                            </div>
                        </div>
                        
                        <!-- Filtros Aplicados -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
                            <h4 style="margin: 0 0 10px 0;">üîç Filtros Aplicados:</h4>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.9rem;">
                                <span><strong>Equipo:</strong> ${filters.teamId ? 'Equipo espec√≠fico' : 'Todos los equipos'}</span>
                                <span><strong>Per√≠odo:</strong> ${filters.dateFrom || 'Sin l√≠mite'} - ${filters.dateTo || 'Hasta hoy'}</span>
                                <span><strong>Total Jugadores:</strong> ${reportData.totalPlayers}</span>
                                <span><strong>Total Entrenamientos:</strong> ${reportData.totalTrainings}</span>
                            </div>
                        </div>
                        
                        <!-- Resumen Estad√≠stico -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${reportData.stats.avgAttendance}%</div>
                                <div>Asistencia Promedio</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffc107, #fd7e14); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${reportData.stats.punctualityRate}%</div>
                                <div>Puntualidad Promedio</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #dc3545, #e74a3b); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${reportData.stats.totalAbsences}</div>
                                <div>Total Ausencias</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${reportData.stats.bestAttendanceRate}%</div>
                                <div>Mejor Asistencia</div>
                            </div>
                        </div>
                        
                        <!-- Ranking de Asistencia -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #2c5aa0; margin-bottom: 20px;">üèÜ Ranking de Asistencia</h3>
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                            <th style="padding: 10px 8px; font-size: 0.85rem;">#</th>
                                            <th style="padding: 10px 8px; font-size: 0.85rem;">Jugador</th>
                                            <th style="padding: 10px 8px; font-size: 0.85rem;">Equipo</th>
                                            <th style="padding: 10px 8px; font-size: 0.85rem; text-align: center;">‚úÖ</th>
                                            <th style="padding: 10px 8px; font-size: 0.85rem; text-align: center;">‚ö†Ô∏è</th>
                                            <th style="padding: 10px 8px; font-size: 0.85rem; text-align: center;">‚ùå</th>
                                            <th style="padding: 10px 8px; font-size: 0.85rem; text-align: center;">üìä</th>
                                            <th style="padding: 10px 8px; font-size: 0.85rem; text-align: center;">‚è∞</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                reportData.playersRanked.forEach((player, index) => {
                    const position = index + 1;
                    const total = player.presente + player.tarde + player.ausente;
                    const attendanceRate = total > 0 ? Math.round(((player.presente + player.tarde) / total) * 100) : 0;
                    const punctualityRate = (player.presente + player.tarde) > 0 ? Math.round((player.presente / (player.presente + player.tarde)) * 100) : 0;
                    
                    let positionIcon = '';
                    if (position === 1) positionIcon = 'ü•á';
                    else if (position === 2) positionIcon = 'ü•à';
                    else if (position === 3) positionIcon = 'ü•â';
                    
                    let attendanceColor = attendanceRate >= 80 ? '#28a745' : attendanceRate >= 60 ? '#ffc107' : '#dc3545';
                    let punctualityColor = punctualityRate >= 90 ? '#28a745' : punctualityRate >= 70 ? '#ffc107' : '#dc3545';
                    
                    html += `
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 8px 6px; font-weight: bold; color: #2c5aa0; font-size: 0.8rem;">${positionIcon} ${position}</td>
                            <td style="padding: 8px 6px; font-size: 0.8rem;">
                                <div style="font-weight: bold;">${player.name}</div>
                                ${player.nickname ? `<small style="color: #666; font-size: 0.7rem;">"${player.nickname}"</small>` : ''}
                                ${player.jersey_number ? `<span style="color: #007bff; font-size: 0.7rem;"> #${player.jersey_number}</span>` : ''}
                            </td>
                            <td style="padding: 8px 6px; text-align: center; font-size: 0.75rem;">
                                <span style="background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem;">
                                    ${player.teamName}
                                </span>
                            </td>
                            <td style="padding: 8px 6px; text-align: center; color: #28a745; font-weight: bold; font-size: 0.8rem;">${player.presente}</td>
                            <td style="padding: 8px 6px; text-align: center; color: #ffc107; font-weight: bold; font-size: 0.8rem;">${player.tarde}</td>
                            <td style="padding: 8px 6px; text-align: center; color: #dc3545; font-weight: bold; font-size: 0.8rem;">${player.ausente}</td>
                            <td style="padding: 8px 6px; text-align: center;">
                                <span style="background: ${attendanceColor}; color: white; padding: 3px 6px; border-radius: 4px; font-weight: bold; font-size: 0.75rem;">
                                    ${attendanceRate}%
                                </span>
                            </td>
                            <td style="padding: 8px 6px; text-align: center;">
                                <span style="background: ${punctualityColor}; color: white; padding: 3px 6px; border-radius: 4px; font-weight: bold; font-size: 0.75rem;">
                                    ${punctualityRate}%
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico de Barras de Asistencia (Simulado) -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #2c5aa0; margin-bottom: 20px;">üìä Gr√°fico de Asistencia (Top 10)</h3>
                            <div class="ranking-chart-mobile" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                `;
                
                reportData.playersRanked.slice(0, 10).forEach((player, index) => {
                    const total = player.presente + player.tarde + player.ausente;
                    const attendanceRate = total > 0 ? Math.round(((player.presente + player.tarde) / total) * 100) : 0;
                    const barWidth = Math.max(attendanceRate, 5); // Minimum 5% for visibility
                    
                    html += `
                        <div class="bar-container" style="display: flex; align-items: center; margin-bottom: 10px;">
                            <div class="player-name" style="width: 150px; font-size: 0.9em; font-weight: bold; color: #333; flex-shrink: 0;">${player.name}</div>
                            <div class="progress-bar" style="flex: 1; background: #e9ecef; border-radius: 4px; margin: 0 10px; height: 25px; position: relative;">
                                <div style="background: ${attendanceRate >= 80 ? '#28a745' : attendanceRate >= 60 ? '#ffc107' : '#dc3545'}; 
                                           height: 100%; width: ${barWidth}%; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    <span class="percentage-text" style="font-size: 0.85em;">${attendanceRate}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error generating general report:', error);
                container.innerHTML = `<div class="message error">Error generando reporte general: ${error.message}</div>`;
            }
        }
        
        // Load reports for selected team
        async function loadReportsForTeam() {
            const select = document.getElementById('reports-team-select');
            const container = document.getElementById('reports-content');
            
            if (!select.value) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üìä</div>
                        <h3>Selecciona un equipo para ver los reportes</h3>
                        <p>Podr√°s ver estad√≠sticas de asistencia, rendimiento y generar reportes exportables</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div class="loading">Cargando estad√≠sticas del equipo...</div>';
            
            try {
                // Get team data
                const teamResponse = await fetch(`/api/teams`, {
                    headers: getAuthHeaders()
                });
                const teamData = await teamResponse.json();
                const team = teamData.success ? teamData.teams.find(t => t.id === select.value) : null;
                
                // Get players for the team
                const playersResponse = await fetch(`/api/players?team_id=${select.value}`, {
                    headers: getAuthHeaders()
                });
                const playersData = await playersResponse.json();
                
                // Get trainings for the team
                const trainingsResponse = await fetch(`/api/trainings?team_id=${select.value}`, {
                    headers: getAuthHeaders()
                });
                const trainingsData = await trainingsResponse.json();
                
                if (playersData.success && trainingsData.success) {
                    container.innerHTML = await generateReportsDashboard(
                        team, 
                        playersData.players, 
                        trainingsData.trainings,
                        select.value
                    );
                } else {
                    container.innerHTML = `<div class="message error">Error cargando datos del equipo</div>`;
                }
                
            } catch (error) {
                console.error('Error loading reports data:', error);
                container.innerHTML = `<div class="message error">Error cargando reportes: ${error.message}</div>`;
            }
        }
        
        // Generate reports dashboard HTML
        async function generateReportsDashboard(team, players, trainings, teamId) {
            // Get attendance statistics
            const attendanceStats = await getAttendanceStatistics(teamId, trainings, players);
            
            let html = `
                <div style="display: grid; gap: 20px;">
                    <!-- Team Summary Card -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.5em;">üìä Resumen de ${team ? team.name : 'Equipo'}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${players.length}</div>
                                <div>Jugadores</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${trainings.length}</div>
                                <div>Entrenamientos</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${attendanceStats.averageAttendance}%</div>
                                <div>Asistencia Promedio</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${attendanceStats.totalSessions}</div>
                                <div>Sesiones Registradas</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reports Actions -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #2c5aa0;">üìã Reporte de Asistencias</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Estad√≠sticas detalladas de asistencia por jugador y entrenamiento</p>
                            <button class="btn btn-primary" onclick="generateAttendanceReport('${teamId}')" style="width: 100%;">
                                üìä Ver Reporte Detallado
                            </button>
                        </div>
                        
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #2c5aa0;">üìà Estad√≠sticas por Jugador</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Rendimiento individual y comparativas entre jugadores</p>
                            <button class="btn btn-success" onclick="generatePlayerStats('${teamId}')" style="width: 100%;">
                                üë• Ver Estad√≠sticas
                            </button>
                        </div>
                        
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #2c5aa0;">üìÖ Reporte Temporal</h4>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Tendencias de asistencia a lo largo del tiempo</p>
                            <button class="btn btn-info" onclick="generateTemporalReport('${teamId}')" style="width: 100%;">
                                ‚è±Ô∏è Ver Tendencias
                            </button>
                        </div>
                    </div>
            `;
            
            // Add player attendance quick view
            if (attendanceStats.playerStats.length > 0) {
                html += `
                    <!-- Quick Player Stats -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 20px 0; color: #2c5aa0;">üèÉ‚Äç‚ôÄÔ∏è Vista R√°pida - Asistencia por Jugador</h4>
                        <div style="display: grid; gap: 10px; max-height: 300px; overflow-y: auto;">
                `;
                
                attendanceStats.playerStats.forEach(player => {
                    const percentage = player.totalTrainings > 0 ? Math.round((player.presents / player.totalTrainings) * 100) : 0;
                    let statusColor = percentage >= 80 ? '#4CAF50' : percentage >= 60 ? '#FF9800' : '#f44336';
                    
                    html += `
                        <div style="display: flex; justify-content: between-center; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 6px;">
                            <div style="flex: 1;">
                                <strong>${player.name}</strong>
                                ${player.nickname ? `<span style="color: #666;">(${player.nickname})</span>` : ''}
                                ${player.jersey_number ? `<span style="color: #666;"> - #${player.jersey_number}</span>` : ''}
                            </div>
                            <div style="display: flex; gap: 15px; align-items: center; font-size: 0.9em;">
                                <span>‚úÖ ${player.presents}</span>
                                <span>‚è∞ ${player.lates}</span>
                                <span>‚ùå ${player.absents}</span>
                                <div style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; margin-left: 10px;">
                                    ${percentage}%
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            html += '</div>';
            return html;
        }
        
        // Get attendance statistics for a team
        async function getAttendanceStatistics(teamId, trainings, players) {
            const playerStats = [];
            let totalSessions = 0;
            let totalAttendances = 0;
            
            // Initialize player stats
            players.forEach(player => {
                playerStats.push({
                    id: player.id,
                    name: player.name,
                    nickname: player.nickname,
                    jersey_number: player.jersey_number,
                    presents: 0,
                    lates: 0,
                    absents: 0,
                    totalTrainings: 0
                });
            });
            
            // Get attendance data for each training
            for (const training of trainings) {
                try {
                    const response = await fetch(`/api/training-attendances?training_session_id=${training.id}`, {
                        headers: getAuthHeaders()
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.attendances.length > 0) {
                            totalSessions++;
                            
                            // Update player stats based on this training
                            data.attendances.forEach(attendance => {
                                const playerStat = playerStats.find(p => p.id == attendance.player_id);
                                if (playerStat) {
                                    playerStat.totalTrainings++;
                                    
                                    switch (attendance.status) {
                                        case 'presente':
                                            playerStat.presents++;
                                            totalAttendances++;
                                            break;
                                        case 'tarde':
                                            playerStat.lates++;
                                            totalAttendances++;
                                            break;
                                        case 'ausente':
                                            playerStat.absents++;
                                            break;
                                    }
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error fetching attendance for training:', training.id, error);
                }
            }
            
            // Calculate overall statistics
            const averageAttendance = totalSessions > 0 && players.length > 0 
                ? Math.round((totalAttendances / (totalSessions * players.length)) * 100)
                : 0;
            
            return {
                playerStats,
                totalSessions,
                averageAttendance,
                totalAttendances
            };
        }
        
        // Generate detailed attendance report
        async function generateAttendanceReport(teamId) {
            const container = document.getElementById('reports-content');
            container.innerHTML = '<div class="loading">Generando reporte detallado...</div>';
            
            try {
                // Get detailed data
                const playersResponse = await fetch(`/api/players?team_id=${teamId}`, {
                    headers: getAuthHeaders()
                });
                const playersData = await playersResponse.json();
                
                const trainingsResponse = await fetch(`/api/trainings?team_id=${teamId}`, {
                    headers: getAuthHeaders()
                });
                const trainingsData = await trainingsResponse.json();
                
                if (!playersData.success || !trainingsData.success) {
                    throw new Error('Error cargando datos del equipo');
                }
                
                const attendanceStats = await getAttendanceStatistics(teamId, trainingsData.trainings, playersData.players);
                
                let html = `
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: between-center; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                            <h2 style="margin: 0; color: #2c5aa0;">üìä Reporte Detallado de Asistencias</h2>
                            <button class="btn btn-secondary" onclick="loadReportsForTeam()">‚Üê Volver a Reportes</button>
                        </div>
                        
                        <!-- Summary Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #28a745;">${attendanceStats.totalSessions}</div>
                                <div>Entrenamientos</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #007bff;">${playersData.players.length}</div>
                                <div>Jugadores</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #fd7e14;">${attendanceStats.averageAttendance}%</div>
                                <div>Asistencia Promedio</div>
                            </div>
                        </div>
                        
                        <!-- Player Details Table -->
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                        <th style="border-right: 1px solid #dee2e6;">Jugador</th>
                                        <th style="text-align: center; border-right: 1px solid #dee2e6;">‚úÖ Presente</th>
                                        <th style="text-align: center; border-right: 1px solid #dee2e6;">‚è∞ Tarde</th>
                                        <th style="text-align: center; border-right: 1px solid #dee2e6;">‚ùå Ausente</th>
                                        <th style="text-align: center; border-right: 1px solid #dee2e6;">Total</th>
                                        <th style="text-align: center;">% Asistencia</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                attendanceStats.playerStats.forEach((player, index) => {
                    const total = player.presents + player.lates + player.absents;
                    const percentage = total > 0 ? Math.round(((player.presents + player.lates) / total) * 100) : 0;
                    const rowBg = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    let statusColor = percentage >= 80 ? '#28a745' : percentage >= 60 ? '#ffc107' : '#dc3545';
                    
                    html += `
                        <tr style="background: ${rowBg}; border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px; border-right: 1px solid #dee2e6;">
                                <strong>${player.name}</strong>
                                ${player.nickname ? `<br><small style="color: #666;">"${player.nickname}"</small>` : ''}
                                ${player.jersey_number ? `<span style="color: #007bff;"> #${player.jersey_number}</span>` : ''}
                            </td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; color: #28a745; font-weight: bold;">${player.presents}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; color: #ffc107; font-weight: bold;">${player.lates}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; color: #dc3545; font-weight: bold;">${player.absents}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; font-weight: bold;">${total}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;">
                                    ${percentage}%
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Export Actions -->
                        <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; justify-content: center;">
                            <button class="btn btn-success" onclick="exportAttendanceReport('${teamId}', 'csv')">
                                üìä Exportar CSV
                            </button>
                            <button class="btn btn-info" onclick="exportAttendanceReport('${teamId}', 'print')">
                                üñ®Ô∏è Imprimir Reporte
                            </button>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error generating attendance report:', error);
                container.innerHTML = `<div class="message error">Error generando reporte: ${error.message}</div>`;
            }
        }
        
        // Export attendance report
        function exportAttendanceReport(teamId, format) {
            if (format === 'print') {
                window.print();
            } else if (format === 'csv') {
                showMessage('Exportaci√≥n CSV pr√≥ximamente disponible', 'info');
                // TODO: Implement CSV export
            }
        }
        
        // Generate player statistics (placeholder)
        function generatePlayerStats(teamId) {
            showMessage('Estad√≠sticas por jugador pr√≥ximamente disponible', 'info');
            // TODO: Implement detailed player statistics
        }
        
        // Generate temporal report (placeholder)
        function generateTemporalReport() {
            showMessage('Reporte temporal pr√≥ximamente disponible', 'info');
            // TODO: Implement temporal trending reports
        }
        
        // Obtener datos completos de asistencia con filtros
        async function getCompleteAttendanceData(filters) {
            let allPlayers = [];
            let totalTrainings = 0;
            let teamsToProcess = [];
            
            // Determinar equipos a procesar
            if (filters.teamId) {
                // Get specific team name
                const teamsResponse = await fetch('/api/teams', {
                    headers: getAuthHeaders()
                });
                const teamsData = await teamsResponse.json();
                if (teamsData.success) {
                    const team = teamsData.teams.find(t => t.id === filters.teamId);
                    teamsToProcess = [{ id: filters.teamId, name: team ? team.name : 'Equipo' }];
                }
            } else {
                const teamsResponse = await fetch('/api/teams', {
                    headers: getAuthHeaders()
                });
                const teamsData = await teamsResponse.json();
                if (teamsData.success) {
                    teamsToProcess = teamsData.teams.map(t => ({ id: t.id, name: t.name }));
                } else {
                    teamsToProcess = [];
                }
            }
            
            // Procesar cada equipo
            for (const team of teamsToProcess) {
                const teamId = team.id;
                const teamName = team.name;
                
                // Obtener jugadores del equipo
                const playersResponse = await fetch(`/api/players?team_id=${teamId}`, {
                    headers: getAuthHeaders()
                });
                const playersData = await playersResponse.json();
                
                if (playersData.success) {
                    // Obtener entrenamientos del equipo
                    const trainingsResponse = await fetch(`/api/trainings?team_id=${teamId}`, {
                        headers: getAuthHeaders()
                    });
                    const trainingsData = await trainingsResponse.json();
                    
                    if (trainingsData.success) {
                        // Filtrar entrenamientos por fecha
                        let filteredTrainings = trainingsData.trainings;
                        if (filters.dateFrom || filters.dateTo) {
                            filteredTrainings = trainingsData.trainings.filter(training => {
                                const trainingDate = new Date(training.training_date);
                                const isAfterFrom = !filters.dateFrom || trainingDate >= new Date(filters.dateFrom);
                                const isBeforeTo = !filters.dateTo || trainingDate <= new Date(filters.dateTo);
                                return isAfterFrom && isBeforeTo;
                            });
                        }
                        
                        totalTrainings = Math.max(totalTrainings, filteredTrainings.length);
                        
                        // Procesar cada jugador
                        for (const player of playersData.players) {
                            const playerStats = {
                                id: player.id,
                                name: player.name,
                                nickname: player.nickname,
                                jersey_number: player.jersey_number,
                                teamId: teamId,
                                teamName: teamName,
                                presente: 0,
                                tarde: 0,
                                ausente: 0
                            };
                            
                            // Obtener asistencias para cada entrenamiento
                            for (const training of filteredTrainings) {
                                try {
                                    const attendanceResponse = await fetch(`/api/training-attendances?training_session_id=${training.id}`, {
                                        headers: getAuthHeaders()
                                    });
                                    
                                    if (attendanceResponse.ok) {
                                        const attendanceData = await attendanceResponse.json();
                                        if (attendanceData.success) {
                                            const playerAttendance = attendanceData.attendances.find(att => att.player_id == player.id);
                                            if (playerAttendance) {
                                                switch (playerAttendance.status) {
                                                    case 'presente':
                                                        playerStats.presente++;
                                                        break;
                                                    case 'tarde':
                                                        playerStats.tarde++;
                                                        break;
                                                    case 'ausente':
                                                        playerStats.ausente++;
                                                        break;
                                                }
                                            } else {
                                                playerStats.ausente++; // Si no hay registro, asume ausente
                                            }
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error fetching attendance:', error);
                                }
                            }
                            
                            allPlayers.push(playerStats);
                        }
                    }
                }
            }
            
            // Calcular estad√≠sticas globales
            const totalPlayers = allPlayers.length;
            let totalAttendances = 0;
            let totalLates = 0;
            let totalAbsences = 0;
            let bestAttendanceRate = 0;
            
            allPlayers.forEach(player => {
                totalAttendances += (player.presente + player.tarde);
                totalLates += player.tarde;
                totalAbsences += player.ausente;
                
                const total = player.presente + player.tarde + player.ausente;
                const attendanceRate = total > 0 ? Math.round(((player.presente + player.tarde) / total) * 100) : 0;
                bestAttendanceRate = Math.max(bestAttendanceRate, attendanceRate);
            });
            
            const avgAttendance = totalPlayers > 0 && totalTrainings > 0 
                ? Math.round((totalAttendances / (totalTrainings * totalPlayers)) * 100)
                : 0;
            
            const punctualityRate = totalAttendances > 0 
                ? Math.round(((totalAttendances - totalLates) / totalAttendances) * 100)
                : 0;
            
            // Ordenar jugadores por porcentaje de asistencia
            const playersRanked = allPlayers.sort((a, b) => {
                const totalA = a.presente + a.tarde + a.ausente;
                const totalB = b.presente + b.tarde + b.ausente;
                const rateA = totalA > 0 ? ((a.presente + a.tarde) / totalA) * 100 : 0;
                const rateB = totalB > 0 ? ((b.presente + b.tarde) / totalB) * 100 : 0;
                return rateB - rateA; // Descendente
            });
            
            return {
                totalPlayers,
                totalTrainings,
                playersRanked,
                stats: {
                    avgAttendance,
                    punctualityRate,
                    totalAbsences,
                    bestAttendanceRate
                }
            };
        }
        
        // ===== OTROS REPORTES (PLACEHOLDERS) =====
        
        // 2. Reporte Comparativo por Equipo
        async function generateComparativeReport() {
            const container = document.getElementById('reports-content');
            container.innerHTML = '<div class="loading">Generando reporte comparativo...</div>';
            
            try {
                // Get all teams data
                const teamsResponse = await fetch('/api/teams', {
                    headers: getAuthHeaders()
                });
                const teamsData = await teamsResponse.json();
                
                if (!teamsData.success || !teamsData.teams || teamsData.teams.length === 0) {
                    container.innerHTML = `<div class="message warning">No se encontraron equipos para comparar</div>`;
                    return;
                }
                
                // Get comparative data for all teams
                const teamsStats = [];
                for (const team of teamsData.teams) {
                    try {
                        const [playersResponse, trainingsResponse] = await Promise.all([
                            fetch(`/api/players?team_id=${team.id}`, { headers: getAuthHeaders() }),
                            fetch(`/api/trainings?team_id=${team.id}`, { headers: getAuthHeaders() })
                        ]);
                        
                        const playersData = await playersResponse.json();
                        const trainingsData = await trainingsResponse.json();
                        
                        if (playersData.success && trainingsData.success) {
                            const attendanceStats = await getAttendanceStatistics(
                                team.id, 
                                trainingsData.trainings, 
                                playersData.players
                            );
                            
                            teamsStats.push({
                                ...team,
                                playersCount: playersData.players.length,
                                trainingsCount: trainingsData.trainings.length,
                                attendanceStats: attendanceStats,
                                category: team.category || 'Sin categor√≠a'
                            });
                        }
                    } catch (error) {
                        console.warn(`Error loading data for team ${team.name}:`, error);
                    }
                }
                
                if (teamsStats.length === 0) {
                    container.innerHTML = `<div class="message warning">No se pudieron cargar datos de equipos para comparar</div>`;
                    return;
                }
                
                // Sort teams by attendance percentage
                teamsStats.sort((a, b) => b.attendanceStats.averageAttendance - a.attendanceStats.averageAttendance);
                
                let html = `
                    <div style="background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                            <h2 style="margin: 0 0 15px 0; color: #17a2b8; font-size: 1.5rem;">üìä Reporte Comparativo por Equipos</h2>
                            <div class="button-group" style="justify-content: flex-start;">
                                <button class="btn btn-success btn-sm" onclick="exportComparativeReport('excel')">üìä Excel</button>
                                <button class="btn btn-info btn-sm" onclick="exportComparativeReport('pdf')">üìÑ PDF</button>
                                <button class="btn btn-secondary btn-sm" onclick="loadReports()">‚Üê Volver</button>
                            </div>
                        </div>
                        
                        <!-- Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2.5em; font-weight: bold;">${teamsStats.length}</div>
                                <div>Equipos Analizados</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #28a745, #1e7e34); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2.5em; font-weight: bold;">${teamsStats.reduce((sum, team) => sum + team.playersCount, 0)}</div>
                                <div>Total Jugadores</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2.5em; font-weight: bold;">${teamsStats.reduce((sum, team) => sum + team.trainingsCount, 0)}</div>
                                <div>Total Entrenamientos</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #6f42c1, #59359a); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2.5em; font-weight: bold;">${Math.round(teamsStats.reduce((sum, team) => sum + team.attendanceStats.averageAttendance, 0) / teamsStats.length)}%</div>
                                <div>Promedio General</div>
                            </div>
                        </div>
                        
                        <!-- Comparative Table -->
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr style="background: #17a2b8; color: white;">
                                        <th style="padding: 15px; text-align: left; position: sticky; top: 0; z-index: 10;">üèí Equipo</th>
                                        <th style="padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10;">üë• Jugadores</th>
                                        <th style="padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10;">üèÉ Entrenamientos</th>
                                        <th style="padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10;">‚úÖ Asistencias</th>
                                        <th style="padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10;">‚ö†Ô∏è Tardanzas</th>
                                        <th style="padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10;">‚ùå Faltas</th>
                                        <th style="padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10;">üìä % Asistencia</th>
                                        <th style="padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10;">üèÜ Ranking</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                // Generate table rows
                teamsStats.forEach((team, index) => {
                    const stats = team.attendanceStats;
                    const percentage = stats.averageAttendance;
                    let rankingBadge, rowBg;
                    
                    // Determine ranking badge and row background
                    if (index === 0) {
                        rankingBadge = `<span style="background: #ffd700; color: #333; padding: 5px 10px; border-radius: 15px; font-weight: bold;">ü•á 1¬∞</span>`;
                        rowBg = '#fff3cd';
                    } else if (index === 1) {
                        rankingBadge = `<span style="background: #c0c0c0; color: #333; padding: 5px 10px; border-radius: 15px; font-weight: bold;">ü•à 2¬∞</span>`;
                        rowBg = '#f8f9fa';
                    } else if (index === 2) {
                        rankingBadge = `<span style="background: #cd7f32; color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold;">ü•â 3¬∞</span>`;
                        rowBg = '#f8f9fa';
                    } else {
                        rankingBadge = `<span style="background: #6c757d; color: white; padding: 5px 10px; border-radius: 15px;">${index + 1}¬∞</span>`;
                        rowBg = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    }
                    
                    // Performance indicator
                    let performanceColor;
                    if (percentage >= 85) performanceColor = '#28a745';
                    else if (percentage >= 70) performanceColor = '#ffc107';
                    else if (percentage >= 50) performanceColor = '#fd7e14';
                    else performanceColor = '#dc3545';
                    
                    html += `
                        <tr style="background: ${rowBg}; border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px; border-right: 1px solid #dee2e6;">
                                <div style="font-weight: bold; color: #2c5aa0;">${team.name}</div>
                                <small style="color: #666;">${team.category}</small>
                            </td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; font-weight: bold;">${team.playersCount}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; font-weight: bold;">${team.trainingsCount}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; color: #28a745; font-weight: bold;">${stats.totalPresents || 0}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; color: #ffc107; font-weight: bold;">${stats.totalLates || 0}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6; color: #dc3545; font-weight: bold;">${stats.totalAbsents || 0}</td>
                            <td style="padding: 12px; text-align: center; border-right: 1px solid #dee2e6;">
                                <span style="background: ${performanceColor}; color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold;">
                                    ${percentage}%
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                ${rankingBadge}
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Analysis Section -->
                        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="margin: 0 0 15px 0; color: #495057;">üìà An√°lisis Comparativo</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div>
                                    <h5 style="color: #28a745; margin: 0 0 10px 0;">üèÜ Mejor Equipo</h5>
                                    <p style="margin: 0; font-weight: bold;">${teamsStats[0].name}</p>
                                    <small style="color: #666;">${teamsStats[0].attendanceStats.averageAttendance}% de asistencia</small>
                                </div>
                                <div>
                                    <h5 style="color: #17a2b8; margin: 0 0 10px 0;">üë• Equipo M√°s Grande</h5>
                                    <p style="margin: 0; font-weight: bold;">${teamsStats.reduce((max, team) => team.playersCount > max.playersCount ? team : max).name}</p>
                                    <small style="color: #666;">${teamsStats.reduce((max, team) => team.playersCount > max.playersCount ? team : max).playersCount} jugadores</small>
                                </div>
                                <div>
                                    <h5 style="color: #ffc107; margin: 0 0 10px 0;">üèÉ M√°s Entrenamientos</h5>
                                    <p style="margin: 0; font-weight: bold;">${teamsStats.reduce((max, team) => team.trainingsCount > max.trainingsCount ? team : max).name}</p>
                                    <small style="color: #666;">${teamsStats.reduce((max, team) => team.trainingsCount > max.trainingsCount ? team : max).trainingsCount} sesiones</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Export Actions -->
                        <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;">
                            <div class="button-group" style="justify-content: center;">
                                <button class="btn btn-success" onclick="exportComparativeReport('excel')">üìä Exportar Excel</button>
                                <button class="btn btn-info" onclick="exportComparativeReport('pdf')">üìÑ Exportar PDF</button>
                                <button class="btn btn-warning" onclick="printComparativeReport()">üñ®Ô∏è Imprimir</button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error generating comparative report:', error);
                container.innerHTML = `<div class="message error">Error generando reporte comparativo: ${error.message}</div>`;
            }
        }
        
        // 3. Reporte de Tendencias
        function generateTrendsReport() {
            showMessage('Reporte de tendencias y evoluci√≥n pr√≥ximamente disponible', 'info');
            // TODO: Implement trends report with line charts
        }
        
        // 4. Reporte de Justificaciones
        function generateJustificationsReport() {
            showMessage('Reporte de justificaciones pr√≥ximamente disponible', 'info');
            // TODO: Implement justifications report
        }
        
        // 5. Reporte de Puntualidad
        function generatePunctualityReport() {
            showMessage('Reporte de puntualidad pr√≥ximamente disponible', 'info');
            // TODO: Implement punctuality report
        }
        
        // 7. Reporte Individual de Jugador
        function generateIndividualReport() {
            showMessage('Ficha individual de jugador pr√≥ximamente disponible', 'info');
            // TODO: Implement individual player report
        }
        
        // Funci√≥n de exportaci√≥n
        function exportReport(reportType, format) {
            if (format === 'pdf') {
                window.print(); // Simple print for now
                showMessage('Usa la funci√≥n de imprimir del navegador para generar PDF', 'info');
            } else if (format === 'excel') {
                showMessage('Exportaci√≥n a Excel pr√≥ximamente disponible', 'info');
                // TODO: Implement Excel export
            }
        }
        
        // ==========================================
        // END REPORTS FUNCTIONS
        // ==========================================
        
        // Debug function to check token status
        async function checkTokenStatus() {
            const token = localStorage.getItem('hockey_token');
            const user = localStorage.getItem('hockey_user');
            
            console.log('=== TOKEN & USER DEBUG ===');
            console.log('Token exists:', !!token);
            console.log('Token length:', token ? token.length : 0);
            console.log('User data:', user);
            
            if (token) {
                try {
                    const response = await fetch('/api/profile', {
                        headers: getAuthHeaders()
                    });
                    
                    console.log('Profile response status:', response.status);
                    const data = await response.json();
                    console.log('Profile response data:', data);
                    
                    if (response.status === 200 && data.success) {
                        console.log('=== USER LIMITS ===');
                        console.log('Max teams allowed:', data.data.maxTeams);
                        console.log('Plan:', data.data.plan);
                        console.log('Role:', data.data.role);
                        
                        const maxTeams = data.data.maxTeams || 0;
                        let limitMessage;
                        if (maxTeams === 0) {
                            limitMessage = 'No puede crear equipos';
                        } else {
                            limitMessage = `Max equipos: ${maxTeams}`;
                        }
                        
                        showMessage(`Token v√°lido. Usuario: ${data.data.firstName} ${data.data.lastName}. ${limitMessage}`, 'success');
                        
                        // Tambi√©n obtener equipos actuales
                        const teamsResponse = await fetch('/api/teams', {
                            headers: getAuthHeaders()
                        });
                        const teamsData = await teamsResponse.json();
                        
                        if (teamsData.success) {
                            console.log('Current teams:', teamsData.teams.length);
                            console.log('Can create more teams:', maxTeams > 0 && teamsData.teams.length < maxTeams);
                        }
                    } else {
                        showMessage(`Token inv√°lido. Status: ${response.status}`, 'error');
                    }
                } catch (error) {
                    console.error('Error checking token:', error);
                    showMessage(`Error verificando token: ${error.message}`, 'error');
                }
            } else {
                showMessage('No hay token guardado', 'warning');
            }
        }
        
        // Export functions for comparative report
        function exportComparativeReport(format) {
            if (format === 'excel') {
                showMessage('Exportaci√≥n a Excel pr√≥ximamente disponible', 'info');
            } else if (format === 'pdf') {
                showMessage('Exportaci√≥n a PDF pr√≥ximamente disponible', 'info');
            }
        }
        
        function printComparativeReport() {
            window.print();
        }
        
        // Initialize dashboard on page load
        checkCoachAccess();
    </script>
</body>
</html>
